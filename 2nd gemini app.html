<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Tutor - Class & Family Edition</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI Tutor">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1998/1998614.png">
    
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <style>
        [x-cloak] { display: none !important; }

        body {
            font-family: 'Quicksand', sans-serif;
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            display: block;   
            transition: background 0.5s ease;
            overscroll-behavior-y: none;
        }

        @media (min-width: 640px) {
            .no-scroll-desktop {
                overflow: hidden !important;
                height: 100vh;
                position: fixed;
                width: 100%;
            }
        }
        
        html { scroll-behavior: smooth; }
        .font-kids { font-family: 'Fredoka One', cursive; }
        
        .chat-bubble {
            position: relative;
            background: white;
            border-radius: 40px;
            box-shadow: 0 30px 60px -12px rgba(0,0,0,0.15);
            border: 6px solid white;
        }

        /* --- ANIMATIONS --- */
        .char-float { animation: floating 5s ease-in-out infinite; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1)); z-index: 10; }
        @keyframes floating { 0%, 100% { transform: translateY(0px) rotate(-2deg); } 50% { transform: translateY(-30px) rotate(3deg); } }

        .wiggle-speak { animation: wiggle 0.4s ease-in-out infinite; }
        @keyframes wiggle { 0%, 100% { transform: scale(1.1) rotate(0deg); } 25% { transform: scale(1.1) rotate(3deg); } 75% { transform: scale(1.1) rotate(-3deg); } }

        .effect-glow { filter: drop-shadow(0 0 40px gold) drop-shadow(0 0 10px orange); animation: pulse-glow 2s infinite; }
        @keyframes pulse-glow { 0%, 100% { filter: drop-shadow(0 0 40px gold) drop-shadow(0 0 10px orange); } 50% { filter: drop-shadow(0 0 60px #fff700) drop-shadow(0 0 20px #ff9100); } }

        .sparkle-particle { position: absolute; animation: twinkle 2s ease-in-out infinite; }
        @keyframes twinkle { 0%, 100% { transform: scale(0) rotate(0deg); opacity: 0; } 50% { transform: scale(1.2) rotate(180deg); opacity: 1; } }

        .firefly-particle { position: absolute; width: 10px; height: 10px; background: #bef264; border-radius: 50%; box-shadow: 0 0 10px #bef264, 0 0 20px #bef264; animation: fly-around 4s ease-in-out infinite; }
        @keyframes fly-around { 0% { transform: translate(0, 0) scale(1); opacity: 0.8; } 33% { transform: translate(30px, -30px) scale(1.2); } 66% { transform: translate(-20px, 20px) scale(0.8); } 100% { transform: translate(0, 0) scale(1); opacity: 0.8; } }

        .orbit-container { position: absolute; inset: -40px; animation: spin-orbit 8s linear infinite; }
        .star-item { position: absolute; animation: counter-spin 8s linear infinite; }
        @keyframes spin-orbit { 100% { transform: rotate(360deg); } }
        @keyframes counter-spin { 100% { transform: rotate(-360deg); } }

        .dust-particle { position: absolute; bottom: 0; animation: float-up 3s linear infinite; }
        @keyframes float-up { 0% { transform: translateY(20px) scale(0.5); opacity: 0; } 20% { opacity: 1; } 100% { transform: translateY(-150px) scale(1.5) rotate(45deg); opacity: 0; } }

        /* --- UI ELEMENTS --- */
        .btn-grad { transition: 0.5s; background-size: 200% auto; }
        .btn-grad:hover { background-position: right center; }
        
        .char-btn { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; }
        .char-btn:hover { transform: scale(1.2); }
        .char-btn.active { transform: scale(1.3); border-color: white; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
        
        .char-locked { filter: grayscale(100%); opacity: 0.7; }
        .lock-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; }

        .mic-active { animation: pulse-red 1.5s infinite; color: #ef4444 !important; }
        @keyframes pulse-red { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }

        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }

        .premium-glow { animation: glow-gold 2s infinite; }
        @keyframes glow-gold { 0% { box-shadow: 0 0 5px #ffd700; } 50% { box-shadow: 0 0 20px #ffd700, 0 0 10px #ffea00; } 100% { box-shadow: 0 0 5px #ffd700; } }

        .gift-bounce { animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }

        .safe-badge { background: #10b981; color: white; padding: 4px 10px; border-radius: 99px; font-size: 8px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 4px; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); width: fit-content; }

        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #3b82f6; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 640px) {
            .daily-reward-btn { padding: 0.5rem !important; width: 52px; height: 52px; }
            .daily-reward-btn span.gift-bounce { font-size: 1.25rem !important; }
            .daily-reward-btn span.text-pink-500 { font-size: 7px !important; }
            .safe-badge { font-size: 7px; padding: 2px 8px; }
        }

        @media print {
            body * { visibility: hidden; }
            
            /* Logic for printing art only */
            #printable-art-container, #printable-art-container * { visibility: visible; }
            #printable-art-container { position: fixed; left: 0; top: 0; width: 100%; height: 100%; object-fit: contain; z-index: 9999; }
            
            /* Logic for printing worksheets */
            #printable-worksheet, #printable-worksheet * { visibility: visible; }
            #printable-worksheet { position: fixed; left: 0; top: 0; width: 100%; height: 100%; z-index: 9999; background: white; padding: 20px; display: block !important; }

            .fixed, .absolute, .bg-black { background: none !important; box-shadow: none !important; }
        }
    </style>
</head>
<body x-data="aiTutor()" 
      :style="'background: ' + currentChar.bg"
      :class="!isLoggedIn ? 'no-scroll-desktop' : ''">

    <div x-show="isLoading" class="fixed inset-0 z-[200] bg-white/80 flex items-center justify-center backdrop-blur-sm" x-transition>
        <div class="flex flex-col items-center">
            <div class="spinner mb-4"></div>
            <p class="font-kids text-blue-500">Syncing magic...</p>
        </div>
    </div>

    <div x-show="!isLoggedIn" class="fixed inset-0 z-[100] bg-white sm:bg-gradient-to-br sm:from-blue-400 sm:to-purple-600 overflow-y-auto overflow-x-hidden sm:overflow-hidden sm:flex sm:items-center sm:justify-center transition-all duration-700">
        <div class="min-h-full w-full p-0 sm:p-4 block sm:flex sm:items-center sm:justify-center">
            <div class="bg-white m-0 w-full min-w-full sm:min-w-0 min-h-screen sm:min-h-0 sm:rounded-[2rem] p-6 sm:p-12 sm:max-w-md shadow-2xl text-center relative overflow-hidden animate__animated animate__zoomIn sm:my-8 sm:border-8 border-white/20">
                
                <div class="absolute top-0 left-0 w-32 h-32 bg-yellow-300 rounded-full blur-3xl opacity-50 -translate-x-1/2 -translate-y-1/2"></div>
                <div class="absolute bottom-0 right-0 w-32 h-32 bg-pink-300 rounded-full blur-3xl opacity-50 translate-x-1/2 translate-y-1/2"></div>

                <div class="relative z-10">
                    <div class="text-6xl mb-4 animate__animated animate__bounceIn delay-500">üéì</div>
                    <h1 class="text-4xl font-kids text-slate-800 mb-2">AI Tutor</h1>
                    <p class="text-slate-500 font-bold mb-8">Setup & Login</p>

                    <div x-show="!hasAccount" class="space-y-4 text-left">
                        
                        <div class="flex p-1 bg-slate-100 rounded-xl mb-4">
                            <button @click="signupType = 'parent'" :class="signupType === 'parent' ? 'bg-white shadow-md text-blue-600' : 'text-slate-400'" class="flex-1 py-2 rounded-lg font-bold text-xs uppercase tracking-wide transition-all">Parent</button>
                            <button @click="signupType = 'teacher'" :class="signupType === 'teacher' ? 'bg-white shadow-md text-purple-600' : 'text-slate-400'" class="flex-1 py-2 rounded-lg font-bold text-xs uppercase tracking-wide transition-all">Teacher</button>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1 ml-2" x-text="signupType === 'teacher' ? 'Teacher Full Name' : 'Parent Full Name'"></label>
                            <input type="text" x-model="loginForm.name" placeholder="Jane Doe" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl focus:border-blue-500 focus:bg-white outline-none font-bold text-slate-700 transition-all text-base">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1 ml-2">Email Address</label>
                            <input type="email" x-model="loginForm.email" placeholder="email@example.com" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl focus:border-blue-500 focus:bg-white outline-none font-bold text-slate-700 transition-all text-base">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1 ml-2">Create Secret PIN (4 Digits)</label>
                            <input type="tel" maxlength="4" x-model="loginForm.pin" placeholder="****" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl focus:border-blue-500 focus:bg-white outline-none font-bold text-slate-700 text-center text-2xl tracking-[0.5em] transition-all">
                            <p class="text-[10px] text-slate-400 mt-1 ml-2">Use this PIN to access Settings later.</p>
                        </div>
                        
                        <div class="mt-4 p-4 bg-slate-50 rounded-2xl border-2 border-slate-100">
                            <label class="flex items-start gap-3 cursor-pointer">
                                <input type="checkbox" x-model="legalAccepted" class="mt-1 w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="text-[10px] font-bold text-slate-500 leading-tight uppercase">
                                    I confirm I am an adult and agree to the 
                                    <a href="#" @click.prevent="showLegalDoc = 'privacy'" class="text-blue-500 underline">Privacy Policy</a> & 
                                    <a href="#" @click.prevent="showLegalDoc = 'terms'" class="text-blue-500 underline">Terms</a>. 
                                    I consent to kid-safe AI processing.
                                </span>
                            </label>
                        </div>

                        <button @click="handleSignup" :disabled="!legalAccepted" class="w-full py-4 bg-blue-500 hover:bg-blue-600 text-white rounded-2xl font-kids text-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all mt-4 disabled:opacity-50 disabled:grayscale">
                            <span x-text="signupType === 'teacher' ? 'Create Classroom üè´' : 'Start Learning! üöÄ'"></span>
                        </button>
                        <div class="flex items-center justify-center gap-2 mt-3 opacity-80">
                             <i class="fas fa-shield-alt text-green-500"></i>
                             <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">No data sold. 100% Private.</p>
                        </div>
                        
                        <p class="text-center mt-2 text-xs font-bold text-gray-400 cursor-pointer hover:text-blue-500" @click="hasAccount = true">Already have an account? Login</p>
                    </div>

                    <div x-show="hasAccount" class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-2xl border-2 border-blue-100">
                            <p class="text-sm text-blue-400 font-bold uppercase tracking-wide">Welcome Back</p>
                            <input type="email" x-model="loginForm.email" placeholder="Enter email" class="w-full mt-2 p-2 bg-white border border-blue-200 rounded-xl focus:outline-none text-center font-bold text-slate-700 text-base">
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Enter Your 4-Digit PIN</label>
                            <input type="password" maxlength="4" x-model="loginForm.pin" @keyup.enter="handleLogin" placeholder="****" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl focus:border-blue-500 outline-none font-bold text-slate-700 text-center text-3xl tracking-[0.5em]">
                        </div>

                        <button @click="handleLogin" class="w-full py-4 bg-green-500 hover:bg-green-600 text-white rounded-2xl font-kids text-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all">
                            Unlock App üîì
                        </button>
                        
                        <button @click="hasAccount = false" class="text-xs text-blue-400 hover:text-blue-600 font-bold uppercase tracking-widest mt-4">Create New Account</button>
                    </div>

                    <div class="mt-8 p-4 bg-slate-50 rounded-2xl border-2 border-slate-200 text-center">
                        <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Legal & Privacy</h3>
                        <div class="flex justify-center gap-6">
                            <button @click="showLegalDoc = 'privacy'" class="text-blue-500 font-bold text-[10px] hover:underline uppercase tracking-widest">Privacy Policy</button>
                            <button @click="showLegalDoc = 'terms'" class="text-blue-500 font-bold text-[10px] hover:underline uppercase tracking-widest">Terms of Service</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="absolute top-4 left-4 z-40 flex flex-col gap-3">
        <button @click="showRewards = true; toggleScroll(true)" class="daily-reward-btn bg-white p-3 sm:p-4 rounded-2xl shadow-lg hover:scale-110 transition-transform border-b-4 border-pink-400 flex flex-col items-center justify-center">
            <span class="text-2xl sm:text-3xl gift-bounce">üéÅ</span>
            <span class="text-[10px] font-bold text-pink-500 uppercase">Daily Gift</span>
        </button>
        
        <div x-show="isTeacherMode && roster.length > 0" class="relative group" x-cloak>
            <button class="bg-white p-2 rounded-xl shadow-lg border-2 border-purple-400 flex items-center gap-2 font-bold text-sm text-purple-700">
                <i class="fas fa-users"></i>
                <span x-text="childProfile.name || 'Select Student'"></span>
                <i class="fas fa-chevron-down text-xs"></i>
            </button>
            <div class="absolute top-full left-0 mt-2 w-48 bg-white rounded-xl shadow-xl border-2 border-purple-100 overflow-hidden hidden group-hover:block max-h-48 overflow-y-auto">
                <template x-for="student in roster">
                    <button @click="switchStudent(student.id)" class="w-full text-left px-4 py-2 hover:bg-purple-50 text-xs font-bold text-gray-700 border-b border-gray-50 flex justify-between items-center">
                        <span x-text="student.name"></span>
                        <span x-show="student.id === currentStudentId" class="text-green-500"><i class="fas fa-check"></i></span>
                    </button>
                </template>
            </div>
        </div>
        
        <div class="safe-badge animate__animated animate__fadeInLeft" x-show="!isTeacherMode">
            <i class="fas fa-shield-alt"></i> Kid-Safe AI
        </div>
    </div>

    <div class="absolute top-4 right-4 flex flex-row items-center justify-end gap-2 sm:gap-4 z-40">
        <div x-show="!isPremium" class="hidden md:block bg-white px-4 py-2 rounded-xl shadow-lg border-2 border-orange-400">
            <p class="text-[10px] font-bold text-orange-600 uppercase text-center">
                Free Questions <span x-text="'(' + dailyQuestionsUsed + '/' + maxFreeQuestions + ')'"></span>
            </p>
            <div class="w-20 h-2 bg-gray-100 rounded-full mt-1 overflow-hidden">
                <div class="h-full bg-orange-400 transition-all duration-500" :style="'width: ' + ((maxFreeQuestions - dailyQuestionsUsed) / maxFreeQuestions * 100) + '%'"></div>
            </div>
        </div>

        <div class="bg-white p-2 sm:p-4 rounded-2xl shadow-lg border-b-4 border-gray-400 flex items-center gap-1 sm:gap-2">
            <span class="text-xl sm:text-3xl">üí∞</span>
            <span class="font-kids text-lg sm:text-2xl text-yellow-700" x-text="coins"></span>
        </div>

        <button @click="showShop = true; toggleScroll(true)" class="bg-white p-3 sm:p-4 rounded-2xl shadow-lg hover:scale-110 transition-transform border-b-4 border-blue-400">
            <span class="text-xl sm:text-3xl">ü™Ñ</span>
        </button>

        <button @click="openParentPortal()" class="bg-white p-3 sm:p-4 rounded-2xl shadow-lg hover:scale-110 transition-transform border-b-4" :class="isTeacherMode ? 'border-purple-400' : 'border-gray-400'">
            <span class="text-xl sm:text-2xl" x-text="isTeacherMode ? 'üè´' : 'üîí'"></span>
        </button>
    </div>

    <div class="container max-w-6xl mx-auto px-4 pt-28 sm:pt-12 pb-8 sm:pb-12">
        <div class="flex justify-center gap-2 sm:gap-4 mb-6 sm:mb-8">
            <template x-for="char in characters">
                <button 
                    @click="trySetChar(char)"
                    class="char-btn w-14 h-14 sm:w-16 sm:h-16 md:w-20 md:h-20 rounded-full bg-white flex items-center justify-center text-3xl sm:text-4xl border-4 border-transparent shadow-lg"
                    :class="{
                        'active border-white': currentChar.name === char.name, 
                        'opacity-60': currentChar.name !== char.name && (!char.premium || isPremium),
                        'char-locked': char.premium && !isPremium
                    }"
                >
                    <span x-text="char.icon"></span>
                    <div x-show="char.premium && !isPremium" class="lock-overlay">
                        <i class="fas fa-lock"></i>
                    </div>
                </button>
            </template>
        </div>

        <div class="text-center mb-6 sm:mb-10">
            <h1 class="text-4xl sm:text-5xl lg:text-6xl font-kids drop-shadow-lg tracking-wider animate__animated animate__bounceInDown"
                :style="'color: ' + currentChar.accent"
                x-text="currentChar.name">
            </h1>
            <p class="font-bold text-base sm:text-lg md:text-xl mt-3 opacity-80" :style="'color: ' + currentChar.accent" x-text="'Teacher of ' + currentChar.subject + ' ‚ú®'"></p>
        </div>

        <div class="flex flex-col lg:flex-row items-center justify-center lg:justify-between gap-10 sm:gap-8 lg:gap-12">
            
            <div class="relative flex flex-col items-center order-2 lg:order-1">
                
                <div class="relative char-float select-none cursor-pointer transition-all duration-300" 
                     :class="[isSpeaking ? 'wiggle-speak' : '', getEquippedItemData().effectType === 'glow' ? 'effect-glow' : '']">
                     
                     <template x-if="getEquippedItemData().effectType === 'sparkles'">
                         <div class="absolute inset-0 pointer-events-none">
                            <template x-for="i in 6">
                                <div class="sparkle-particle text-yellow-400 text-4xl"
                                     :style="'top: ' + (Math.random() * 100) + '%; left: ' + (Math.random() * 100) + '%; animation-delay: ' + (Math.random() * 2) + 's'">
                                     ‚ú®
                                </div>
                            </template>
                         </div>
                     </template>

                     <template x-if="getEquippedItemData().effectType === 'fireflies'">
                        <div class="absolute inset-0 pointer-events-none">
                           <template x-for="i in 5">
                               <div class="firefly-particle"
                                    :style="'top: ' + (Math.random() * 80 + 10) + '%; left: ' + (Math.random() * 80 + 10) + '%; animation-delay: ' + (Math.random() * 3) + 's'">
                               </div>
                           </template>
                        </div>
                    </template>

                    <template x-if="getEquippedItemData().effectType === 'stars'">
                        <div class="orbit-container pointer-events-none">
                            <div class="star-item text-4xl text-yellow-300" style="top: 0; left: 50%; transform: translateX(-50%);">‚≠ê</div>
                            <div class="star-item text-3xl text-yellow-400" style="bottom: 10%; left: 10%;">‚≠ê</div>
                            <div class="star-item text-3xl text-yellow-400" style="bottom: 10%; right: 10%;">‚≠ê</div>
                        </div>
                    </template>

                    <template x-if="getEquippedItemData().effectType === 'dust'">
                        <div class="absolute inset-0 pointer-events-none overflow-visible">
                           <template x-for="i in 8">
                               <div class="dust-particle text-blue-300 text-2xl"
                                    :style="'left: ' + (Math.random() * 100) + '%; animation-delay: ' + (Math.random() * 2) + 's; animation-duration: ' + (2 + Math.random()) + 's'">
                                    ü™Ñ
                               </div>
                           </template>
                        </div>
                    </template>

                     <div class="text-[6rem] sm:text-[9rem] md:text-[12rem] lg:text-[15rem]" x-text="currentMoodIcon"></div>
                </div>
                
                <div x-show="isThinking" class="absolute -top-8 left-8 sm:-top-10 sm:left-10 animate__animated animate__fadeIn">
                    <div class="bg-white rounded-full px-4 py-2 shadow-lg flex gap-2">
                        <div class="w-3 h-3 rounded-full animate-bounce" :style="'background: ' + currentChar.accent"></div>
                        <div class="w-3 h-3 rounded-full animate-bounce" style="animation-delay: 0.2s; background: #ff512f"></div>
                        <div class="w-3 h-3 rounded-full animate-bounce" style="animation-delay: 0.4s; background: #24d4dd"></div>
                    </div>
                </div>
            </div>

            <div class="w-full max-w-2xl order-1 lg:order-2">
                <div class="chat-bubble p-6 sm:p-8 md:p-10 mb-8 min-h-[180px] sm:min-h-[220px] flex flex-col justify-between transition-all duration-500"
                     :style="'border-color: ' + currentChar.accent">
                    <div>
                        <span class="font-kids text-base sm:text-lg uppercase tracking-widest block mb-2" :style="'color: ' + currentChar.accent" x-text="currentChar.name + ' says:'"></span>
                        <p class="text-xl sm:text-2xl md:text-3xl text-gray-800 font-semibold leading-relaxed" x-text="displayText"></p>
                    </div>
                    
                    <div class="flex flex-wrap justify-end gap-3 mt-6" x-show="hasAnswered && !isThinking">
                        <button 
                            @click="startQuiz()"
                            class="flex items-center gap-2 px-5 py-3 rounded-2xl font-kids text-base sm:text-lg transition-all transform hover:scale-110 active:scale-95 border-b-4 bg-yellow-400 border-yellow-600 text-yellow-900 shadow-md"
                        >
                            <span class="text-xl">üèÜ</span> Challenge Me!
                        </button>

                        <button 
                            @click="speak(displayText)"
                            class="flex items-center gap-3 px-5 sm:px-6 py-2 sm:py-3 rounded-2xl font-kids text-base sm:text-lg transition-all transform hover:scale-110 active:scale-95 border-b-4"
                            :style="'background: ' + currentChar.accent + '22; color: ' + currentChar.accent + '; border-color: ' + currentChar.accent + '44'"
                        >
                            <i class="fas" :class="isSpeaking ? 'fa-pause-circle' : 'fa-play-circle'"></i>
                            <span x-text="isSpeaking ? 'Stop' : 'Listen'"></span>
                        </button>
                    </div>
                </div>

                <div class="relative bg-white rounded-3xl shadow-2xl p-2 sm:p-3 border-4 transition-all flex items-center gap-2 sm:gap-4 pr-2 sm:pr-3"
                     :style="'border-color: ' + currentChar.accent + '44'">
                    
                    <button 
                        @click="startListening()"
                        class="ml-2 sm:ml-4 text-2xl transition-all hover:scale-110"
                        :class="isListening ? 'mic-active' : 'text-gray-400'"
                        :style="!isListening ? 'color: ' + currentChar.accent : ''"
                    >
                        <i class="fas fa-microphone"></i>
                    </button>

                    <input 
                        type="text" 
                        x-model="userQuery" 
                        @keyup.enter="askTutor()"
                        :placeholder="isListening ? 'Listening...' : 'Ask about ' + currentChar.subject + '...'" 
                        class="flex-1 bg-transparent px-2 py-3 sm:py-4 outline-none text-base sm:text-xl font-bold text-gray-700 min-w-0"
                    >
                    
                    <button 
                        @click="generateArt()"
                        class="ml-2 btn-grad text-white rounded-2xl px-3 py-2 sm:px-6 sm:py-2 font-kids text-xs sm:text-lg shadow-lg transform transition hover:scale-105 active:scale-90 whitespace-nowrap"
                        style="background: linear-gradient(to right, #ec4899, #8b5cf6)"
                    >
                        üé® Draw
                    </button>

                    <button 
                        @click="askTutor()"
                        class="btn-grad text-white rounded-2xl px-3 py-2 sm:px-6 sm:py-2 font-kids text-xs sm:text-lg shadow-lg transform transition hover:scale-105 active:scale-90 mr-1 sm:mr-0 whitespace-nowrap"
                        :style="'background: linear-gradient(to right, ' + currentChar.accent + ', #ff512f)'"
                    >
                        ASK! üöÄ
                    </button>
                </div>

                <div class="mt-6 sm:mt-8 flex flex-wrap gap-2 sm:gap-3 justify-center">
                    <template x-for="q in suggestions">
                        <button 
                            @click="userQuery = q; askTutor()"
                            class="bg-white hover:bg-opacity-90 px-3 py-1.5 sm:px-5 sm:py-2 rounded-full text-xs sm:text-sm font-bold shadow-sm hover:shadow-md transition-all border-2"
                            :style="'color: ' + currentChar.accent + '; border-color: ' + currentChar.accent + '22'"
                            x-text="q">
                        </button>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <div x-show="showQuiz" x-cloak class="fixed inset-0 z-[80] flex items-center justify-center p-6 bg-black bg-opacity-80" x-transition.opacity>
        <div @click.away="showQuiz = false; toggleScroll(false)" class="bg-white rounded-[2.5rem] max-w-lg w-full p-8 shadow-2xl relative animate__animated animate__bounceIn">
            <button @click="showQuiz = false; toggleScroll(false)" class="absolute top-6 right-6 text-2xl text-gray-400 hover:text-gray-600"><i class="fas fa-times-circle"></i></button>
            <div class="text-center" x-show="quizState === 'loading'">
                <div class="spinner mx-auto mb-4 border-yellow-400"></div>
                <h2 class="text-2xl font-kids text-yellow-500">Thinking up a tricky one... ü§î</h2>
            </div>
            <div x-show="quizState === 'active'">
                <span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide">Pop Quiz!</span>
                <h2 class="text-2xl font-bold text-gray-800 mt-4 mb-6 leading-tight" x-text="quizQuestion"></h2>
                <div class="space-y-3">
                    <template x-for="(option, index) in quizOptions">
                        <button @click="checkAnswer(index)" class="w-full text-left p-4 rounded-2xl border-2 border-gray-100 hover:border-blue-400 hover:bg-blue-50 transition-all font-bold text-gray-700 flex items-center gap-3">
                            <span class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-sm font-bold" x-text="['A','B','C'][index]"></span>
                            <span x-text="option"></span>
                        </button>
                    </template>
                </div>
            </div>
            <div class="text-center" x-show="quizState === 'correct'">
                <div class="text-6xl mb-4 animate__animated animate__tada">üéâ</div>
                <h2 class="text-3xl font-kids text-green-500 mb-2">Correct!</h2>
                <p class="font-bold text-gray-500 mb-6">You earned 20 Coins!</p>
                <button @click="showQuiz = false; toggleScroll(false)" class="bg-green-500 text-white px-8 py-3 rounded-xl font-kids shadow-lg hover:scale-105 transition-transform">Awesome!</button>
            </div>
            <div class="text-center" x-show="quizState === 'wrong'">
                <div class="text-6xl mb-4 animate__animated animate__shakeX">üòÖ</div>
                <h2 class="text-3xl font-kids text-orange-500 mb-2">Oops!</h2>
                <p class="font-bold text-gray-500 mb-6">That wasn't quite right. Try again?</p>
                <button @click="quizState = 'active'" class="bg-orange-400 text-white px-8 py-3 rounded-xl font-kids shadow-lg hover:scale-105 transition-transform">Try Again</button>
            </div>
        </div>
    </div>

    <div x-show="showArtModal" x-cloak class="fixed inset-0 z-[80] flex items-center justify-center p-6 bg-black bg-opacity-80" x-transition.opacity>
        <div @click.away="showArtModal = false; toggleScroll(false)" class="bg-white rounded-[2.5rem] max-w-2xl w-full p-8 shadow-2xl relative animate__animated animate__zoomIn text-center border-4 border-pink-200">
            <button @click="showArtModal = false; toggleScroll(false)" class="absolute top-6 right-6 text-2xl text-gray-400 hover:text-gray-600"><i class="fas fa-times-circle"></i></button>
            <h2 class="text-4xl font-kids text-pink-500 mb-2">Magic Art Studio üé®</h2>
            <p class="text-gray-500 font-bold mb-6">Turning your words into coloring pages...</p>
            <div id="printable-art-container" class="min-h-[300px] flex items-center justify-center bg-gray-50 rounded-2xl border-2 border-dashed border-gray-300 mb-6 relative overflow-hidden">
                <div x-show="isDrawing" class="flex flex-col items-center">
                    <div class="spinner border-pink-400 mb-4"></div>
                    <p class="font-kids text-pink-400 animate-pulse">Painting... üñåÔ∏è</p>
                </div>
                <img x-show="artImage && !isDrawing" :src="artImage" class="max-w-full max-h-[400px] rounded-xl shadow-lg animate__animated animate__fadeIn">
                <div x-show="!artImage && !isDrawing" class="text-gray-400 font-bold">Tell me what to draw first!</div>
            </div>
            <div class="flex justify-center gap-4" x-show="artImage && !isDrawing">
                <button @click="window.print()" class="bg-blue-500 text-white px-6 py-3 rounded-xl font-kids shadow-lg hover:scale-105 transition-transform"><i class="fas fa-print mr-2"></i> Print</button>
                <button @click="downloadArt()" class="bg-green-500 text-white px-6 py-3 rounded-xl font-kids shadow-lg hover:scale-105 transition-transform flex items-center"><i class="fas fa-download mr-2"></i> Save</button>
            </div>
        </div>
    </div>

    <div x-show="showParentPortal" x-cloak class="fixed inset-0 z-[60] flex items-center justify-center p-0 sm:p-6 bg-slate-900 bg-opacity-95 overflow-y-auto" x-transition.opacity>
        
        <div x-show="!parentAuthenticated" class="bg-white rounded-3xl p-8 max-w-xs w-full text-center shadow-2xl animate__animated animate__fadeInUp my-auto">
            <h2 class="text-2xl font-kids text-gray-700 mb-2" x-text="isTeacherMode ? 'Teacher Access' : 'Parents Only'"></h2>
            <p class="text-sm text-gray-500 mb-6" x-text="isChangingPin ? 'Enter NEW 4-digit PIN' : 'Enter PIN to see Dashboard'"></p>
            <input type="password" maxlength="4" x-model="pinInput" @keyup.enter="verifyPin" class="w-full text-center text-4xl tracking-[1em] font-bold border-b-4 border-gray-200 outline-none mb-8 focus:border-blue-500">
            <div class="flex gap-2">
                <button @click="closeParentPortal" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold">Cancel</button>
                <button @click="verifyPin" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold" x-text="isChangingPin ? 'Save' : 'Open'"></button>
            </div>
        </div>

        <div x-show="parentAuthenticated" class="bg-slate-50 rounded-none sm:rounded-[2rem] w-full h-full sm:h-auto sm:max-h-[90vh] max-w-none sm:max-w-5xl flex flex-col shadow-2xl animate__animated animate__zoomIn overflow-hidden">
            
            <div class="bg-white p-6 sm:p-8 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl sm:text-3xl font-kids text-slate-800" x-text="isTeacherMode ? 'Teacher Dashboard üè´' : 'Parent Dashboard'"></h2>
                    <p class="text-xs text-slate-400 font-bold uppercase tracking-widest mt-1">Overview for <span x-text="isTeacherMode ? 'Classroom' : (childProfile.name || 'Your Child')"></span></p>
                </div>
                <button @click="closeParentPortal" class="text-gray-400 hover:text-red-500 transition-colors text-2xl"><i class="fas fa-times-circle"></i></button>
            </div>

            <div x-show="isTeacherMode" class="flex-1 overflow-y-auto custom-scroll p-6 sm:p-8">
                <div class="flex gap-4 mb-6 overflow-x-auto pb-2">
                    <button @click="teacherTab = 'roster'" :class="teacherTab === 'roster' ? 'bg-purple-600 text-white' : 'bg-white text-gray-600'" class="px-6 py-2 rounded-xl font-bold shadow-sm whitespace-nowrap">üë©‚Äçüéì Class Roster</button>
                    <button @click="teacherTab = 'stats'" :class="teacherTab === 'stats' ? 'bg-purple-600 text-white' : 'bg-white text-gray-600'" class="px-6 py-2 rounded-xl font-bold shadow-sm whitespace-nowrap">üìä Class Stats</button>
                    <button @click="teacherTab = 'worksheets'" :class="teacherTab === 'worksheets' ? 'bg-purple-600 text-white' : 'bg-white text-gray-600'" class="px-6 py-2 rounded-xl font-bold shadow-sm whitespace-nowrap">üñ®Ô∏è Worksheets</button>
                </div>

                <div x-show="teacherTab === 'roster'" class="animate__animated animate__fadeIn">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 mb-6">
                        <h3 class="font-bold text-slate-800 mb-4">Add Student</h3>
                        <div class="flex gap-2">
                            <input type="text" x-model="newStudentName" @keyup.enter="addStudent" placeholder="Student Name" class="flex-1 p-3 bg-slate-50 border rounded-xl font-bold">
                            <button @click="addStudent" class="px-6 py-3 bg-green-500 text-white rounded-xl font-bold shadow-lg">Add</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <template x-for="(student, index) in roster">
                            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center font-bold text-lg" x-text="student.name[0]"></div>
                                    <div>
                                        <p class="font-bold text-slate-700" x-text="student.name"></p>
                                        <p class="text-xs text-gray-400 font-bold" x-text="student.xp + ' XP'"></p>
                                    </div>
                                </div>
                                <button @click="removeStudent(index)" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                            </div>
                        </template>
                        <div x-show="roster.length === 0" class="col-span-3 text-center py-8 text-gray-400">No students yet. Add one above!</div>
                    </div>
                </div>

                <div x-show="teacherTab === 'stats'" class="animate__animated animate__fadeIn">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="text-xs text-slate-400 font-bold uppercase border-b border-gray-100">
                                    <th class="pb-3 pl-2">Student</th>
                                    <th class="pb-3">Level</th>
                                    <th class="pb-3">Coins</th>
                                    <th class="pb-3">XP</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="student in roster">
                                    <tr class="border-b border-gray-50 last:border-0 hover:bg-gray-50">
                                        <td class="py-3 pl-2 font-bold text-slate-700" x-text="student.name"></td>
                                        <td class="py-3">
                                            <span class="bg-purple-100 text-purple-600 px-2 py-1 rounded-full text-xs font-bold" x-text="'Lvl ' + (Math.floor(student.xp / 100) + 1)"></span>
                                        </td>
                                        <td class="py-3 font-bold text-yellow-600" x-text="student.coins + ' üí∞'"></td>
                                        <td class="py-3 font-bold text-slate-500" x-text="student.xp"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                        <div x-show="roster.length === 0" class="text-center py-8 text-gray-400">No students to show stats for.</div>
                    </div>
                </div>

                <div x-show="teacherTab === 'worksheets'" class="animate__animated animate__fadeIn">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 text-center">
                        <h3 class="text-2xl font-kids text-slate-800 mb-2">Create Lesson Worksheet</h3>
                        <p class="text-gray-500 mb-6">Select a topic to auto-generate a printable activity page.</p>
                        
                        <div class="flex flex-wrap justify-center gap-3 mb-6">
                            <template x-for="char in characters">
                                <button @click="worksheetTopic = char.subject" 
                                    class="px-4 py-2 rounded-xl border-2 font-bold transition-all"
                                    :class="worksheetTopic === char.subject ? 'bg-purple-50 border-purple-500 text-purple-700' : 'bg-gray-50 border-gray-200 text-gray-500'">
                                    <span x-text="char.icon + ' ' + char.subject"></span>
                                </button>
                            </template>
                        </div>

                        <button @click="generateWorksheet" 
                            class="bg-blue-500 text-white px-8 py-3 rounded-xl font-kids text-lg shadow-lg hover:bg-blue-600 transition-transform hover:-translate-y-1">
                            <i class="fas fa-wand-magic-sparkles mr-2"></i> Generate & Print
                        </button>
                    </div>
                </div>
            </div>

            <div x-show="!isTeacherMode" class="flex-1 overflow-y-auto custom-scroll p-6 sm:p-8">
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="font-bold text-slate-700 text-lg"><i class="fas fa-id-card text-blue-500 mr-2"></i>Child Profile</h3>
                            <button @click="isEditingProfile = !isEditingProfile" class="text-xs font-bold text-blue-500 uppercase hover:underline" x-text="isEditingProfile ? 'Save' : 'Edit'"></button>
                        </div>
                        
                        <div x-show="!isEditingProfile" class="space-y-3">
                            <div><p class="text-xs text-slate-400 font-bold uppercase">Name</p><p class="text-xl font-kids text-slate-800" x-text="childProfile.name"></p></div>
                            <div class="flex gap-6">
                                <div><p class="text-xs text-slate-400 font-bold uppercase">Age</p><p class="text-lg font-bold text-slate-700" x-text="childProfile.age + ' Years'"></p></div>
                                <div><p class="text-xs text-slate-400 font-bold uppercase">Grade</p><p class="text-lg font-bold text-slate-700" x-text="childProfile.grade"></p></div>
                            </div>
                        </div>

                        <div x-show="isEditingProfile" class="space-y-3 animate__animated animate__fadeIn">
                            <input type="text" x-model="childProfile.name" class="w-full p-2 border rounded-xl bg-slate-50 font-bold text-sm" placeholder="Name">
                            <div class="flex gap-2">
                                <input type="number" x-model="childProfile.age" class="w-1/2 p-2 border rounded-xl bg-slate-50 font-bold text-sm" placeholder="Age">
                                <input type="text" x-model="childProfile.grade" class="w-1/2 p-2 border rounded-xl bg-slate-50 font-bold text-sm" placeholder="Grade (e.g. 2nd)">
                            </div>
                            <button @click="saveChildProfile()" class="w-full py-2 bg-blue-500 text-white rounded-xl text-sm font-bold mt-2">Update Profile</button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex flex-col justify-between">
                         <div class="flex justify-between items-start">
                            <h3 class="font-bold text-slate-700 text-lg"><i class="fas fa-crown text-yellow-500 mr-2"></i>Membership</h3>
                            <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase" :class="isPremium ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'" x-text="isPremium ? 'Premium' : 'Free'"></span>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600 mb-4" x-text="isPremium ? 'All teachers and features unlocked.' : 'Limited to 5 questions per day.'"></p>
                            <template x-if="isPremium && premiumExpiry">
                                <p class="text-xs text-gray-400 font-bold mb-3">
                                    Renews on: <span class="text-slate-600" x-text="new Date(premiumExpiry).toLocaleDateString()"></span>
                                </p>
                            </template>
                            <button @click="isPremium ? cancelSubscription() : processPayment()" 
                                class="w-full py-3 rounded-xl font-bold text-sm transition-all" 
                                :class="isPremium ? 'bg-red-50 text-red-500 border border-red-100' : 'bg-gradient-to-r from-yellow-400 to-orange-400 text-white shadow-lg transform hover:-translate-y-1'">
                                <span x-text="isPremium ? 'Cancel Subscription' : 'Upgrade Now ($4.99/mo)'"></span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-sm border border-gray-100 mb-8">
                    <h3 class="font-bold text-slate-800 text-xl mb-6 flex items-center gap-2">
                        <i class="fas fa-rocket text-purple-500"></i> Learning Journey
                    </h3>
                    <div class="relative w-full mt-4 mb-8 px-2 sm:px-10">
                        <div class="absolute left-4 right-4 top-5 h-1.5 bg-gray-100 rounded-full z-0"></div>
                        <div class="absolute left-4 top-5 h-1.5 bg-green-400 rounded-full z-0 transition-all duration-1000" :style="'width: ' + journeyProgress + '%'"></div>

                        <div class="relative flex justify-between items-start z-10">
                            <div class="flex flex-col items-center gap-2">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center border-4 bg-white transition-all shadow-md"
                                     :class="xp >= 0 ? 'border-green-400 text-green-500' : 'border-gray-200 text-gray-300'">
                                    <i class="fas fa-egg text-lg"></i>
                                </div>
                                <span class="text-[10px] font-bold uppercase tracking-wider mt-1" :class="xp >= 0 ? 'text-green-600' : 'text-gray-300'">Beginner</span>
                            </div>
                            
                            <div class="flex flex-col items-center gap-2">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center border-4 bg-white transition-all shadow-md"
                                     :class="xp >= 1000 ? 'border-blue-400 text-blue-500' : 'border-gray-200 text-gray-300'">
                                    <i class="fas fa-book-reader text-lg"></i>
                                </div>
                                <span class="text-[10px] font-bold uppercase tracking-wider mt-1" :class="xp >= 1000 ? 'text-blue-600' : 'text-gray-300'">Intermediate</span>
                            </div>

                            <div class="flex flex-col items-center gap-2">
                                 <div class="w-12 h-12 rounded-full flex items-center justify-center border-4 bg-white transition-all shadow-md"
                                     :class="xp >= 3000 ? 'border-purple-400 text-purple-500' : 'border-gray-200 text-gray-300'">
                                    <i class="fas fa-graduation-cap text-lg"></i>
                                </div>
                                <span class="text-[10px] font-bold uppercase tracking-wider mt-1" :class="xp >= 3000 ? 'text-purple-600' : 'text-gray-300'">Advanced</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mt-8">
                        <div class="bg-orange-50 p-4 rounded-2xl border border-orange-100 text-center">
                            <div class="text-2xl mb-1">‚ùì</div>
                            <div class="text-2xl font-bold text-orange-600" x-text="parentLogs.length"></div>
                            <div class="text-[10px] text-orange-400 font-bold uppercase">Questions Asked</div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 text-center">
                            <div class="text-2xl mb-1">üìñ</div>
                            <div class="text-2xl font-bold text-blue-600" x-text="learningStats.wordsLearned"></div>
                            <div class="text-[10px] text-blue-400 font-bold uppercase">Words Read</div>
                        </div>
                         <div class="bg-yellow-50 p-4 rounded-2xl border border-yellow-100 text-center">
                            <div class="text-2xl mb-1">üí∞</div>
                            <div class="text-2xl font-bold text-yellow-600" x-text="coins"></div>
                            <div class="text-[10px] text-yellow-400 font-bold uppercase">Coins Earned</div>
                        </div>
                        <div class="bg-pink-50 p-4 rounded-2xl border border-pink-100 text-center">
                            <div class="text-2xl mb-1">‚≠ê</div>
                            <div class="text-2xl font-bold text-pink-600" x-text="xp"></div>
                            <div class="text-[10px] text-pink-400 font-bold uppercase">Total XP</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-slate-800 text-lg mb-4">Top Subjects</h3>
                        <div class="space-y-4">
                            <template x-for="(score, subject) in getTopSubjects()">
                                <div>
                                    <div class="flex justify-between text-xs font-bold text-gray-500 mb-1 uppercase">
                                        <span x-text="subject"></span>
                                        <span x-text="score + ' pts'"></span>
                                    </div>
                                    <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                                        <div class="h-full rounded-full transition-all duration-1000" 
                                             :class="getSubjectColor(subject)" 
                                             :style="'width: ' + Math.min((score / 50) * 100, 100) + '%'"></div>
                                    </div>
                                </div>
                            </template>
                             <div x-show="Object.values(learningStats.subjects).reduce((a, b) => a + b, 0) === 0" class="text-center text-gray-400 text-sm py-4">
                                No data yet. Start asking questions!
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                             <h3 class="font-bold text-slate-800 text-lg">Recent Questions</h3>
                             <button @click="clearLogs" class="text-[10px] font-bold text-red-400 hover:text-red-600 uppercase">Clear History</button>
                        </div>
                        <div class="flex-1 overflow-y-auto max-h-[200px] custom-scroll pr-2 space-y-3">
                            <template x-for="log in parentLogs.slice().reverse().slice(0, 10)">
                                <div class="bg-gray-50 p-3 rounded-xl border-l-4 border-blue-400">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-[10px] text-gray-400 font-bold" x-text="log.time"></span>
                                        <span class="text-[9px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold uppercase whitespace-nowrap ml-2" x-text="'FROM: ' + log.char"></span>
                                    </div>
                                    <p class="text-slate-700 text-sm font-semibold" x-text="log.query"></p>
                                </div>
                            </template>
                             <div x-show="parentLogs.length === 0" class="text-center text-gray-400 text-sm py-8">
                                No activity recorded yet.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 border-t bg-slate-50 flex justify-between">
                <button @click="startPinChange" class="text-blue-500 font-bold text-xs hover:underline">Change PIN</button>
                <button @click="closeParentPortal" class="bg-slate-800 text-white px-6 py-2 rounded-xl font-bold text-sm">Exit</button>
            </div>
        </div>
    </div>

    <div id="printable-worksheet" class="hidden bg-white p-10 font-sans text-slate-800">
        <div class="border-4 border-slate-800 p-8 h-full rounded-[3rem] relative">
            <h1 class="text-4xl font-kids text-center mb-2" x-text="worksheetTopic + ' Worksheet'"></h1>
            <p class="text-center text-slate-500 font-bold mb-8">Name: __________________________   Date: ______________</p>
            
            <div class="mb-8 text-center border-2 border-dashed border-gray-300 rounded-xl p-4 min-h-[300px] flex flex-col items-center justify-center">
                 <p class="text-slate-400 font-bold uppercase mb-2 text-xs">Coloring Activity</p>
                 <img :src="worksheetImage" class="max-h-[300px] max-w-full object-contain filter grayscale contrast-125 brightness-110">
            </div>

            <div class="mb-8">
                <h3 class="font-kids text-xl mb-4">Vocabulary Words</h3>
                <div class="grid grid-cols-2 gap-4">
                    <template x-for="word in worksheetVocab">
                        <div class="border border-slate-300 p-4 rounded-xl flex justify-between items-end h-20">
                            <span x-text="word" class="font-bold text-lg"></span>
                            <div class="h-px w-20 bg-slate-300"></div>
                        </div>
                    </template>
                </div>
            </div>

            <div>
                <h3 class="font-kids text-xl mb-4">Quick Quiz</h3>
                <template x-for="(q, i) in worksheetQuiz">
                    <div class="mb-4">
                        <p class="font-bold text-sm mb-2" x-text="(i+1) + '. ' + q.question"></p>
                        <div class="flex gap-4">
                            <span class="w-4 h-4 border border-slate-400 rounded-full inline-block"></span> <span x-text="q.a" class="text-sm"></span>
                            <span class="w-4 h-4 border border-slate-400 rounded-full inline-block"></span> <span x-text="q.b" class="text-sm"></span>
                        </div>
                    </div>
                </template>
            </div>
            
            <div class="absolute bottom-4 right-8 text-xs text-slate-400 font-bold">Generated by AI Tutor</div>
        </div>
    </div>

    <div x-show="showLegalDoc" x-cloak class="fixed inset-0 z-[110] flex items-center justify-center p-6 bg-black bg-opacity-80" x-transition.opacity>
        <div class="bg-white rounded-[2rem] max-w-lg w-full p-8 shadow-2xl relative flex flex-col max-h-[80vh]">
            <button @click="showLegalDoc = null" class="absolute top-6 right-6 text-2xl text-gray-400 hover:text-gray-600"><i class="fas fa-times-circle"></i></button>
            <h2 class="text-2xl font-kids mb-4 text-slate-800" x-text="showLegalDoc === 'privacy' ? 'Privacy Policy' : 'Terms of Service'"></h2>
            <div class="overflow-y-auto pr-2 text-sm text-slate-600 space-y-4">
                <template x-if="showLegalDoc === 'privacy'">
                    <div class="space-y-4">
                        <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                            <p class="font-bold text-green-700 flex items-center gap-2"><i class="fas fa-shield-alt"></i> STRICT NO DATA SALE POLICY</p>
                            <p class="text-xs text-green-800 mt-1">We do NOT sell, trade, or rent your child's personal identification information to others. Ever.</p>
                        </div>
                        <div><h3 class="font-bold text-slate-800">1. Information We Collect</h3><p>Email, PIN, and learning stats only.</p></div>
                    </div>
                </template>
                <template x-if="showLegalDoc === 'terms'">
                    <div class="space-y-4">
                        <div><h3 class="font-bold text-slate-800">1. Acceptance</h3><p>By using this app, you agree to these terms.</p></div>
                    </div>
                </template>
            </div>
        </div>
    </div>
    
    <div x-show="showShop" x-cloak class="fixed inset-0 z-50 flex items-center justify-center p-4 sm:p-6 bg-black bg-opacity-70" x-transition.opacity>
        <div @click.away="showShop = false; toggleScroll(false)" class="bg-white rounded-[2rem] sm:rounded-[3rem] max-w-2xl w-full p-4 sm:p-8 shadow-2xl relative animate__animated animate__zoomIn border-4 border-blue-200 max-h-[85vh] overflow-y-auto">
            <button @click="showShop = false; toggleScroll(false)" class="absolute top-4 right-4 sm:top-6 sm:right-6 text-2xl text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times-circle"></i></button>
            <h2 class="text-3xl sm:text-4xl font-kids text-center mb-2 text-purple-600">Magic Auras</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 sm:gap-6">
                <template x-for="item in shopItems">
                    <div class="flex flex-col items-center gap-2 sm:gap-3 p-2 sm:p-4 rounded-2xl border-2 transition-all hover:scale-105"
                         :class="equippedItem === item.id ? 'bg-purple-50 border-purple-400 ring-2 ring-purple-200' : 'bg-gray-50 border-gray-100'">
                        <div class="relative w-16 h-16 sm:w-24 sm:h-24 flex items-center justify-center bg-white rounded-full shadow-inner text-3xl sm:text-5xl">
                            <span x-text="item.icon"></span>
                            <div x-show="inventory.includes(item.id)" class="absolute -bottom-1 -right-1 sm:-bottom-2 sm:-right-2 bg-green-500 text-white rounded-full w-6 h-6 sm:w-8 sm:h-8 flex items-center justify-center text-[10px] sm:text-xs border-2 border-white"><i class="fas fa-check"></i></div>
                        </div>
                        <div class="text-center w-full">
                            <h3 class="font-bold text-gray-700 text-xs sm:text-base truncate w-full" x-text="item.name"></h3>
                            <div x-show="!inventory.includes(item.id)" class="text-yellow-600 font-bold text-xs sm:text-sm bg-yellow-100 px-2 sm:px-3 py-0.5 sm:py-1 rounded-full mt-1 inline-block"><span x-text="item.price"></span> üí∞</div>
                        </div>
                        <button @click="inventory.includes(item.id) ? toggleEquip(item.id) : buyItem(item)" class="w-full py-1.5 sm:py-2 rounded-xl font-bold text-xs sm:text-sm shadow-md transition-transform active:scale-95" :class="inventory.includes(item.id) ? (equippedItem === item.id ? 'bg-purple-500 text-white' : 'bg-gray-200 text-gray-600') : (coins >= item.price ? 'bg-green-500 text-white hover:bg-green-600' : 'bg-gray-300 text-gray-500 cursor-not-allowed')"><span x-text="inventory.includes(item.id) ? (equippedItem === item.id ? 'Active ‚ú®' : 'Activate') : 'Buy Now'"></span></button>
                    </div>
                </template>
            </div>
            <div class="mt-6 sm:mt-8 flex justify-center">
                <div class="bg-yellow-100 px-4 sm:px-6 py-2 rounded-full flex items-center gap-2 border-2 border-yellow-300"><span class="text-xl sm:text-2xl">üí∞</span><span class="font-bold text-sm sm:text-base text-yellow-800" x-text="'You have ' + coins + ' coins'"></span></div>
            </div>
        </div>
    </div>

    <div x-show="showRewards" x-cloak class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black bg-opacity-70" x-transition.opacity>
        <div @click.away="showRewards = false; toggleScroll(false)" class="bg-white rounded-[3rem] max-w-md w-full p-8 shadow-2xl relative animate__animated animate__backInDown text-center">
            <button @click="showRewards = false; toggleScroll(false)" class="absolute top-6 right-6 text-2xl text-gray-400 hover:text-gray-600"><i class="fas fa-times-circle"></i></button>
            <h2 class="text-4xl font-kids text-pink-500 mb-2">Daily Rewards!</h2>
            <div class="grid grid-cols-4 gap-3 mb-8">
                <template x-for="(day, index) in ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']">
                    <div class="p-3 rounded-2xl border-2 flex flex-col items-center" :class="todayIndex === index ? 'border-pink-500 bg-pink-50' : 'border-gray-100 bg-gray-50 opacity-60'">
                        <span class="text-[10px] font-bold uppercase" x-text="day"></span>
                        <span class="text-xl" x-text="index === 6 ? 'üéÅ' : 'üí∞'"></span>
                    </div>
                </template>
            </div>
            <button @click="claimReward()" :disabled="rewardClaimedToday" class="w-full py-4 rounded-3xl font-kids text-2xl text-white shadow-xl mt-6" :class="rewardClaimedToday ? 'bg-gray-400' : 'bg-gradient-to-r from-pink-500 to-orange-400'"><span x-text="rewardClaimedToday ? 'See You Tomorrow!' : 'Claim 50 Coins! ‚ú®'"></span></button>
        </div>
    </div>

    <div x-show="showPremiumModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black bg-opacity-70" x-transition.opacity>
        <div @click.away="showPremiumModal = false; toggleScroll(false)" class="bg-gradient-to-b from-yellow-200 to-yellow-400 rounded-[3rem] max-w-md w-full p-8 shadow-2xl relative animate__animated animate__bounceIn border-4 border-yellow-100">
            <button @click="showPremiumModal = false; toggleScroll(false)" class="absolute top-6 right-6 text-2xl text-yellow-800 hover:text-white"><i class="fas fa-times-circle"></i></button>
            <div class="text-center">
                <div class="text-6xl mb-4">üëë</div>
                <h2 class="text-3xl font-kids text-yellow-900 mb-2">Go Premium!</h2>
                <div class="bg-white/50 rounded-2xl p-6 mb-6 text-left space-y-3">
                    <div class="flex items-center gap-3 text-yellow-900 font-bold"><i class="fas fa-check-circle text-green-600"></i><span>Unlimited Questions</span></div>
                    <div class="flex items-center gap-3 text-yellow-900 font-bold"><i class="fas fa-check-circle text-green-600"></i><span>Unlock All Teachers</span></div>
                </div>
                <button @click="openParentPortal(); showPremiumModal = false" class="bg-white text-yellow-600 rounded-2xl px-8 py-4 font-kids text-2xl shadow-xl w-full border-b-4 border-yellow-200 mt-6">Get Premium ($4.99/mo)</button>
            </div>
        </div>
    </div>
    
    <div x-show="showCheckout" x-cloak class="fixed inset-0 z-[70] flex items-center justify-center p-6 bg-slate-900 bg-opacity-95 overflow-y-auto" x-transition.opacity>
        <div class="bg-white rounded-[2rem] max-w-md w-full p-8 shadow-2xl text-center my-auto">
            <h2 class="text-3xl font-kids text-slate-800 mb-2">Secure Checkout</h2>
            <div class="text-left space-y-4 mb-8">
                <div><label class="block text-xs font-bold text-black uppercase tracking-widest mb-1">Card Number</label><input type="text" placeholder="0000 0000 0000 0000" class="w-full p-4 bg-slate-50 border-2 border-black rounded-xl"></div>
                <div class="flex gap-4">
                    <div class="flex-1"><label class="block text-xs font-bold text-black uppercase tracking-widest mb-1">Expiry</label><input type="text" placeholder="MM/YY" class="w-full p-4 bg-slate-50 border-2 border-black rounded-xl"></div>
                    <div class="flex-1"><label class="block text-xs font-bold text-black uppercase tracking-widest mb-1">CVV</label><input type="password" placeholder="***" class="w-full p-4 bg-slate-50 border-2 border-black rounded-xl"></div>
                </div>
            </div>
            <div class="space-y-3 mt-6">
                <button @click="processPayment" class="w-full py-4 bg-green-500 text-white rounded-2xl font-kids text-xl shadow-lg hover:bg-green-600 transition-colors">Complete Payment</button>
                <button @click="showCheckout = false" class="w-full py-4 text-black font-bold hover:text-slate-600">Cancel</button>
            </div>
            <p class="text-[10px] text-slate-400 mt-6 italic">Simulation: Do not enter real sensitive information.</p>
        </div>
    </div>

    <script>
        if ("serviceWorker" in navigator) { navigator.serviceWorker.register("service-worker.js"); }

        function aiTutor() {
            return {
                supabase: null,
                isLoading: false,
                isLoggedIn: false,
                hasAccount: false,
                signupType: 'parent', // 'parent' or 'teacher'
                loginForm: { name: '', email: '', pin: '' },
                
                // User State
                isTeacherMode: false,
                registeredEmail: '',
                masterPin: '1234',
                
                // Current Active Student (or Child in Family Mode)
                currentStudentId: 'default',
                roster: [], // For Teachers: Array of student objects
                childProfile: { name: '', age: '', grade: '' }, // Also serves as active student profile
                
                // Economy (Per Student logic handled in switchStudent)
                coins: 0, 
                xp: 0,
                level: 1,
                inventory: [],
                equippedItem: null,

                // App State
                userQuery: '',
                displayText: "Hi friend! üåü I'm Professor Dino. I teach History! What do you want to know?",
                isThinking: false,
                isSpeaking: false,
                isListening: false,
                hasAnswered: false,
                currentMoodIcon: 'ü¶ñ',
                suggestions: ["Who built the pyramids? üèúÔ∏è", "What is a mummy? ü§ï", "Who was the first king? üëë"],
                
                // Teacher / Parent Portal
                showParentPortal: false,
                parentAuthenticated: false,
                pinInput: '',
                isChangingPin: false,
                teacherTab: 'roster',
                newStudentName: '',
                legalAccepted: false,
                showLegalDoc: null,
                isEditingProfile: false,
                
                // Worksheet Generator State
                worksheetTopic: 'History',
                worksheetImage: '',
                worksheetVocab: ['History', 'Ancient', 'Learn', 'Time'],
                worksheetQuiz: [{question: "What is history?", a: "The future", b: "The past"}],

                // Premium / Shop
                isPremium: false,
                premiumExpiry: null,
                showShop: false,
                showRewards: false,
                rewardClaimedToday: false,
                dailyQuestionsUsed: 0,
                maxFreeQuestions: 5,
                todayIndex: (new Date().getDay() + 6) % 7,
                showPremiumModal: false,
                showCheckout: false,
                
                // Stats
                parentLogs: [],
                learningStats: { wordsLearned: 0, subjects: { history: 0, robots: 0, space: 0, science: 0, nature: 0 } },
                
                // Quiz & Art
                showQuiz: false,
                quizState: 'loading',
                quizQuestion: '',
                quizOptions: [],
                quizCorrectIndex: 0,
                showArtModal: false,
                isDrawing: false,
                artImage: null,
                
                // Shop Data
                shopItems: [
                    { id: 'sparkles', name: 'Sparkles', icon: '‚ú®', price: 100, effectType: 'sparkles' },
                    { id: 'glow', name: 'Super Glow', icon: 'üåü', price: 250, effectType: 'glow' },
                    { id: 'fireflies', name: 'Fireflies', icon: 'üêù', price: 350, effectType: 'fireflies' },
                    { id: 'stars', name: 'Star Orbit', icon: '‚≠ê', price: 450, effectType: 'stars' },
                    { id: 'dust', name: 'Magic Dust', icon: 'ü™Ñ', price: 500, effectType: 'dust' }
                ],
                characters: [
                    { name: "Professor Dino", subject: "History", drawingTopics: ["dino", "rex", "pyramid", "history"], suggestions: ["Who built the pyramids? üèúÔ∏è", "What is a mummy? ü§ï"], icon: "ü¶ñ", mood_happy: "ü¶ñ", mood_think: "ü¶ï", bg: "radial-gradient(circle, #fff9c4 0%, #ffecb3 100%)", accent: "#f59e0b", pitch: 0.7, rate: 0.85, personality: "History Teacher", intro_phrase: "Rawr! ", premium: false },
                    { name: "Rocket Robot", subject: "Robots and AI", drawingTopics: ["robot", "ai", "tech"], suggestions: ["How do robots think? ü§ñ", "What is code? üíª"], icon: "ü§ñ", mood_happy: "ü§ñ", mood_think: "‚öôÔ∏è", bg: "radial-gradient(circle, #e0f2fe 0%, #bae6fd 100%)", accent: "#0284c7", pitch: 0.5, rate: 1.0, personality: "Robot Teacher", intro_phrase: "Beep boop! ", premium: true },
                    { name: "Starry Alien", subject: "Space Exploration", drawingTopics: ["space", "star", "planet"], suggestions: ["How hot is the sun? ‚òÄÔ∏è", "Black holes? üï≥Ô∏è"], icon: "üëæ", mood_happy: "üõ∏", mood_think: "üëÅÔ∏è", bg: "radial-gradient(circle, #f3e8ff 0%, #e9d5ff 100%)", accent: "#9333ea", pitch: 1.1, rate: 0.7, personality: "Space Teacher", intro_phrase: "Greetings! ", premium: true },
                    { name: "Magic Cat", subject: "Science", drawingTopics: ["science", "lab", "atom"], suggestions: ["Why does ice melt? üßä", "Gravity? üçé"], icon: "üê±", mood_happy: "üò∏", mood_think: "üêà", bg: "radial-gradient(circle, #fce7f3 0%, #fbcfe8 100%)", accent: "#db2777", pitch: 1.4, rate: 0.9, personality: "Science Teacher", intro_phrase: "Meow! ", premium: true },
                    { name: "Bouncy Bee", subject: "Nature", drawingTopics: ["nature", "bee", "flower"], suggestions: ["How do flowers grow? üåª", "Why is sky blue? ‚òÅÔ∏è"], icon: "üêù", mood_happy: "üåª", mood_think: "üçØ", bg: "radial-gradient(circle, #fef9c3 0%, #fef08a 100%)", accent: "#854d0e", pitch: 1.3, rate: 1.0, personality: "Nature Teacher", intro_phrase: "Buzz buzz! ", premium: true }
                ],
                currentChar: null,
                safetySettings: { blockedWords: 'war,kill,blood', forbiddenTopics: ['violence'] },

                async init() {
                    this.currentChar = this.characters[0];
                    this.currentMoodIcon = this.currentChar.icon;
                    this.isLoading = true;
                    
                    try {
                        const storedEmail = localStorage.getItem('parent_email');
                        if (storedEmail) {
                            this.loginForm.email = storedEmail;
                            this.loadUserProfile(storedEmail);
                        }
                    } catch(e) { console.error(e); } 
                    finally { this.isLoading = false; }
                },

                // --- AUTH & DATA MANAGEMENT ---
                async handleSignup() {
                    if (!this.loginForm.name || !this.loginForm.email || this.loginForm.pin.length !== 4) return alert("Please fill all fields!");
                    if (!this.legalAccepted) return alert("Please accept terms.");

                    const profileData = {
                        email: this.loginForm.email.toLowerCase(),
                        name: this.loginForm.name,
                        pin: this.loginForm.pin,
                        type: this.signupType, // 'parent' or 'teacher'
                        child_profile: { name: this.loginForm.name, age: '', grade: '' },
                        roster: [], 
                        coins: 50,
                        xp: 0,
                        inventory: [],
                        is_premium: false,
                        learning_stats: this.learningStats,
                        parent_logs: []
                    };
                    
                    localStorage.setItem('user_' + profileData.email, JSON.stringify(profileData));
                    localStorage.setItem('parent_email', profileData.email);
                    
                    this.loadUserProfile(profileData.email);
                },

                handleLogin() {
                    const email = this.loginForm.email.toLowerCase();
                    const dataStr = localStorage.getItem('user_' + email);
                    
                    if (!dataStr) return alert("Account not found.");
                    const data = JSON.parse(dataStr);
                    
                    if (data.pin !== this.loginForm.pin) return alert("Wrong PIN.");
                    
                    localStorage.setItem('parent_email', email);
                    this.loadUserProfile(email);
                    this.loginForm.pin = '';
                },

                loadUserProfile(email) {
                    const data = JSON.parse(localStorage.getItem('user_' + email));
                    if (!data) return;

                    this.registeredEmail = email;
                    this.isLoggedIn = true;
                    this.hasAccount = true;
                    this.masterPin = data.pin;
                    this.isTeacherMode = (data.type === 'teacher');
                    
                    this.roster = data.roster || [];
                    this.isPremium = data.is_premium;
                    this.learningStats = data.learning_stats || this.learningStats;
                    this.parentLogs = data.parent_logs || [];

                    // If teacher, current student is selected from roster or default
                    if (this.isTeacherMode && this.roster.length > 0) {
                        this.switchStudent(this.roster[0].id);
                    } else {
                        // Default / Parent Mode
                        this.childProfile = data.child_profile;
                        this.coins = data.coins;
                        this.xp = data.xp;
                        this.inventory = data.inventory || [];
                        this.equippedItem = data.equipped_item;
                    }
                    
                    this.updateLevel();
                    this.playPing();
                },

                syncData() {
                    if (!this.registeredEmail) return;
                    
                    let data = JSON.parse(localStorage.getItem('user_' + this.registeredEmail));
                    
                    if (this.isTeacherMode && this.currentStudentId !== 'default') {
                        // Update specific student in roster
                        const studentIndex = this.roster.findIndex(s => s.id === this.currentStudentId);
                        if (studentIndex !== -1) {
                            this.roster[studentIndex].coins = this.coins;
                            this.roster[studentIndex].xp = this.xp;
                            this.roster[studentIndex].inventory = this.inventory;
                            this.roster[studentIndex].equipped_item = this.equippedItem;
                        }
                        data.roster = this.roster;
                    } else {
                        // Update default profile
                        data.coins = this.coins;
                        data.xp = this.xp;
                        data.inventory = this.inventory;
                        data.equipped_item = this.equippedItem;
                        data.child_profile = this.childProfile;
                    }

                    data.is_premium = this.isPremium;
                    data.learning_stats = this.learningStats;
                    data.parent_logs = this.parentLogs;
                    
                    localStorage.setItem('user_' + this.registeredEmail, JSON.stringify(data));
                },

                // --- TEACHER SPECIFIC FUNCTIONS ---
                addStudent() {
                    if (!this.newStudentName) return;
                    const newStudent = {
                        id: 'stu_' + Date.now(),
                        name: this.newStudentName,
                        coins: 0,
                        xp: 0,
                        inventory: [],
                        equipped_item: null
                    };
                    this.roster.push(newStudent);
                    this.newStudentName = '';
                    this.syncData();
                    if (this.roster.length === 1) this.switchStudent(newStudent.id);
                },

                removeStudent(index) {
                    if(confirm("Remove this student?")) {
                        this.roster.splice(index, 1);
                        this.syncData();
                        if(this.roster.length > 0) this.switchStudent(this.roster[0].id);
                    }
                },

                switchStudent(studentId) {
                    this.syncData();
                    
                    const student = this.roster.find(s => s.id === studentId);
                    if (student) {
                        this.currentStudentId = student.id;
                        this.childProfile = { name: student.name }; // Update UI name
                        this.coins = student.coins;
                        this.xp = student.xp;
                        this.inventory = student.inventory || [];
                        this.equippedItem = student.equipped_item;
                        this.updateLevel();
                        this.playPing();
                    }
                },

                async generateWorksheet() {
                    this.isLoading = true;
                    try {
                        // 1. Image Generation (Using same logic as Art Studio)
                        const prompt = `coloring page, simple black and white outline, ${this.worksheetTopic}, for kids`;
                        const encodedPrompt = encodeURIComponent(prompt);
                        this.worksheetImage = `https://image.pollinations.ai/prompt/${encodedPrompt}?nologo=true&model=flux&width=1024&height=768&seed=${Math.floor(Math.random()*1000)}&safe=true`;
                        
                        // 2. Mock AI Content Generation
                        if(this.worksheetTopic === 'History') {
                            this.worksheetVocab = ["Ancient", "Pyramid", "Pharaoh", "Empire"];
                            this.worksheetQuiz = [{question: "Pyramids are in...", a: "Egypt", b: "Mars"}, {question: "Kings were called...", a: "Presidents", b: "Pharaohs"}];
                        } else if (this.worksheetTopic.includes('Space')) {
                            this.worksheetVocab = ["Galaxy", "Orbit", "Gravity", "Comet"];
                            this.worksheetQuiz = [{question: "The sun is a...", a: "Planet", b: "Star"}, {question: "Humans live on...", a: "Earth", b: "Moon"}];
                        } else {
                            this.worksheetVocab = ["Learn", "Explore", "Study", "Fun"];
                            this.worksheetQuiz = [{question: "Learning is...", a: "Fun", b: "Boring"}, {question: "We use our...", a: "Brain", b: "Elbow"}];
                        }

                        setTimeout(() => {
                            this.isLoading = false;
                            window.print(); // Trigger browser print dialog
                        }, 2000);

                    } catch(e) {
                        this.isLoading = false;
                        alert("Could not generate worksheet.");
                    }
                },

                // --- CORE INTERACTION ---
                toggleScroll(disable) {
                    document.body.classList.toggle('no-scroll', disable);
                },
                
                openParentPortal() {
                    this.showParentPortal = true;
                    this.parentAuthenticated = false;
                    this.pinInput = '';
                    this.toggleScroll(true);
                },
                
                closeParentPortal() {
                    this.showParentPortal = false;
                    this.toggleScroll(false);
                },
                
                verifyPin() {
                    if (this.isChangingPin) {
                        if (this.pinInput.length === 4) {
                            this.masterPin = this.pinInput;
                            let data = JSON.parse(localStorage.getItem('user_' + this.registeredEmail));
                            data.pin = this.masterPin;
                            localStorage.setItem('user_' + this.registeredEmail, JSON.stringify(data));
                            alert("PIN updated!");
                            this.isChangingPin = false;
                            this.parentAuthenticated = true;
                            this.pinInput = '';
                        }
                    } else if (this.pinInput === this.masterPin) {
                        this.parentAuthenticated = true;
                    } else {
                        this.pinInput = '';
                        alert("Incorrect PIN");
                    }
                },

                startPinChange() {
                    this.parentAuthenticated = false;
                    this.isChangingPin = true;
                    this.pinInput = '';
                },

                // --- EXISTING GAME LOGIC ---
                trySetChar(char) {
                    if (char.premium && !this.isPremium) return this.showPremiumModal = true;
                    this.currentChar = char;
                    this.currentMoodIcon = char.icon;
                    this.displayText = `Hello ${this.childProfile.name}! I'm ${char.name}.`;
                    this.suggestions = char.suggestions;
                    this.hasAnswered = false;
                },

                async askTutor() {
                    if (!this.userQuery.trim()) return;
                    if (!this.isPremium && this.dailyQuestionsUsed >= this.maxFreeQuestions) {
                         this.showPremiumModal = true;
                         return;
                    }
                    
                    const q = this.userQuery;
                    this.userQuery = '';
                    this.isThinking = true;
                    this.displayText = "Thinking... üß†";
                    
                    // Simple Stats Tracking
                    this.parentLogs.push({ query: q, time: new Date().toLocaleString(), char: this.currentChar.name });
                    if(q.toLowerCase().includes('history')) this.learningStats.subjects.history += 10;
                    
                    try {
                        setTimeout(() => {
                            this.displayText = `That's a great question about ${q}! As ${this.currentChar.name}, I'd say... [AI Answer]. Did you know...`;
                            this.isThinking = false;
                            this.hasAnswered = true;
                            this.xp += 10;
                            if(!this.isPremium) this.dailyQuestionsUsed++;
                            this.updateLevel();
                            this.playPing();
                            this.syncData();
                        }, 1500);
                    } catch(e) { this.isThinking = false; }
                },

                generateArt() {
                    if(!this.userQuery) return alert("Type something to draw!");
                    this.showArtModal = true;
                    this.isDrawing = true;
                    this.artImage = null;
                    const prompt = encodeURIComponent(this.userQuery + ", simple coloring page");
                    setTimeout(() => {
                        this.artImage = `https://image.pollinations.ai/prompt/${prompt}?nologo=true&model=flux&width=512&height=512&seed=${Math.floor(Math.random()*1000)}&safe=true`;
                        this.isDrawing = false;
                    }, 2000);
                },
                
                downloadArt() {
                    if(this.artImage) {
                        const a = document.createElement('a');
                        a.href = this.artImage;
                        a.download = 'art.jpg';
                        a.target = '_blank';
                        a.click();
                    }
                },

                startQuiz() {
                    this.showQuiz = true;
                    this.quizState = 'active';
                    this.quizQuestion = "Mock Quiz Question?";
                    this.quizOptions = ["Answer A", "Answer B", "Answer C"];
                    this.quizCorrectIndex = 0;
                },

                checkAnswer(index) {
                    if(index === this.quizCorrectIndex) {
                        this.quizState = 'correct';
                        this.coins += 20;
                        this.xp += 20;
                        this.syncData();
                    } else {
                        this.quizState = 'wrong';
                    }
                },

                claimReward() {
                    this.coins += 50;
                    this.rewardClaimedToday = true;
                    this.syncData();
                    confetti();
                },
                
                buyItem(item) {
                    if(this.coins >= item.price) {
                        this.coins -= item.price;
                        this.inventory.push(item.id);
                        this.syncData();
                    }
                },
                
                toggleEquip(id) {
                    this.equippedItem = (this.equippedItem === id) ? null : id;
                    this.syncData();
                },
                
                getEquippedItemData() {
                    return this.shopItems.find(i => i.id === this.equippedItem) || {};
                },

                startListening() {
                    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                    if(!SR) return alert("Not supported");
                    const r = new SR();
                    r.onstart = () => this.isListening = true;
                    r.onend = () => this.isListening = false;
                    r.onresult = (e) => { this.userQuery = e.results[0][0].transcript; this.askTutor(); };
                    r.start();
                },
                
                speak(text) {
                    const u = new SpeechSynthesisUtterance(text);
                    u.pitch = this.currentChar.pitch;
                    u.rate = this.currentChar.rate;
                    u.onstart = () => this.isSpeaking = true;
                    u.onend = () => this.isSpeaking = false;
                    window.speechSynthesis.speak(u);
                },

                playPing() {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    osc.connect(ctx.destination);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.1);
                },

                saveChildProfile() {
                    this.isEditingProfile = false;
                    this.syncData();
                },

                get journeyProgress() {
                    if (this.xp < 1000) return (this.xp / 1000) * 33; 
                    if (this.xp < 3000) return 33 + ((this.xp - 1000) / 2000) * 33;
                    return 66 + ((this.xp - 3000) / 2000) * 34;
                },
                
                getTopSubjects() {
                    const requiredKeys = ['history', 'robots', 'space', 'science', 'nature'];
                    const displayNames = {
                        history: 'History',
                        robots: 'Robots and AI',
                        space: 'Space Exploration',
                        science: 'Science',
                        nature: 'Nature'
                    };
                    let statsArray = requiredKeys.map(key => {
                        const score = this.learningStats.subjects[key] || 0;
                        return [displayNames[key], score];
                    });
                    statsArray.sort((a, b) => b[1] - a[1]);
                    return statsArray.reduce((obj, [name, score]) => {
                        obj[name] = score;
                        return obj;
                    }, {});
                },

                getSubjectColor(subject) {
                    const colors = {
                        'History': 'bg-orange-500',
                        'Robots and AI': 'bg-blue-600',
                        'Space Exploration': 'bg-purple-600',
                        'Science': 'bg-pink-500',
                        'Nature': 'bg-green-500'
                    };
                    return colors[subject] || 'bg-gray-500';
                },
                
                updateLevel() {
                    this.level = Math.floor(this.xp / 100) + 1;
                },
                
                processPayment() {
                    this.showPremiumModal = false;
                    this.showCheckout = true;
                },
                
                cancelSubscription() {
                    if(confirm("Cancel premium?")) {
                        this.isPremium = false;
                        this.syncData();
                    }
                },
                
                clearLogs() {
                    if(confirm("Clear history?")) {
                        this.parentLogs = [];
                        this.syncData();
                    }
                }
            }
        }
    </script>
</body>
</html>
