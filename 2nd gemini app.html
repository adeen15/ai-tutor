<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Tutor - Animated Friends</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI Tutor">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1998/1998614.png">
    
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <style>
        [x-cloak] { display: none !important; }

        body {
            font-family: 'Quicksand', sans-serif;
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            display: block;   
            transition: background 0.5s ease;
            overscroll-behavior-y: none;
        }

        @media (min-width: 640px) {
            .no-scroll-desktop {
                overflow: hidden !important;
                height: 100vh;
                position: fixed;
                width: 100%;
            }
        }
        
        html { scroll-behavior: smooth; }
        .font-kids { font-family: 'Fredoka One', cursive; }
        
        .chat-bubble {
            position: relative;
            background: white;
            border-radius: 40px;
            box-shadow: 0 30px 60px -12px rgba(0,0,0,0.15);
            border: 6px solid white;
        }

        /* --- ANIMATIONS --- */
        .char-float { animation: floating 5s ease-in-out infinite; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1)); z-index: 10; }
        @keyframes floating { 0%, 100% { transform: translateY(0px) rotate(-2deg); } 50% { transform: translateY(-30px) rotate(3deg); } }

        .wiggle-speak { animation: wiggle 0.4s ease-in-out infinite; }
        @keyframes wiggle { 0%, 100% { transform: scale(1.1) rotate(0deg); } 25% { transform: scale(1.1) rotate(3deg); } 75% { transform: scale(1.1) rotate(-3deg); } }

        .effect-glow { filter: drop-shadow(0 0 40px gold) drop-shadow(0 0 10px orange); animation: pulse-glow 2s infinite; }
        @keyframes pulse-glow { 0%, 100% { filter: drop-shadow(0 0 40px gold) drop-shadow(0 0 10px orange); } 50% { filter: drop-shadow(0 0 60px #fff700) drop-shadow(0 0 20px #ff9100); } }

        .sparkle-particle { position: absolute; animation: twinkle 2s ease-in-out infinite; }
        @keyframes twinkle { 0%, 100% { transform: scale(0) rotate(0deg); opacity: 0; } 50% { transform: scale(1.2) rotate(180deg); opacity: 1; } }

        .firefly-particle { position: absolute; width: 10px; height: 10px; background: #bef264; border-radius: 50%; box-shadow: 0 0 10px #bef264, 0 0 20px #bef264; animation: fly-around 4s ease-in-out infinite; }
        @keyframes fly-around { 0% { transform: translate(0, 0) scale(1); opacity: 0.8; } 33% { transform: translate(30px, -30px) scale(1.2); } 66% { transform: translate(-20px, 20px) scale(0.8); } 100% { transform: translate(0, 0) scale(1); opacity: 0.8; } }

        .orbit-container { position: absolute; inset: -40px; animation: spin-orbit 8s linear infinite; }
        .star-item { position: absolute; animation: counter-spin 8s linear infinite; }
        @keyframes spin-orbit { 100% { transform: rotate(360deg); } }
        @keyframes counter-spin { 100% { transform: rotate(-360deg); } }

        .dust-particle { position: absolute; bottom: 0; animation: float-up 3s linear infinite; }
        @keyframes float-up { 0% { transform: translateY(20px) scale(0.5); opacity: 0; } 20% { opacity: 1; } 100% { transform: translateY(-150px) scale(1.5) rotate(45deg); opacity: 0; } }

        /* --- UI ELEMENTS --- */
        .btn-grad { transition: 0.5s; background-size: 200% auto; }
        .btn-grad:hover { background-position: right center; }
        
        .char-btn { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; }
        .char-btn:hover { transform: scale(1.2); }
        .char-btn.active { transform: scale(1.3); border-color: white; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
        
        .char-locked { filter: grayscale(100%); opacity: 0.7; }
        .lock-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; }

        .mic-active { animation: pulse-red 1.5s infinite; color: #ef4444 !important; }
        @keyframes pulse-red { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }

        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }

        .premium-glow { animation: glow-gold 2s infinite; }
        @keyframes glow-gold { 0% { box-shadow: 0 0 5px #ffd700; } 50% { box-shadow: 0 0 20px #ffd700, 0 0 10px #ffea00; } 100% { box-shadow: 0 0 5px #ffd700; } }

        .gift-bounce { animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }

        .safe-badge { background: #10b981; color: white; padding: 4px 10px; border-radius: 99px; font-size: 8px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 4px; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); width: fit-content; }

        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #3b82f6; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- NEW STYLES FOR LEARNING MAP --- */
        .level-connector { position: absolute; width: 4px; background-color: #e5e7eb; left: 50%; transform: translateX(-50%); z-index: 0; }
        .bounce { animation: bounce 2s infinite; }

        /* Certificate Styles */
        .certificate-border { border: 20px solid #f59e0b; border-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h40v40H0z' fill='none'/%3E%3Cpath d='M20 0l5 15h15l-12 9 4 16-12-9-12 9 4-16-12-9h15z' fill='%23f59e0b'/%3E%3C/svg%3E") 30; }

        @media (max-width: 640px) {
            .daily-reward-btn { padding: 0.5rem !important; width: 52px; height: 52px; }
            .daily-reward-btn span.gift-bounce { font-size: 1.25rem !important; }
            .daily-reward-btn span.text-pink-500 { font-size: 7px !important; }
            .safe-badge { font-size: 7px; padding: 2px 8px; }
        }

        @media print {
            body * { visibility: hidden; }
            #printable-art, #printable-art *, #worksheet-print-area, #worksheet-print-area *, #certificate-area, #certificate-area * { visibility: visible; }
            #printable-art { position: fixed; left: 0; top: 0; width: 100%; height: 100%; object-fit: contain; z-index: 9999; }
            #worksheet-print-area { position: absolute; left: 0; top: 0; width: 100%; padding: 40px; background: white; color: black; }
            #certificate-area { position: fixed; left: 0; top: 0; width: 100%; height: 100%; background: white; display: flex !important; }
            .fixed, .absolute, .bg-black, .bg-slate-900, .bg-slate-50 { background: none !important; box-shadow: none !important; }
        }
    </style>
</head>
<body x-data="aiTutor()" 
      :style="'background: ' + currentChar.bg"
      :class="!isLoggedIn ? 'no-scroll-desktop' : ''">

    <div x-show="isLoading" class="fixed inset-0 z-[200] bg-white/80 flex items-center justify-center backdrop-blur-sm" x-transition>
        <div class="flex flex-col items-center">
            <div class="spinner mb-4"></div>
            <p class="font-kids text-blue-500">Syncing magic...</p>
        </div>
    </div>

    <div id="certificate-area" class="hidden flex-col items-center justify-center p-12 text-center bg-white certificate-border" style="min-height: 100vh;">
        <div class="text-6xl mb-4">üéì</div>
        <h1 class="text-5xl font-kids text-amber-600 mb-2">Certificate of Achievement</h1>
        <p class="text-2xl text-gray-600 mb-8">This award is proudly presented to</p>
        <h2 class="text-6xl font-kids text-slate-800 mb-8 underline" x-text="childProfile.name"></h2>
        <p class="text-xl text-gray-500 max-w-2xl mx-auto leading-relaxed">
            For successfully completing the <span class="font-bold text-slate-800" x-text="selectedCertificatePath?.name"></span> 
            adventure path and showing incredible curiosity and brilliance in learning!
        </p>
        <div class="mt-16 flex justify-between w-full max-w-3xl px-12">
            <div class="text-center">
                <div class="border-b-2 border-gray-400 w-48 mb-2"></div>
                <p class="font-bold text-gray-400 uppercase">Your Teacher</p>
            </div>
            <div class="text-center">
                <div class="border-b-2 border-gray-400 w-48 mb-2"></div>
                <p class="font-bold text-gray-400 uppercase">Date</p>
            </div>
        </div>
        <div class="mt-12 text-4xl">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
    </div>

    <div id="worksheet-print-area" class="hidden">
        <div style="border: 4px solid black; padding: 20px;">
            <h1 style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">AI Tutor: Learning Worksheet</h1>
            <p><strong>Student Name:</strong> <span x-text="childProfile.name"></span> ____________________</p>
            <p><strong>Date:</strong> ____________________</p>
            <hr style="margin: 20px 0;">
            <h2 style="font-size: 24px;">Topic of the Day: <span x-text="currentChar.subject"></span></h2>
            <div style="margin-top: 30px; height: 300px; border: 1px dashed gray; padding: 10px; text-align: center;">
                <p style="color: gray;">Draw a picture about <span x-text="currentChar.subject"></span> here!</p>
            </div>
            <div style="margin-top: 40px;">
                <h3 style="font-size: 20px;">Writing Challenge:</h3>
                <p style="margin-bottom: 20px;">Can you write two fun facts you learned today?</p>
                <div style="border-bottom: 1px solid black; height: 40px;"></div>
                <div style="border-bottom: 1px solid black; height: 40px; margin-top: 10px;"></div>
            </div>
            <div style="margin-top: 40px; text-align: center;">
                <p>Great Job! ‚≠ê You earned 100 bonus coins!</p>
            </div>
        </div>
    </div>

    <div x-show="!isLoggedIn" class="fixed inset-0 z-[100] bg-white sm:bg-gradient-to-br sm:from-blue-400 sm:to-purple-600 overflow-y-auto overflow-x-hidden sm:overflow-hidden sm:flex sm:items-center sm:justify-center transition-all duration-700">
        <div class="min-h-full w-full p-0 sm:p-4 block sm:flex sm:items-center sm:justify-center">
            <div class="bg-white m-0 w-full min-w-full sm:min-w-0 min-h-screen sm:min-h-0 sm:rounded-[2rem] p-6 sm:p-12 sm:max-w-md shadow-2xl text-center relative overflow-hidden animate__animated animate__zoomIn sm:my-8 sm:border-8 border-white/20">
                
                <div class="absolute top-0 left-0 w-32 h-32 bg-yellow-300 rounded-full blur-3xl opacity-50 -translate-x-1/2 -translate-y-1/2"></div>
                <div class="absolute bottom-0 right-0 w-32 h-32 bg-pink-300 rounded-full blur-3xl opacity-50 translate-x-1/2 translate-y-1/2"></div>

                <div class="relative z-10">
                    <div class="text-6xl mb-4 animate__animated animate__bounceIn delay-500">üéì</div>
                    <h1 class="text-4xl font-kids text-slate-800 mb-2">AI Tutor</h1>
                    <p class="text-slate-500 font-bold mb-8">Parent Setup & Login</p>

                    <div x-show="!hasAccount" class="space-y-4 text-left">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1 ml-2">Parent Full Name</label>
                            <input type="text" x-model="loginForm.name" placeholder="Jane Doe" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl focus:border-blue-500 focus:bg-white outline-none font-bold text-slate-700 transition-all text-base">
                        </div>

                        <div class="animate__animated animate__fadeIn">
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 ml-2">Child's Age (Auto-Adjusts Difficulty)</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button @click="loginForm.ageRange = '4-5'" 
                                        :class="loginForm.ageRange === '4-5' ? 'bg-blue-500 text-white border-blue-600 shadow-md ring-2 ring-blue-200' : 'bg-slate-50 text-slate-400 border-slate-200 hover:bg-slate-100'"
                                        class="p-2 sm:p-3 rounded-2xl border-2 font-bold transition-all text-xs sm:text-sm flex flex-col items-center justify-center">
                                    <span class="text-lg">üê£</span>
                                    <span>4-5</span>
                                </button>
                                <button @click="loginForm.ageRange = '6-7'" 
                                        :class="loginForm.ageRange === '6-7' ? 'bg-blue-500 text-white border-blue-600 shadow-md ring-2 ring-blue-200' : 'bg-slate-50 text-slate-400 border-slate-200 hover:bg-slate-100'"
                                        class="p-2 sm:p-3 rounded-2xl border-2 font-bold transition-all text-xs sm:text-sm flex flex-col items-center justify-center">
                                    <span class="text-lg">üéí</span>
                                    <span>6-7</span>
                                </button>
                                <button @click="loginForm.ageRange = '8-9'" 
                                        :class="loginForm.ageRange === '8-9' ? 'bg-blue-500 text-white border-blue-600 shadow-md ring-2 ring-blue-200' : 'bg-slate-50 text-slate-400 border-slate-200 hover:bg-slate-100'"
                                        class="p-2 sm:p-3 rounded-2xl border-2 font-bold transition-all text-xs sm:text-sm flex flex-col items-center justify-center">
                                    <span class="text-lg">üöÄ</span>
                                    <span>8-9</span>
                                </button>
                            </div>
                            <p class="text-[10px] text-center mt-2 text-slate-400 font-bold" x-show="loginForm.ageRange === '4-5'">Simple words. Slow pacing. Lots of emojis.</p>
                            <p class="text-[10px] text-center mt-2 text-slate-400 font-bold" x-show="loginForm.ageRange === '6-7'">Standard vocabulary. Fun facts. Balanced quizzes.</p>
                            <p class="text-[10px] text-center mt-2 text-slate-400 font-bold" x-show="loginForm.ageRange === '8-9'">Advanced topics. Critical thinking. Harder quizzes.</p>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1 ml-2">Email Address</label>
                            <input type="email" x-model="loginForm.email" placeholder="parent@email.com" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl focus:border-blue-500 focus:bg-white outline-none font-bold text-slate-700 transition-all text-base">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1 ml-2">Create Secret PIN (4 Digits)</label>
                            <input type="tel" maxlength="4" x-model="loginForm.pin" placeholder="****" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl focus:border-blue-500 focus:bg-white outline-none font-bold text-slate-700 text-center text-2xl tracking-[0.5em] transition-all">
                            <p class="text-[10px] text-slate-400 mt-1 ml-2">Use this PIN to access Parent Dashboard later.</p>
                        </div>
                        
                        <div class="mt-4 p-4 bg-slate-50 rounded-2xl border-2 border-slate-100">
                            <label class="flex items-start gap-3 cursor-pointer">
                                <input type="checkbox" x-model="legalAccepted" class="mt-1 w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="text-[10px] font-bold text-slate-500 leading-tight uppercase">
                                    I confirm I am the parent/guardian and agree to the 
                                    <a href="#" @click.prevent="showLegalDoc = 'privacy'" class="text-blue-500 underline">Privacy Policy</a> & 
                                    <a href="#" @click.prevent="showLegalDoc = 'terms'" class="text-blue-500 underline">Terms</a>. 
                                    I consent to kid-safe AI processing (COPPA/GDPR).
                                </span>
                            </label>
                        </div>

                        <button @click="handleSignup" :disabled="!legalAccepted" class="w-full py-4 bg-blue-500 hover:bg-blue-600 text-white rounded-2xl font-kids text-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all mt-4 disabled:opacity-50 disabled:grayscale">
                            Start Learning! üöÄ
                        </button>
                        
                        <div class="flex items-center justify-center gap-2 mt-3 opacity-80">
                             <i class="fas fa-shield-alt text-green-500"></i>
                             <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">No data sold. 100% Private.</p>
                        </div>

                        <div class="mt-6 grid grid-cols-2 gap-2 text-left animate__animated animate__fadeInUp delay-500">
                            <div class="bg-blue-50 p-2 rounded-lg border border-blue-100 flex items-center gap-2">
                                <i class="fas fa-check-circle text-blue-500 text-xs"></i>
                                <span class="text-[10px] font-bold text-slate-600 leading-tight">Curriculum Aligned</span>
                            </div>
                            <div class="bg-blue-50 p-2 rounded-lg border border-blue-100 flex items-center gap-2">
                                 <i class="fas fa-lock text-blue-500 text-xs"></i>
                                <span class="text-[10px] font-bold text-slate-600 leading-tight">No Open Internet</span>
                            </div>
                            <div class="bg-blue-50 p-2 rounded-lg border border-blue-100 flex items-center gap-2">
                                 <i class="fas fa-user-shield text-blue-500 text-xs"></i>
                                <span class="text-[10px] font-bold text-slate-600 leading-tight">Teacher Reviewed</span>
                            </div>
                            <div class="bg-green-100 p-2 rounded-lg border border-green-200 flex items-center gap-2">
                                 <i class="fas fa-shield-alt text-green-600 text-xs"></i>
                                <span class="text-[10px] font-bold text-green-700 leading-tight">Safe Mode ON</span>
                            </div>
                        </div>
                        
                        <p class="text-center mt-4 text-xs font-bold text-gray-400 cursor-pointer hover:text-blue-500" @click="hasAccount = true">Already have an account? Login</p>
                    </div>

                    <div x-show="hasAccount" class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-2xl border-2 border-blue-100">
                            <p class="text-sm text-blue-400 font-bold uppercase tracking-wide">Welcome Back</p>
                            <input type="email" x-model="loginForm.email" placeholder="Enter parent email" class="w-full mt-2 p-2 bg-white border border-blue-200 rounded-xl focus:outline-none text-center font-bold text-slate-700 text-base">
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Enter Your 4-Digit PIN</label>
                            <input type="password" maxlength="4" x-model="loginForm.pin" @keyup.enter="handleLogin" placeholder="****" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl focus:border-blue-500 outline-none font-bold text-slate-700 text-center text-3xl tracking-[0.5em]">
                        </div>

                        <button @click="handleLogin" class="w-full py-4 bg-green-500 hover:bg-green-600 text-white rounded-2xl font-kids text-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all">
                            Unlock App üîì
                        </button>
                        
                        <button @click="hasAccount = false" class="text-xs text-blue-400 hover:text-blue-600 font-bold uppercase tracking-widest mt-4">Create New Account</button>
                    </div>

                    <div class="mt-8 p-4 bg-slate-50 rounded-2xl border-2 border-slate-200 text-center">
                        <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Legal & Privacy</h3>
                        <div class="flex justify-center gap-6">
                            <button @click="showLegalDoc = 'privacy'" class="text-blue-500 font-bold text-[10px] hover:underline uppercase tracking-widest">Privacy Policy</button>
                            <button @click="showLegalDoc = 'terms'" class="text-blue-500 font-bold text-[10px] hover:underline uppercase tracking-widest">Terms of Service</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="absolute top-4 left-4 z-40 flex flex-col gap-3">
        <button @click="showRewards = true; toggleScroll(true)" class="daily-reward-btn bg-white p-3 sm:p-4 rounded-2xl shadow-lg hover:scale-110 transition-transform border-b-4 border-pink-400 flex flex-col items-center justify-center">
            <span class="text-2xl sm:text-3xl gift-bounce">üéÅ</span>
            <span class="text-[10px] font-bold text-pink-500 uppercase">Daily Gift</span>
        </button>
        <div class="safe-badge animate__animated animate__fadeInLeft">
            <i class="fas fa-shield-alt"></i> Kid-Safe AI
        </div>
    </div>

    <div class="absolute top-4 right-4 flex flex-row items-center justify-end gap-2 sm:gap-4 z-40">
        <div x-show="!isPremium" class="hidden md:block bg-white px-4 py-2 rounded-xl shadow-lg border-2 border-orange-400">
            <p class="text-[10px] font-bold text-orange-600 uppercase text-center">
                Free Questions <span x-text="'(' + dailyQuestionsUsed + '/' + maxFreeQuestions + ')'"></span>
            </p>
            <div class="w-20 h-2 bg-gray-100 rounded-full mt-1 overflow-hidden">
                <div class="h-full bg-orange-400 transition-all duration-500" :style="'width: ' + ((maxFreeQuestions - dailyQuestionsUsed) / maxFreeQuestions * 100) + '%'"></div>
            </div>
        </div>

        <div class="bg-white p-2 sm:p-4 rounded-2xl shadow-lg border-b-4 border-gray-400 flex items-center gap-1 sm:gap-2">
            <span class="text-xl sm:text-3xl">üí∞</span>
            <span class="font-kids text-lg sm:text-2xl text-yellow-700" x-text="coins"></span>
        </div>

        <button @click="showLearningPath = true; toggleScroll(true)" class="bg-white p-3 sm:p-4 rounded-2xl shadow-lg hover:scale-110 transition-transform border-b-4 border-green-500">
            <span class="text-xl sm:text-3xl">üó∫Ô∏è</span>
        </button>

        <button @click="showShop = true; toggleScroll(true)" class="bg-white p-3 sm:p-4 rounded-2xl shadow-lg hover:scale-110 transition-transform border-b-4 border-blue-400">
            <span class="text-xl sm:text-3xl">ü™Ñ</span>
        </button>

        <button @click="openParentPortal()" class="bg-white p-3 sm:p-4 rounded-2xl shadow-lg hover:scale-110 transition-transform border-b-4 border-gray-400">
            <span class="text-xl sm:text-2xl">üîí</span>
        </button>
    </div>

    <div class="container max-w-6xl mx-auto px-4 pt-28 sm:pt-12 pb-8 sm:pb-12">
        <div class="flex justify-center gap-2 sm:gap-4 mb-6 sm:mb-8">
            <template x-for="char in characters">
                <button 
                    @click="trySetChar(char)"
                    class="char-btn w-14 h-14 sm:w-16 sm:h-16 md:w-20 md:h-20 rounded-full bg-white flex items-center justify-center text-3xl sm:text-4xl border-4 border-transparent shadow-lg"
                    :class="{
                        'active border-white': currentChar.name === char.name, 
                        'opacity-60': currentChar.name !== char.name && (!char.premium || isPremium),
                        'char-locked': char.premium && !isPremium
                    }"
                >
                    <span x-text="char.icon"></span>
                    <div x-show="char.premium && !isPremium" class="lock-overlay">
                        <i class="fas fa-lock"></i>
                    </div>
                </button>
            </template>
        </div>

        <div class="text-center mb-6 sm:mb-10">
            <h1 class="text-4xl sm:text-5xl lg:text-6xl font-kids drop-shadow-lg tracking-wider animate__animated animate__bounceInDown"
                :style="'color: ' + currentChar.accent"
                x-text="currentChar.name">
            </h1>
            <p class="font-bold text-base sm:text-lg md:text-xl mt-3 opacity-80" :style="'color: ' + currentChar.accent" x-text="'Teacher of ' + currentChar.subject + ' ‚ú®'"></p>
        </div>

        <div class="flex flex-col lg:flex-row items-center justify-center lg:justify-between gap-10 sm:gap-8 lg:gap-12">
            
            <div class="relative flex flex-col items-center order-2 lg:order-1">
                
                <div class="relative char-float select-none cursor-pointer transition-all duration-300" 
                     :class="[isSpeaking ? 'wiggle-speak' : '', getEquippedItemData().effectType === 'glow' ? 'effect-glow' : '']">
                     
                     <template x-if="getEquippedItemData().effectType === 'sparkles'">
                         <div class="absolute inset-0 pointer-events-none">
                            <template x-for="i in 6">
                                <div class="sparkle-particle text-yellow-400 text-4xl"
                                     :style="'top: ' + (Math.random() * 100) + '%; left: ' + (Math.random() * 100) + '%; animation-delay: ' + (Math.random() * 2) + 's'">
                                     ‚ú®
                                </div>
                            </template>
                         </div>
                     </template>

                     <template x-if="getEquippedItemData().effectType === 'fireflies'">
                        <div class="absolute inset-0 pointer-events-none">
                           <template x-for="i in 5">
                               <div class="firefly-particle"
                                    :style="'top: ' + (Math.random() * 80 + 10) + '%; left: ' + (Math.random() * 80 + 10) + '%; animation-delay: ' + (Math.random() * 3) + 's'">
                               </div>
                           </template>
                        </div>
                    </template>

                    <template x-if="getEquippedItemData().effectType === 'stars'">
                        <div class="orbit-container pointer-events-none">
                            <div class="star-item text-4xl text-yellow-300" style="top: 0; left: 50%; transform: translateX(-50%);">‚≠ê</div>
                            <div class="star-item text-3xl text-yellow-400" style="bottom: 10%; left: 10%;">‚≠ê</div>
                            <div class="star-item text-3xl text-yellow-400" style="bottom: 10%; right: 10%;">‚≠ê</div>
                        </div>
                    </template>

                    <template x-if="getEquippedItemData().effectType === 'dust'">
                        <div class="absolute inset-0 pointer-events-none overflow-visible">
                           <template x-for="i in 8">
                               <div class="dust-particle text-blue-300 text-2xl"
                                    :style="'left: ' + (Math.random() * 100) + '%; animation-delay: ' + (Math.random() * 2) + 's; animation-duration: ' + (2 + Math.random()) + 's'">
                                    ü™Ñ
                               </div>
                           </template>
                        </div>
                    </template>

                     <div class="text-[6rem] sm:text-[9rem] md:text-[12rem] lg:text-[15rem]" x-text="currentMoodIcon"></div>
                </div>
                
                <div x-show="isThinking" class="absolute -top-8 left-8 sm:-top-10 sm:left-10 animate__animated animate__fadeIn">
                    <div class="bg-white rounded-full px-4 py-2 shadow-lg flex flex-col items-center gap-1">
                        <div x-show="isPremium" class="text-[8px] font-bold text-amber-500 uppercase mb-1">Priority AI Processing</div>
                        <div class="flex gap-2">
                            <div class="w-3 h-3 rounded-full animate-bounce" :style="'background: ' + currentChar.accent"></div>
                            <div class="w-3 h-3 rounded-full animate-bounce" style="animation-delay: 0.2s; background: #ff512f"></div>
                            <div class="w-3 h-3 rounded-full animate-bounce" style="animation-delay: 0.4s; background: #24d4dd"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="w-full max-w-2xl order-1 lg:order-2">
                <div class="chat-bubble p-6 sm:p-8 md:p-10 mb-8 min-h-[180px] sm:min-h-[220px] flex flex-col justify-between transition-all duration-500"
                     :style="'border-color: ' + currentChar.accent">
                    <div>
                        <span class="font-kids text-base sm:text-lg uppercase tracking-widest block mb-2" :style="'color: ' + currentChar.accent" x-text="currentChar.name + ' says:'"></span>
                        <p class="text-xl sm:text-2xl md:text-3xl text-gray-800 font-semibold leading-relaxed" x-text="displayText"></p>
                    </div>
                    
                    <div class="flex flex-wrap justify-end gap-3 mt-6" x-show="hasAnswered && !isThinking">
                        <button 
                            @click="startQuiz()"
                            class="flex items-center gap-2 px-5 py-3 rounded-2xl font-kids text-base sm:text-lg transition-all transform hover:scale-110 active:scale-95 border-b-4 bg-yellow-400 border-yellow-600 text-yellow-900 shadow-md"
                        >
                            <span class="text-xl">üèÜ</span> Challenge Me!
                        </button>

                        <button 
                            @click="speak(displayText)"
                            class="flex items-center gap-3 px-5 sm:px-6 py-2 sm:py-3 rounded-2xl font-kids text-base sm:text-lg transition-all transform hover:scale-110 active:scale-95 border-b-4"
                            :style="'background: ' + currentChar.accent + '22; color: ' + currentChar.accent + '; border-color: ' + currentChar.accent + '44'"
                        >
                            <i class="fas" :class="isSpeaking ? 'fa-pause-circle' : 'fa-play-circle'"></i>
                            <span x-text="isSpeaking ? 'Stop' : 'Listen'"></span>
                        </button>
                    </div>
                </div>

                <div class="relative bg-white rounded-3xl shadow-2xl p-2 sm:p-3 border-4 transition-all flex items-center gap-2 sm:gap-4 pr-2 sm:pr-3"
                     :style="'border-color: ' + currentChar.accent + '44'">
                    
                    <button 
                        @click="startListening()"
                        class="ml-2 sm:ml-4 text-2xl transition-all hover:scale-110"
                        :class="isListening ? 'mic-active' : 'text-gray-400'"
                        :style="!isListening ? 'color: ' + currentChar.accent : ''"
                    >
                        <i class="fas fa-microphone"></i>
                    </button>

                    <input 
                        type="text" 
                        x-model="userQuery" 
                        @keyup.enter="askTutor()"
                        :placeholder="isListening ? 'Listening...' : 'Ask about ' + currentChar.subject + '...'" 
                        class="flex-1 bg-transparent px-2 py-3 sm:py-4 outline-none text-base sm:text-xl font-bold text-gray-700 min-w-0"
                    >
                    
                    <button 
                        @click="generateArt()"
                        class="ml-2 btn-grad text-white rounded-2xl px-3 py-2 sm:px-6 sm:py-2 font-kids text-xs sm:text-lg shadow-lg transform transition hover:scale-105 active:scale-90 whitespace-nowrap"
                        style="background: linear-gradient(to right, #ec4899, #8b5cf6)"
                    >
                        üé® Draw
                    </button>

                    <button 
                        @click="askTutor()"
                        class="btn-grad text-white rounded-2xl px-3 py-2 sm:px-6 sm:py-2 font-kids text-xs sm:text-lg shadow-lg transform transition hover:scale-105 active:scale-90 mr-1 sm:mr-0 whitespace-nowrap"
                        :style="'background: linear-gradient(to right, ' + currentChar.accent + ', #ff512f)'"
                    >
                        ASK! üöÄ
                    </button>
                    
                     <div class="absolute -bottom-6 left-0 right-0 flex justify-center opacity-70">
                         <span class="text-[9px] font-bold text-slate-400 flex items-center gap-1 bg-white/80 px-2 py-0.5 rounded-full shadow-sm">
                             <i class="fas fa-lock text-green-500"></i> Safe-Response Mode ON
                         </span>
                    </div>

                </div>

                <div class="mt-6 sm:mt-8 flex flex-wrap gap-2 sm:gap-3 justify-center">
                    <template x-for="q in suggestions">
                        <button 
                            @click="userQuery = q; askTutor()"
                            class="bg-white hover:bg-opacity-90 px-3 py-1.5 sm:px-5 sm:py-2 rounded-full text-xs sm:text-sm font-bold shadow-sm hover:shadow-md transition-all border-2"
                            :style="'color: ' + currentChar.accent + '; border-color: ' + currentChar.accent + '22'"
                            x-text="q">
                        </button>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <div x-show="showParentPortal" x-cloak
         class="fixed inset-0 z-[60] flex items-center justify-center p-0 sm:p-6 bg-slate-900 bg-opacity-95 overflow-y-auto"
         x-transition.opacity>
        
        <div x-show="!parentAuthenticated" class="bg-white rounded-3xl p-8 max-w-xs w-full text-center shadow-2xl animate__animated animate__fadeInUp my-auto">
            <h2 class="text-2xl font-kids text-gray-700 mb-2">Parents Only</h2>
            <p class="text-sm text-gray-500 mb-6" x-text="isChangingPin ? 'Enter NEW 4-digit PIN' : 'Enter PIN to see Dashboard'"></p>
            <input type="password" maxlength="4" x-model="pinInput" @keyup.enter="verifyPin" class="w-full text-center text-4xl tracking-[1em] font-bold border-b-4 border-gray-200 outline-none mb-8 focus:border-blue-500">
            <div class="flex gap-2">
                <button @click="closeParentPortal" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold">Cancel</button>
                <button @click="verifyPin" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold" x-text="isChangingPin ? 'Save' : 'Open'"></button>
            </div>
        </div>

        <div x-show="parentAuthenticated" class="bg-slate-50 rounded-none sm:rounded-[2rem] w-full h-full sm:h-auto sm:max-h-[90vh] max-w-none sm:max-w-5xl flex flex-col shadow-2xl animate__animated animate__zoomIn overflow-hidden">
            
            <div class="bg-white p-6 sm:p-8 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl sm:text-3xl font-kids text-slate-800">Parent Dashboard</h2>
                    <p class="text-xs text-slate-400 font-bold uppercase tracking-widest mt-1">Overview for <span x-text="childProfile.name || 'Your Child'"></span></p>
                </div>
                <button @click="closeParentPortal" class="text-gray-400 hover:text-red-500 transition-colors text-2xl"><i class="fas fa-times-circle"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto custom-scroll p-6 sm:p-8">
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="font-bold text-slate-700 text-lg"><i class="fas fa-id-card text-blue-500 mr-2"></i>Child Profile</h3>
                            <button @click="isEditingProfile = !isEditingProfile" class="text-xs font-bold text-blue-500 uppercase hover:underline" x-text="isEditingProfile ? 'Save' : 'Edit'"></button>
                        </div>
                        
                        <div x-show="!isEditingProfile" class="space-y-3">
                            <div><p class="text-xs text-slate-400 font-bold uppercase">Name</p><p class="text-xl font-kids text-slate-800" x-text="childProfile.name"></p></div>
                            <div class="flex gap-6">
                                <div><p class="text-xs text-slate-400 font-bold uppercase">Age Group</p><p class="text-lg font-bold text-slate-700" x-text="(childProfile.ageRange || '6-7') + ' Years'"></p></div>
                                <div><p class="text-xs text-slate-400 font-bold uppercase">Difficulty</p><p class="text-lg font-bold text-slate-700" x-text="childProfile.ageRange === '4-5' ? 'Easy' : (childProfile.ageRange === '8-9' ? 'Advanced' : 'Standard')"></p></div>
                            </div>
                        </div>

                        <div x-show="isEditingProfile" class="space-y-3 animate__animated animate__fadeIn">
                            <input type="text" x-model="childProfile.name" class="w-full p-2 border rounded-xl bg-slate-50 font-bold text-sm" placeholder="Name">
                            <div>
                                <label class="text-xs text-slate-400 font-bold uppercase">Adjust Age Group</label>
                                <select x-model="childProfile.ageRange" class="w-full p-2 border rounded-xl bg-slate-50 font-bold text-sm mt-1">
                                    <option value="4-5">4-5 Years (Beginner)</option>
                                    <option value="6-7">6-7 Years (Standard)</option>
                                    <option value="8-9">8-9 Years (Advanced)</option>
                                </select>
                            </div>
                            <button @click="saveChildProfile()" class="w-full py-2 bg-blue-500 text-white rounded-xl text-sm font-bold mt-2">Update Profile</button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-slate-800 text-lg mb-4 flex items-center gap-2">
                            <i class="fas fa-shield-virus text-green-500"></i> AI Guardrails
                        </h3>
                        <div class="space-y-4">
                             <div class="flex items-start gap-3">
                                <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-500 mt-1 flex-shrink-0"><i class="fas fa-check"></i></div>
                                <div>
                                    <p class="text-xs font-bold text-slate-700 uppercase">Safety Active</p>
                                    <p class="text-[10px] text-slate-500 leading-tight">Content filtered for violence, politics, and mature themes.</p>
                                </div>
                             </div>
                             <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl border border-gray-100">
                                <div>
                                    <p class="text-xs font-bold text-slate-700">üìÖ Weekly Summary Email</p>
                                    <p class="text-[9px] text-gray-400">Receive a PDF report every Sunday.</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button @click="emailSummaryEnabled = !emailSummaryEnabled; syncData()" class="relative inline-flex h-5 w-10 items-center rounded-full transition-colors" :class="emailSummaryEnabled ? 'bg-green-500' : 'bg-gray-200'">
                                        <span class="inline-block h-3 w-3 transform rounded-full bg-white transition-transform" :class="emailSummaryEnabled ? 'translate-x-6' : 'translate-x-1'"></span>
                                    </button>
                                </div>
                             </div>
                             <button @click="alert('‚úâÔ∏è Sent a sample Weekly Summary to ' + registeredEmail + '!')" class="w-full text-[10px] font-bold text-blue-500 uppercase hover:underline text-right">Send Test Email Now</button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-3xl border border-blue-200">
                        <h3 class="font-bold text-blue-900 text-lg mb-4 flex items-center gap-2">
                            <i class="fas fa-tachometer-alt"></i> Daily Snapshot
                        </h3>
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <p class="text-3xl font-kids text-blue-600" x-text="dailyMinutes + 'm'"></p>
                                <p class="text-[10px] font-bold text-blue-400 uppercase">‚è± Active Today</p>
                            </div>
                            <div class="text-right">
                                <p class="text-3xl font-kids text-blue-600" x-text="Math.round(getTotalCurriculumProgress()) + '%'"></p>
                                <p class="text-[10px] font-bold text-blue-400 uppercase">üìä Total Progress</p>
                            </div>
                        </div>
                        <div class="w-full bg-white rounded-full h-2 mb-2">
                            <div class="bg-blue-500 h-2 rounded-full transition-all duration-1000" :style="'width: ' + getTotalCurriculumProgress() + '%'"></div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-slate-800 text-lg mb-4 flex items-center gap-2">
                            <i class="fas fa-brain text-purple-500"></i> AI Insights
                        </h3>
                        <div class="space-y-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600 text-xl">üí™</div>
                                <div>
                                    <p class="text-[10px] text-gray-400 font-bold uppercase">Top Strength</p>
                                    <p class="font-bold text-slate-700" x-text="getStrengths() || 'Keep playing to find out!'"></p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 text-xl">üß†</div>
                                <div>
                                    <p class="text-[10px] text-gray-400 font-bold uppercase">Focus Area</p>
                                    <p class="font-bold text-slate-700" x-text="getWeaknesses() || 'Needs more data'"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-slate-800 text-lg mb-4 flex items-center gap-2">
                            <i class="fas fa-book-open text-pink-500"></i> Topics Today
                        </h3>
                        <div class="flex flex-wrap gap-2">
                             <template x-for="topic in getDailyTopics()">
                                <span class="bg-pink-50 text-pink-600 px-3 py-1 rounded-full text-xs font-bold border border-pink-100" x-text="topic"></span>
                             </template>
                             <span x-show="getDailyTopics().length === 0" class="text-xs text-gray-400 italic">No topics explored yet today.</span>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-100">
                             <p class="text-[10px] text-gray-400 font-bold uppercase mb-2">Total Questions Asked</p>
                             <div class="flex items-center gap-2">
                                 <span class="text-2xl font-bold text-slate-700">‚ùì</span>
                                 <span class="text-xl font-bold text-slate-700" x-text="parentLogs.length"></span>
                             </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex flex-col h-64">
                    <div class="flex justify-between items-center mb-4">
                         <h3 class="font-bold text-slate-800 text-lg"><i class="fas fa-history text-gray-400 mr-2"></i>Recent Activity Log</h3>
                         <button @click="clearLogs" class="text-[10px] font-bold text-red-400 hover:text-red-600 uppercase">Clear History</button>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scroll pr-2 space-y-3">
                        <template x-for="log in parentLogs.slice().reverse().slice(0, 15)">
                            <div class="bg-gray-50 p-3 rounded-xl border-l-4 border-blue-400 flex justify-between items-center">
                                <div>
                                    <p class="text-slate-700 text-sm font-semibold" x-text="'‚ùì ' + log.query"></p>
                                    <p class="text-[10px] text-gray-400 font-bold mt-1" x-text="log.time"></p>
                                </div>
                                <span class="text-[9px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold uppercase whitespace-nowrap ml-2" x-text="log.char"></span>
                            </div>
                        </template>
                         <div x-show="parentLogs.length === 0" class="text-center text-gray-400 text-sm py-8">
                            No questions asked yet.
                        </div>
                    </div>
                </div>

                <div class="mt-8 pt-6 border-t flex flex-wrap justify-between items-center gap-4">
                    <button @click="startPinChange" class="text-blue-500 font-bold text-xs hover:underline uppercase tracking-widest">Change Parent PIN</button>
                    <button @click="closeParentPortal" class="bg-slate-800 text-white px-8 py-3 rounded-xl font-kids text-sm hover:bg-slate-700 transition-colors">Exit Dashboard</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("service-worker.js");
        }

        function aiTutor() {
            return {
                supabase: null,
                isLoading: false,
                isLoggedIn: false,
                hasAccount: false,
                savedProfile: null,
                // Default ageRange set to 6-7
                loginForm: { name: '', email: '', pin: '', ageRange: '6-7' },
                registeredEmail: '',
                
                legalAccepted: false,
                showLegalDoc: null,

                userQuery: '',
                displayText: "Hi friend! üåü I'm Professor Dino. I teach History! What do you want to know about the past?",
                isThinking: false,
                isSpeaking: false,
                isListening: false,
                hasAnswered: false,
                currentMoodIcon: 'ü¶ñ',
                suggestions: ["Who built the pyramids? üèúÔ∏è", "What is a mummy? ü§ï", "Who was the first king? üëë"],
                isPremium: false,
                premiumExpiry: null,
                showCheckout: false,
                checkoutForm: { name: '', card: '', expiry: '', cvv: '' },
                maxFreeQuestions: 5,
                dailyQuestionsUsed: 0,
                lastUsageDate: new Date().toDateString(),
                
                coins: 0, 
                
                showRewards: false,
                rewardClaimedToday: false,
                todayIndex: (new Date().getDay() + 6) % 7, 
                showPremiumModal: false,
                safetySettings: {
                    blockedWords: localStorage.getItem('blocked_words') || 'war, killing, blood, gun, scary',
                    forbiddenTopics: ['violence', 'horror', 'politics', 'death', 'crime']
                },
                
                // --- DASHBOARD STATE ---
                showParentPortal: false,
                parentAuthenticated: false,
                isChangingPin: false,
                pinInput: '',
                masterPin: '1234', 
                parentLogs: [],
                
                // FIXED: Default child profile
                childProfile: { name: '', age: '', grade: '', ageRange: '6-7' },
                totalMinutesLearned: 0,
                dailyMinutes: 0, // NEW: Tracks daily usage
                isEditingProfile: false,
                sessionStartTime: null,
                emailSummaryEnabled: false,

                // UPDATED: Stats specific to the 5 characters
                learningStats: {
                    wordsLearned: 0,
                    subjects: { 
                        history: 0, 
                        robots: 0, 
                        space: 0, 
                        science: 0, 
                        nature: 0 
                    },
                    // We will store child_profile here to avoid DB errors
                    child_profile: null 
                },
                xp: 0,
                level: 1,

                showShop: false,
                inventory: [],
                equippedItem: null,
                
                // --- QUIZ & ART STATES ---
                showQuiz: false,
                quizState: 'loading',
                quizQuestion: '',
                quizOptions: [],
                quizCorrectIndex: 0,

                showArtModal: false,
                isDrawing: false,
                artImage: null,

                // --- LEARNING PATH STATE ---
                showLearningPath: false,
                currentPath: null,
                activeLesson: null,
                lessonStep: 'learn', // learn, quiz, success
                currentLessonQuizIndex: 0,
                pathProgress: {}, // Stores completion per subject
                selectedCertificatePath: null,

                curriculum: [
                    { 
                        id: 'math', name: 'Math Geniuses', grade: 'Grade 2', icon: 'üßÆ', color: 'bg-blue-500', premium: false,
                        levels: [
                            { id: 1, title: 'Counting to 100', content: 'Numbers help us count toys! Can you count to 100? 1, 2, 3...', quiz: [{q: 'What comes after 9?', options:['8', '10', '11'], correct:1}, {q: 'Which number is biggest?', options:['5', '50', '2'], correct:1}, {q: '1 + 1 is?', options:['2', '3', '11'], correct:0}] },
                            { id: 2, title: 'Simple Adding', content: 'Adding means putting things together. 2 apples plus 2 apples makes 4!', quiz: [{q: '2 + 2 = ?', options:['3', '4', '5'], correct:1}, {q: '5 + 0 = ?', options:['5', '0', '50'], correct:0}, {q: '1 + 2 = ?', options:['2', '3', '4'], correct:1}] },
                            { id: 3, title: 'Shape Hunter', content: 'Shapes are everywhere! A ball is a circle. A box is a square.', quiz: [{q: 'A ball is a...', options:['Square', 'Circle', 'Triangle'], correct:1}, {q: 'A box has how many sides?', options:['2', '3', '4'], correct:2}, {q: 'Is a pizza round?', options:['Yes', 'No', 'Maybe'], correct:0}] },
                            { id: 4, title: 'Subtraction', content: 'Subtraction is taking away. If you have 3 cookies and eat 1, you have 2 left!', quiz: [{q: '3 - 1 = ?', options:['2', '1', '4'], correct:0}, {q: '5 - 5 = ?', options:['5', '1', '0'], correct:2}, {q: '10 - 1 = ?', options:['8', '9', '11'], correct:1}] },
                            { id: 5, title: 'Money Math', content: 'We use coins to buy things. A penny is 1 cent.', quiz: [{q: 'A penny is...', options:['1 cent', '5 cents', '10 cents'], correct:0}, {q: '2 pennies = ?', options:['2 cents', '5 cents', '100 cents'], correct:0}, {q: 'Is money for eating?', options:['Yes', 'No', 'Sometimes'], correct:1}] }
                        ]
                    },
                    { 
                        id: 'english', name: 'English ABCs', grade: 'Basics', icon: 'üìù', color: 'bg-green-500', premium: true,
                        levels: [
                            { id: 1, title: 'The Vowels', content: 'Vowels are special letters: A, E, I, O, U. Every word needs one!', quiz: [{q: 'Which is a vowel?', options:['B', 'E', 'Z'], correct:1}, {q: 'Is "K" a vowel?', options:['Yes', 'No', 'Maybe'], correct:1}, {q: 'How many vowels?', options:['3', '5', '10'], correct:1}] },
                            { id: 2, title: 'Rhyme Time', content: 'Rhyming words sound the same at the end. Cat, Hat, Bat!', quiz: [{q: 'Rhymes with Dog?', options:['Cat', 'Log', 'Pig'], correct:1}, {q: 'Rhymes with Sun?', options:['Moon', 'Fun', 'Hot'], correct:1}, {q: 'Do Tree and Bee rhyme?', options:['Yes', 'No', 'Maybe'], correct:0}] },
                            { id: 3, title: 'Naming Nouns', content: 'A Noun is a person, place, or thing. Like "Mom", "Park", or "Car".', quiz: [{q: 'Which is a noun?', options:['Run', 'Blue', 'Cat'], correct:2}, {q: 'Is "Jump" a noun?', options:['Yes', 'No', 'Maybe'], correct:1}, {q: 'School is a...', options:['Person', 'Place', 'Thing'], correct:1}] }
                        ]
                    },
                    { 
                        id: 'science', name: 'Science Fun', grade: 'Fun Facts', icon: 'üî¨', color: 'bg-purple-500', premium: true,
                        levels: [
                            { id: 1, title: 'Solar System', content: 'We live on Earth! The Sun is a giant hot star in the middle.', quiz: [{q: 'We live on...', options:['Mars', 'Earth', 'Sun'], correct:1}, {q: 'Is the sun hot?', options:['Yes', 'No', 'Cold'], correct:0}, {q: 'The moon is made of cheese?', options:['Yes', 'No', 'Maybe'], correct:1}] },
                            { id: 2, title: 'Dinosaurs', content: 'Dinosaurs lived long ago. The T-Rex was very big and scary!', quiz: [{q: 'T-Rex was...', options:['Small', 'Big', 'Tiny'], correct:1}, {q: 'Are dinos alive today?', options:['Yes', 'No', 'Birds are!'], correct:2}, {q: 'Did they eat pizza?', options:['Yes', 'No', 'Always'], correct:1}] },
                            { id: 3, title: 'Water Cycle', content: 'Rain comes from clouds. Sun dries it up. Then it rains again!', quiz: [{q: 'Rain comes from...', options:['Ground', 'Clouds', 'Trees'], correct:1}, {q: 'Sun makes water...', options:['Freeze', 'Dry up', 'Green'], correct:1}, {q: 'Is snow water?', options:['Yes', 'No', 'Maybe'], correct:0}] }
                        ]
                    }
                ],

                shopItems: [
                    { id: 'sparkles', name: 'Magic Sparkles', icon: '‚ú®', price: 100, effectType: 'sparkles' },
                    { id: 'glow', name: 'Super Glow', icon: 'üåü', price: 250, effectType: 'glow' },
                    { id: 'fireflies', name: 'Fireflies', icon: 'üêù', price: 350, effectType: 'fireflies' },
                    { id: 'stars', name: 'Star Orbit', icon: '‚≠ê', price: 450, effectType: 'stars' },
                    { id: 'dust', name: 'Magic Dust', icon: 'ü™Ñ', price: 500, effectType: 'dust' }
                ],
                characters: [
                    { 
                        name: "Professor Dino", 
                        subject: "History", 
                        drawingTopics: ["dino", "rex", "fossil", "pyramid", "mummy", "king", "castle", "knight", "sword", "shield", "history", "ancient", "egypt", "rome", "greek", "old", "ruin", "temple"],
                        suggestions: ["Who built the pyramids? üèúÔ∏è", "What is a mummy? ü§ï", "Who was the first king? üëë"],
                        icon: "ü¶ñ", mood_happy: "ü¶ñ", mood_think: "ü¶ï", bg: "radial-gradient(circle, #fff9c4 0%, #ffecb3 100%)", accent: "#f59e0b", pitch: 0.7, rate: 0.85, personality: "History Teacher", intro_phrase: "Rawr! ", premium: false 
                    },
                    { 
                        name: "Rocket Robot", 
                        subject: "Robots and AI", 
                        drawingTopics: ["robot", "bot", "computer", "phone", "screen", "wire", "circuit", "drone", "cyborg", "machine", "future", "tech", "ai", "code", "game"],
                        suggestions: ["How do robots think? ü§ñ", "What is computer code? üíª", "Can robots fly? üöÄ"],
                        icon: "ü§ñ", mood_happy: "ü§ñ", mood_think: "‚öôÔ∏è", bg: "radial-gradient(circle, #e0f2fe 0%, #bae6fd 100%)", accent: "#0284c7", pitch: 0.5, rate: 1.0, personality: "Robot and AI Teacher", intro_phrase: "Beep boop! ", premium: true 
                    },
                    { 
                        name: "Starry Alien", 
                        subject: "Space Exploration", 
                        drawingTopics: ["space", "star", "moon", "sun", "planet", "mars", "earth", "galaxy", "comet", "rocket", "ship", "ufo", "alien", "astronaut", "sky"],
                        suggestions: ["How hot is the sun? ‚òÄÔ∏è", "What is a black hole? üï≥Ô∏è", "How many planets are there? ü™ê"],
                        icon: "üëæ", mood_happy: "üõ∏", mood_think: "üëÅÔ∏è", bg: "radial-gradient(circle, #f3e8ff 0%, #e9d5ff 100%)", accent: "#9333ea", pitch: 1.1, rate: 0.7, personality: "Space Teacher", intro_phrase: "Greetings from the stars! ", premium: true 
                    },
                    { 
                        name: "Magic Cat", 
                        subject: "Science", 
                        drawingTopics: ["science", "lab", "flask", "atom", "magnet", "microscope", "bacteria", "cell", "germ", "ice", "fire", "smoke", "chemical", "potion", "glass"],
                        suggestions: ["Why does ice melt? üßä", "What is gravity? üçé", "How do magnets work? üß≤"],
                        icon: "üê±", mood_happy: "üò∏", mood_think: "üêà", bg: "radial-gradient(circle, #fce7f3 0%, #fbcfe8 100%)", accent: "#db2777", pitch: 1.4, rate: 0.9, personality: "Science Teacher", intro_phrase: "Meow! ", premium: true 
                    },
                    { 
                        name: "Bouncy Bee", 
                        subject: "Nature", 
                        drawingTopics: ["nature", "animal", "dog", "cat", "bird", "fish", "tree", "flower", "leaf", "forest", "jungle", "ocean", "river", "bee", "bug", "butterfly", "sky", "cloud", "rain", "sun"],
                        suggestions: ["Why do bees make honey? üçØ", "How do flowers grow? üåª", "Why is the sky blue? ‚òÅÔ∏è"],
                        icon: "üêù", mood_happy: "üåª", mood_think: "üçØ", bg: "radial-gradient(circle, #fef9c3 0%, #fef08a 100%)", accent: "#854d0e", pitch: 1.3, rate: 1.0, personality: "Nature Teacher", intro_phrase: "Buzz buzz! ", premium: true 
                    }
                ],
                currentChar: null,
                
                async init() {
                    this.currentChar = this.characters[0];
                    this.currentMoodIcon = this.currentChar.icon;
                    this.isLoading = true;

                    // Start Session Timer
                    this.sessionStartTime = Date.now();
                    setInterval(() => {
                        this.totalMinutesLearned++;
                        this.dailyMinutes++; // Increment daily tracker
                        this.syncData();
                    }, 60000);

                    try {
                        const res = await fetch('/api/config');
                        const config = await res.json();
                        this.supabase = supabase.createClient(config.supabaseUrl, config.supabaseKey);

                        const storedEmail = localStorage.getItem('parent_email');
                        if (storedEmail) {
                            this.loginForm.email = storedEmail;
                            this.hasAccount = true;
                        }

                        const urlParams = new URLSearchParams(window.location.search);
                        if (urlParams.get('payment') === 'success') {
                            if (storedEmail) await this.loadUserProfile(storedEmail);
                            
                            this.isPremium = true;
                            this.premiumExpiry = Date.now() + (30 * 24 * 60 * 60 * 1000); 
                            await this.syncData();

                            this.showPremiumModal = false;
                            this.showParentPortal = true;
                            this.parentAuthenticated = true;
                            alert("Payment Successful! Welcome to Premium! üåü");
                            window.history.replaceState({}, document.title, "/");
                        }
                    } catch (e) {
                        console.error("Initialization error:", e);
                    } finally {
                        this.isLoading = false;
                    }

                    this.$watch('safetySettings.blockedWords', value => localStorage.setItem('blocked_words', value));
                },

                // --- NEW METHODS FOR DASHBOARD ANALYTICS ---
                getTotalCurriculumProgress() {
                    let totalPaths = this.curriculum.length;
                    let totalPercent = 0;
                    this.curriculum.forEach(p => {
                        totalPercent += this.getPathProgress(p.id);
                    });
                    return totalPercent / totalPaths;
                },

                getStrengths() {
                    let entries = Object.entries(this.learningStats.subjects);
                    let sorted = entries.sort((a,b) => b[1] - a[1]);
                    // Return the subject name with highest score if > 0
                    if (sorted.length > 0 && sorted[0][1] > 0) {
                        return this.capitalize(sorted[0][0]);
                    }
                    return null;
                },

                getWeaknesses() {
                    // Logic: Get subjects with lowest score but > 0 (needs improvement) OR zero if others are high
                    let entries = Object.entries(this.learningStats.subjects);
                    let sorted = entries.sort((a,b) => a[1] - b[1]); // Sort Ascending
                    if (sorted.length > 0) {
                        return this.capitalize(sorted[0][0]);
                    }
                    return null;
                },
                
                capitalize(str) {
                    return str.charAt(0).toUpperCase() + str.slice(1);
                },

                getDailyTopics() {
                    // Filter parentLogs for today's date
                    let today = new Date().toDateString();
                    let todaysLogs = this.parentLogs.filter(log => {
                        let logDate = new Date(log.time).toDateString(); // Assuming log.time is date string
                        // Simple check if string contains today's date parts or just trust local session
                        return log.time.includes(new Date().toLocaleDateString()); 
                    });

                    // Extract unique subjects (using char names as proxy for topics)
                    let subjects = [...new Set(todaysLogs.map(log => this.getSubjectFromChar(log.char)))];
                    return subjects;
                },

                getSubjectFromChar(charName) {
                    if (charName.includes("Dino")) return "History";
                    if (charName.includes("Robot")) return "Robotics";
                    if (charName.includes("Alien")) return "Space";
                    if (charName.includes("Cat")) return "Science";
                    if (charName.includes("Bee")) return "Nature";
                    return "General";
                },

                // --- LEARNING PATH METHODS ---
                getPathProgress(pathId) {
                    const completed = this.pathProgress[pathId] || 0;
                    const total = this.curriculum.find(p => p.id === pathId).levels.length;
                    return (completed / total) * 100;
                },
                isLevelUnlocked(pathId, levelId) {
                    const completed = this.pathProgress[pathId] || 0;
                    // Level 1 is always unlocked. Level 2 unlocks if completed >= 1
                    return levelId === 1 || completed >= (levelId - 1);
                },
                isLevelComplete(pathId, levelId) {
                    const completed = this.pathProgress[pathId] || 0;
                    return completed >= levelId;
                },
                openLesson(level) {
                    this.activeLesson = level;
                    this.lessonStep = 'learn';
                    this.currentLessonQuizIndex = 0;
                    this.toggleScroll(true);
                },
                closeLesson() {
                    this.activeLesson = null;
                    this.toggleScroll(false);
                },
                getCurrentLessonQuestion() {
                    if (!this.activeLesson) return {q:'', options:[], correct:0};
                    return this.activeLesson.quiz[this.currentLessonQuizIndex];
                },
                checkLessonAnswer(index) {
                    const currentQ = this.getCurrentLessonQuestion();
                    if(index === currentQ.correct) {
                        this.playPing();
                        if(this.currentLessonQuizIndex < 2) {
                            this.currentLessonQuizIndex++;
                        } else {
                            // All correct
                            this.lessonStep = 'success';
                            this.playPing();
                            confetti({ particleCount: 200, spread: 100 });
                        }
                    } else {
                        alert("Oops! Try again!");
                    }
                },
                async completeLesson() {
                    // Update progress
                    const pathId = this.currentPath.id;
                    const currentLevel = this.pathProgress[pathId] || 0;
                    
                    // Only increment if this is the next new level
                    if (this.activeLesson.id > currentLevel) {
                        this.pathProgress[pathId] = this.activeLesson.id;
                    }
                    
                    this.coins += 50;
                    this.xp += 100;
                    this.updateLevel();
                    await this.syncData();
                    this.closeLesson();
                },

                printCertificate(path) {
                    this.selectedCertificatePath = path;
                    setTimeout(() => {
                        window.print();
                    }, 500);
                },

                async resetMapProgress() {
                    if(confirm("Restart your Adventure Map progress? This will reset all paths to 0%.")) {
                        this.pathProgress = {};
                        await this.syncData();
                        alert("Map progress has been reset!");
                    }
                },

                async loadUserProfile(email) {
                    try {
                        const { data, error } = await this.supabase
                            .from('profiles')
                            .select('*')
                            .eq('email', email)
                            .single();
                        
                        if (data) {
                            this.populateUserData(data);
                            this.isLoggedIn = true;
                            this.playPing();
                            if (!this.rewardClaimedToday) {
                                setTimeout(() => {
                                    this.showRewards = true;
                                    this.toggleScroll(true);
                                }, 1000);
                            }
                        }
                    } catch (e) {
                        console.error("Sync error:", e);
                    }
                },

                populateUserData(data) {
                    this.registeredEmail = data.email;
                    this.savedProfile = { name: data.name, email: data.email };
                    this.masterPin = data.pin;
                    this.coins = Number(data.coins) || 0; 
                    this.xp = data.xp || 0;
                    
                    this.childProfile = (data.learning_stats && data.learning_stats.child_profile) 
                        ? data.learning_stats.child_profile 
                        : { name: data.name, age: '', grade: '', ageRange: '6-7' }; 

                    this.totalMinutesLearned = data.total_minutes || 0;
                    this.emailSummaryEnabled = data.email_summary_enabled || false;

                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('payment') !== 'success') {
                        this.isPremium = data.is_premium || false;
                        this.premiumExpiry = data.premium_expiry;
                    }
                    
                    this.inventory = data.inventory || [];
                    this.equippedItem = data.equipped_item;
                    this.parentLogs = data.parent_logs || [];
                    this.learningStats = data.learning_stats || {
                        wordsLearned: 0,
                        subjects: { history: 0, robots: 0, space: 0, science: 0, nature: 0 },
                        child_profile: this.childProfile
                    };

                    this.pathProgress = data.learning_stats?.path_progress || {};
                    
                    const dailyData = data.daily_usage || {};
                    const today = new Date().toDateString();
                    if (dailyData.date !== today) {
                        this.dailyQuestionsUsed = 0;
                        this.rewardClaimedToday = false;
                        this.dailyMinutes = 0; // Reset daily minutes on new day load
                    } else {
                        this.dailyQuestionsUsed = dailyData.questions_used || 0;
                        this.rewardClaimedToday = dailyData.reward_claimed || false;
                        this.dailyMinutes = dailyData.daily_minutes || 0;
                    }
                    
                    this.updateLevel();
                    this.checkPremiumExpiration();
                },

                get journeyProgress() {
                    // Logic to fill bar based on milestones
                    if (this.xp < 1000) return (this.xp / 1000) * 33; 
                    if (this.xp < 3000) return 33 + ((this.xp - 1000) / 2000) * 33;
                    return 66 + ((this.xp - 3000) / 2000) * 34; // Max out at 5000+
                },

                getTopSubjects() {
                    const requiredKeys = ['history', 'robots', 'space', 'science', 'nature'];
                    const displayNames = {
                        history: 'History',
                        robots: 'Robots and AI',
                        space: 'Space Exploration',
                        science: 'Science',
                        nature: 'Nature'
                    };
                    
                    let statsArray = requiredKeys.map(key => {
                        const score = this.learningStats.subjects[key] || 0;
                        return [displayNames[key], score];
                    });

                    statsArray.sort((a, b) => b[1] - a[1]);

                    return statsArray.reduce((obj, [name, score]) => {
                        obj[name] = score;
                        return obj;
                    }, {});
                },

                getSubjectColor(subject) {
                    const colors = {
                        'History': 'bg-orange-500',
                        'Robots and AI': 'bg-blue-600',
                        'Space Exploration': 'bg-purple-600',
                        'Science': 'bg-pink-500',
                        'Nature': 'bg-green-500'
                    };
                    return colors[subject] || 'bg-gray-500';
                },

                async saveChildProfile() {
                    this.isEditingProfile = false;
                    await this.syncData();
                    // Update login form name just in case
                    this.loginForm.name = this.childProfile.name;
                },

                async toggleEmailSummary() {
                    this.emailSummaryEnabled = !this.emailSummaryEnabled;
                    await this.syncData();
                    alert(this.emailSummaryEnabled ? "Email summaries activated! You will receive weekly updates." : "Email summaries deactivated.");
                },

                downloadMonthlyReport() {
                    if (!this.isPremium) {
                        this.showPremiumModal = true;
                        return;
                    }
                    alert("Generating Progress Report... Your PDF will download shortly.");
                    // Simulate PDF generation
                },

                async generateArt() {
                    if (!this.userQuery) {
                        alert("Tell me what to draw first! (Type in the box)");
                        return;
                    }

                    const queryLower = this.userQuery.toLowerCase();
                    const isOnTopic = this.currentChar.drawingTopics.some(topic => queryLower.includes(topic));

                    if (!isOnTopic) {
                        this.displayText = `Ooh! I only know how to draw ${this.currentChar.subject} things! üé® Try asking for: ${this.currentChar.drawingTopics.slice(0,3).join(", ")}!`;
                        this.speak(this.displayText);
                        this.isThinking = false;
                        this.currentMoodIcon = 'ü§î';
                        return; 
                    }

                    this.showArtModal = true;
                    this.isDrawing = true;
                    this.artImage = null;
                    this.toggleScroll(true);

                    // USE POLLINATIONS AI
                    const prompt = "coloring page for kids, simple black and white outline of " + this.userQuery;
                    const encodedPrompt = encodeURIComponent(prompt);
                    const randomSeed = Math.floor(Math.random() * 1000);
                    
                    const imageUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?nologo=true&model=flux&width=1024&height=1024&seed=${randomSeed}&safe=true`;

                    setTimeout(() => {
                        this.artImage = imageUrl;
                        this.isDrawing = false;
                        this.playPing();
                        confetti({ particleCount: 150, spread: 70 });
                    }, 2000);
                },

                async downloadArt() {
                    if (!this.artImage) return;
                    try {
                        const response = await fetch(this.artImage);
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = 'magic-art-' + Date.now() + '.png'; 
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    } catch (e) {
                        console.error("Download failed:", e);
                        window.open(this.artImage, '_blank');
                    }
                },

                // Helper for Age Logic
                getAgeLogic() {
                    const range = this.childProfile.ageRange || '6-7';
                    const priority = this.isPremium ? "PRIORITY MODE: Use even more engaging facts and detailed encouraging feedback." : "";
                    
                    if (range === '4-5') {
                        return `${priority} TARGET AUDIENCE: Age 4-5 (Preschool). Use extremely simple words. Max sentence length: 5 words. Tone: Very playful, like a cartoon character. Avoid complex concepts.`;
                    }
                    if (range === '8-9') {
                        return `${priority} TARGET AUDIENCE: Age 8-9 (Upper Elementary). Use moderate vocabulary. You can explain deeper concepts. Tone: Encouraging teacher, cool and smart.`;
                    }
                    return `${priority} TARGET AUDIENCE: Age 6-7 (Early Elementary). Use simple vocabulary. Clear sentences. Tone: Friendly and helpful.`;
                },

                async startQuiz() {
                    this.showQuiz = true;
                    this.quizState = 'loading';
                    this.toggleScroll(true);

                    const ageRange = this.childProfile.ageRange || '6-7';

                    try {
                        const systemPrompt = `You are an AI Quiz Generator for kids. 
                        TARGET AGE: ${ageRange}.
                        Based on the following text: "${this.displayText}", create ONE multiple-choice question suitable for a ${ageRange} year old.
                        Adjust difficulty accordingly (4-5: very easy, 8-9: moderate).
                        Return strictly this JSON format: 
                        {"question": "The Question?", "options": ["Option A", "Option B", "Option C"], "correctIndex": 0}
                        Make sure the options are short and simple.`;

                        const response = await fetch("/api/chat", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                "messages": [
                                    { "role": "system", "content": systemPrompt },
                                    { "role": "user", "content": "Generate quiz" }
                                ]
                            })
                        });

                        const data = await response.json();
                        let cleanJson = data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
                        const quizData = JSON.parse(cleanJson);

                        this.quizQuestion = quizData.question;
                        this.quizOptions = quizData.options;
                        this.quizCorrectIndex = quizData.correctIndex;
                        this.quizState = 'active';

                    } catch (e) {
                        console.error("Quiz Error", e);
                        this.quizQuestion = "Did you like learning about that?";
                        this.quizOptions = ["Yes!", "It was okay", "No"];
                        this.quizCorrectIndex = 0;
                        this.quizState = 'active';
                    }
                },

                checkAnswer(index) {
                    if (index === this.quizCorrectIndex) {
                        this.quizState = 'correct';
                        this.coins += 20; 
                        this.playPing();
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                        this.syncData();
                    } else {
                        this.quizState = 'wrong';
                    }
                },

                async handleSignup() {
                    if (!this.loginForm.name || !this.loginForm.email || this.loginForm.pin.length !== 4) {
                        alert("Please fill in all fields. PIN must be 4 digits.");
                        return;
                    }
                    if(!this.legalAccepted) {
                        alert("Please agree to the Privacy Policy and Terms.");
                        return;
                    }

                    this.isLoading = true;
                    const email = this.loginForm.email.toLowerCase().trim();

                    const initialChildProfile = { 
                        name: this.loginForm.name, 
                        age: '', 
                        grade: '',
                        ageRange: this.loginForm.ageRange 
                    };

                    const initialStats = {
                        ...this.learningStats,
                        child_profile: initialChildProfile
                    };

                    try {
                        const { data, error } = await this.supabase.from('profiles').insert([
                            {
                                email: email,
                                name: this.loginForm.name,
                                pin: this.loginForm.pin,
                                coins: 50, 
                                xp: 0,
                                learning_stats: initialStats,
                                parent_logs: []
                            }
                        ]);

                        if (error) throw error;

                        localStorage.setItem('parent_email', email);
                        this.registeredEmail = email;
                        this.masterPin = this.loginForm.pin;
                        this.savedProfile = { name: this.loginForm.name, email: email };
                        
                        this.childProfile = initialChildProfile;
                        this.learningStats = initialStats;

                        this.coins = 50; 
                        this.isLoggedIn = true;
                        this.hasAccount = true;
                        this.playPing();
                        
                        confetti({ particleCount: 150, spread: 70 });

                    } catch (err) {
                        if (err.code === '23505') { 
                            alert("This email is already registered. Please login.");
                            this.hasAccount = true;
                        } else {
                            alert("Error creating account: " + err.message);
                        }
                    } finally {
                        this.isLoading = false;
                    }
                },

                async handleLogin() {
                    this.isLoading = true;
                    const email = this.loginForm.email.toLowerCase().trim();

                    try {
                        const { data, error } = await this.supabase
                            .from('profiles')
                            .select('pin')
                            .eq('email', email)
                            .single();

                        if (error || !data) {
                            alert("Account not found. Please check email or create an account.");
                            this.isLoading = false;
                            return;
                        }

                        if (data.pin !== this.loginForm.pin) {
                            alert("Incorrect PIN.");
                            this.loginForm.pin = '';
                            this.isLoading = false;
                            return;
                        }

                        localStorage.setItem('parent_email', email);
                        await this.loadUserProfile(email);

                    } catch (err) {
                        console.error(err);
                        alert("Login failed. Check connection.");
                    } finally {
                        this.isLoading = false;
                        this.loginForm.pin = '';
                    }
                },

                async syncData() {
                    if (!this.registeredEmail) return;
                    
                    this.learningStats.path_progress = this.pathProgress;
                    this.learningStats.child_profile = this.childProfile;

                    const safeLogs = JSON.parse(JSON.stringify(this.parentLogs));
                    const safeInventory = JSON.parse(JSON.stringify(this.inventory));
                    const safeStats = JSON.parse(JSON.stringify(this.learningStats));

                    const updateData = {
                        coins: this.coins,
                        xp: this.xp,
                        total_minutes: this.totalMinutesLearned,
                        email_summary_enabled: this.emailSummaryEnabled,
                        inventory: safeInventory,
                        equipped_item: this.equippedItem,
                        learning_stats: safeStats,
                        parent_logs: safeLogs, 
                        is_premium: this.isPremium,
                        premium_expiry: this.premiumExpiry,
                        daily_usage: {
                            date: new Date().toDateString(),
                            questions_used: this.dailyQuestionsUsed,
                            reward_claimed: this.rewardClaimedToday,
                            daily_minutes: this.dailyMinutes // Sync daily minutes
                        }
                    };

                    await this.supabase
                        .from('profiles')
                        .update(updateData)
                        .eq('email', this.registeredEmail);
                },

                toggleScroll(disable) {
                    if (disable) {
                        document.body.classList.add('no-scroll');
                    } else {
                        document.body.classList.remove('no-scroll');
                    }
                },

                async buyItem(item) {
                    if (this.coins >= item.price) {
                        this.coins -= item.price;
                        this.inventory.push(item.id);
                        this.equipItem(item.id);
                        confetti({
                            particleCount: 100,
                            spread: 70,
                            colors: ['#00ff00', '#ffffff']
                        });
                        this.playPing();
                        await this.syncData(); 
                    }
                },
                async equipItem(itemId) {
                    this.equippedItem = itemId;
                    await this.syncData();
                },
                async toggleEquip(itemId) {
                    if (this.equippedItem === itemId) {
                        this.equippedItem = null;
                    } else {
                        this.equippedItem = itemId;
                    }
                    await this.syncData();
                },
                getEquippedItemData() {
                    return this.shopItems.find(i => i.id === this.equippedItem) || {};
                },
                
                checkPremiumExpiration() {
                    if (this.isPremium && this.premiumExpiry) {
                        const now = new Date().getTime();
                        if (now > this.premiumExpiry) {
                            this.isPremium = false;
                            this.premiumExpiry = null;
                            alert("Your monthly premium subscription has expired. Please renew to access all features!");
                            this.setChar(this.characters[0]);
                            this.syncData();
                        }
                    }
                },
                async processPayment() {
                    this.isLoading = true;
                    try {
                        const res = await fetch('/api/create-checkout', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userEmail: this.registeredEmail })
                        });
                        
                        const data = await res.json();
                        
                        if (data.url) {
                            window.location.href = data.url;
                        } else {
                            alert("Could not connect to payment server. Check console.");
                        }
                    } catch (e) {
                        alert("Payment Error. Please try again.");
                    } finally {
                        this.isLoading = false;
                        this.showCheckout = false;
                    }
                },
                async cancelSubscription() {
                    if(confirm("Are you sure you want to cancel? You will lose access to premium features immediately.")) {
                        this.isPremium = false;
                        this.premiumExpiry = null;
                        this.setChar(this.characters[0]);
                        await this.syncData();
                    }
                },
                
                async claimReward() {
                    if (this.rewardClaimedToday) return;
                    let rewardAmount = (this.todayIndex === 6) ? 100 : 50;
                    this.coins = Number(this.coins) + rewardAmount;
                    this.rewardClaimedToday = true;
                    
                    confetti({
                        particleCount: 150,
                        spread: 70,
                        origin: { y: 0.6 },
                        colors: ['#FFD700', '#FF69B4', '#00BFFF']
                    });
                    this.playPing();
                    await this.syncData(); 
                },
                trySetChar(char) {
                    if (char.premium && !this.isPremium) {
                        this.showPremiumModal = true;
                        this.toggleScroll(true);
                    } else {
                        this.setChar(char);
                    }
                },
                openParentPortal() {
                    this.showParentPortal = true;
                    this.parentAuthenticated = false;
                    this.isChangingPin = false;
                    this.pinInput = '';
                    this.toggleScroll(true);
                },
                startPinChange() {
                    this.parentAuthenticated = false;
                    this.isChangingPin = true;
                    this.pinInput = '';
                },
                async verifyPin() {
                    if (this.isChangingPin) {
                        if (this.pinInput.length === 4) {
                            this.masterPin = this.pinInput;
                            await this.supabase.from('profiles').update({ pin: this.pinInput }).eq('email', this.registeredEmail);
                            
                            alert("PIN updated!");
                            this.isChangingPin = false;
                            this.parentAuthenticated = true;
                            this.pinInput = '';
                        }
                    } else {
                        if(this.pinInput === this.masterPin) {
                            this.parentAuthenticated = true;
                        } else {
                            this.pinInput = '';
                        }
                    }
                },
                closeParentPortal() {
                    this.showParentPortal = false;
                    this.parentAuthenticated = false;
                    this.isChangingPin = false;
                    this.pinInput = '';
                    this.toggleScroll(false);
                },
                logActivity(query) {
                    let shortName = this.currentChar.name.replace("Professor ", "");
                    const entry = {
                        query: query,
                        time: new Date().toLocaleString(),
                        char: shortName
                    };
                    this.parentLogs.push(entry);
                },
                async clearLogs() {
                    if(confirm("Clear search history? (This will NOT delete your Coins, XP, or Adventure Map progress)")) {
                        this.parentLogs.splice(0, this.parentLogs.length);
                        
                        this.learningStats.wordsLearned = 0;
                        this.learningStats.subjects = { history: 0, robots: 0, space: 0, science: 0, nature: 0 };
                        
                        await this.syncData(); 
                        alert("Search history cleared.");
                    }
                },
                updateProgress(query, response) {
                    const words = response.split(' ').length;
                    this.learningStats.wordsLearned += words;
                    const queryLower = query.toLowerCase();
                    if (queryLower.match(/bee|ocean|rainbow|flower|animal|dog|cat|nature|tree/)) this.learningStats.subjects.nature += 10;
                    if (queryLower.match(/sun|alien|space|star|moon|planet|mars|jupiter|rocket|astronaut/)) this.learningStats.subjects.space += 10;
                    if (queryLower.match(/robot|bot|code|computer|ai|tech|future/)) this.learningStats.subjects.robots += 10;
                    if (queryLower.match(/volcano|science|math|how|experiment|chemistry|physics/)) this.learningStats.subjects.science += 10;
                    if (queryLower.match(/dino|dinosaur|t-rex|fossil|history|old|egypt|pirate|knight|king/)) this.learningStats.subjects.history += 10;
                },
                startListening() {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    if (!SpeechRecognition) return;
                    const recognition = new SpeechRecognition();
                    recognition.lang = 'en-US';
                    recognition.onstart = () => { this.isListening = true; window.speechSynthesis.cancel(); this.isSpeaking = false; };
                    recognition.onresult = (event) => { this.userQuery = event.results[0][0].transcript; this.isListening = false; this.askTutor(); };
                    recognition.onerror = () => { this.isListening = false; };
                    recognition.onend = () => { this.isListening = false; };
                    recognition.start();
                },
                setChar(char) {
                    this.currentChar = char;
                    this.currentMoodIcon = char.icon;
                    this.displayText = `Hello! I'm ${char.name}. I teach ${char.subject}! Ask me anything about it.`;
                    this.suggestions = char.suggestions;
                    this.hasAnswered = false;
                    window.speechSynthesis.cancel();
                    this.isSpeaking = false;
                },
                updateLevel() {
                    this.level = Math.floor(this.xp / 100) + 1;
                },
                isQuerySafe(query) {
                    const lowerQuery = query.toLowerCase();
                    const blocked = this.safetySettings.blockedWords.split(',').map(w => w.trim().toLowerCase());
                    const combinedFilters = [...blocked, ...this.safetySettings.forbiddenTopics];
                    return !combinedFilters.some(word => word !== "" && lowerQuery.includes(word));
                },
                async askTutor() {
                    if (!this.userQuery.trim()) return;
                    if (!this.isPremium && this.dailyQuestionsUsed >= this.maxFreeQuestions) {
                        this.showPremiumModal = true;
                        this.toggleScroll(true);
                        return;
                    }
                    if (!this.isQuerySafe(this.userQuery)) {
                        this.displayText = "Oops! That's a bit too serious. Let's talk about something fun like space or dinosaurs instead! üåà‚ú®";
                        this.userQuery = '';
                        this.currentMoodIcon = 'ü§î';
                        return;
                    }

                    const savedQuery = this.userQuery;
                    this.logActivity(this.userQuery);
                    window.speechSynthesis.cancel();
                    this.isSpeaking = false;
                    this.isThinking = true;
                    this.hasAnswered = false;
                    this.displayText = "Thinking... üß†‚ú®";
                    this.currentMoodIcon = this.currentChar.mood_think;

                    const ageLogicInstruction = this.getAgeLogic();

                    try {
                        const systemPrompt = `You are ${this.currentChar.name}, a fun teacher for children. 
                        ${ageLogicInstruction}
                        YOUR SUBJECT: ${this.currentChar.subject}.
                        
                        CRITICAL RULES:
                        1. IF the question is about ${this.currentChar.subject}, answer it briefly (MAX 2 sentences) and end with a question.
                        2. IF the question is NOT about ${this.currentChar.subject}, DO NOT ANSWER IT. Instead, gently say: "Ooh! I only know about ${this.currentChar.subject}. Let's talk about that instead! ü¶ñ"
                        3. Never break character.`;

                        const response = await fetch("/api/chat", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                "messages": [
                                    { "role": "system", "content": systemPrompt },
                                    { "role": "user", "content": savedQuery }
                                ]
                            })
                        });

                        const data = await response.json();
                        const aiMessage = data.choices[0].message.content;
                        
                        if (!this.isPremium) {
                            this.dailyQuestionsUsed++;
                        }

                        this.finishThinking(this.currentChar.intro_phrase + aiMessage, savedQuery);
                    } catch (error) {
                        console.error("API Error:", error);
                        this.finishThinking("Oh no! My brain is fuzzy. Can you ask again? üîå", savedQuery);
                    }
                },
                async finishThinking(response, originalQuery) {
                    this.displayText = response;
                    this.isThinking = false;
                    this.hasAnswered = true;
                    this.userQuery = '';
                    this.currentMoodIcon = this.currentChar.mood_happy;
                    this.xp += 20;
                    this.updateLevel();
                    this.playPing();
                    this.updateProgress(originalQuery, response);
                    
                    await this.syncData();
                },
                playPing() {
                    const context = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = context.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(440, context.currentTime);
                    osc.connect(context.destination);
                    osc.start();
                    osc.stop(context.currentTime + 0.1);
                },
                speak(text) {
                    if (this.isSpeaking) { window.speechSynthesis.cancel(); this.isSpeaking = false; return; }
                    const cleanText = text.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '');
                    const msg = new SpeechSynthesisUtterance(cleanText);
                    const voices = window.speechSynthesis.getVoices();
                    let baseVoice = voices.find(v => v.name.includes('Google US English')) || voices.find(v => v.name.includes('Samantha')) || voices[0];
                    msg.voice = baseVoice;
                    msg.pitch = this.currentChar.pitch; 
                    msg.rate = this.currentChar.rate;
                    msg.onstart = () => { this.isSpeaking = true; };
                    msg.onend = () => { this.isSpeaking = false; };
                    window.speechSynthesis.speak(msg);
                },
                generateWorksheet() {
                    if(!this.isPremium) {
                        this.showPremiumModal = true;
                        return;
                    }
                    this.playPing();
                    window.print();
                    this.coins += 100;
                    this.syncData();
                }
            }
        }
    </script>
</body>
</html>
