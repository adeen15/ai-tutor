<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>AI Tutor - Animated Friends</title>
        
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="apple-mobile-web-app-title" content="AI Tutor">
        <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1998/1998614.png">
        
        <link rel="manifest" href="manifest.json">

        <script src="https://cdn.tailwindcss.com"></script>
        <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

        <style>
            [x-cloak] { display: none !important; }

            body {
                font-family: 'Quicksand', sans-serif;
                min-height: 100vh;
                min-height: 100dvh;
                overflow-x: hidden;
                display: block;   
                transition: background 0.5s ease;
                overscroll-behavior-y: none;
            }

            @media (min-width: 640px) {
                .no-scroll-desktop {
                    overflow: hidden !important;
                    height: 100vh;
                    position: fixed;
                    width: 100%;
                }
            }
            
            html { scroll-behavior: smooth; }
            .font-kids { font-family: 'Fredoka One', cursive; }
            
            .chat-bubble {
                position: relative;
                background: white;
                border-radius: 40px;
                box-shadow: 0 30px 60px -12px rgba(0,0,0,0.15);
                border: 6px solid white;
            }

            /* --- ANIMATIONS --- */
            .char-float { animation: floating 5s ease-in-out infinite; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1)); z-index: 10; }
            @keyframes floating { 0%, 100% { transform: translateY(0px) rotate(-2deg); } 50% { transform: translateY(-30px) rotate(3deg); } }

            .wiggle-speak { animation: wiggle 0.4s ease-in-out infinite; }
            @keyframes wiggle { 0%, 100% { transform: scale(1.1) rotate(0deg); } 25% { transform: scale(1.1) rotate(3deg); } 75% { transform: scale(1.1) rotate(-3deg); } }

            .listening-pulse { animation: pulse-border 1.5s infinite; }
            @keyframes pulse-border { 0% { box-shadow: 0 0 0 0px rgba(59, 130, 246, 0.7); } 100% { box-shadow: 0 0 0 30px rgba(59, 130, 246, 0); } }

            .effect-glow { filter: drop-shadow(0 0 40px gold) drop-shadow(0 0 10px orange); animation: pulse-glow 2s infinite; }
            @keyframes pulse-glow { 0%, 100% { filter: drop-shadow(0 0 40px gold) drop-shadow(0 0 10px orange); } 50% { filter: drop-shadow(0 0 60px #fff700) drop-shadow(0 0 20px #ff9100); } }

            .sparkle-particle { position: absolute; animation: twinkle 2s ease-in-out infinite; }
            @keyframes twinkle { 0%, 100% { transform: scale(0) rotate(0deg); opacity: 0; } 50% { transform: scale(1.2) rotate(180deg); opacity: 1; } }

            .firefly-particle { position: absolute; width: 10px; height: 10px; background: #bef264; border-radius: 50%; box-shadow: 0 0 10px #bef264, 0 0 20px #bef264; animation: fly-around 4s ease-in-out infinite; }
            @keyframes fly-around { 0% { transform: translate(0, 0) scale(1); opacity: 0.8; } 33% { transform: translate(30px, -30px) scale(1.2); } 66% { transform: translate(-20px, 20px) scale(0.8); } 100% { transform: translate(0, 0) scale(1); opacity: 0.8; } }

            .orbit-container { position: absolute; inset: -40px; animation: spin-orbit 8s linear infinite; }
            .star-item { position: absolute; animation: counter-spin 8s linear infinite; }
            @keyframes spin-orbit { 100% { transform: rotate(360deg); } }
            @keyframes counter-spin { 100% { transform: rotate(-360deg); } }

            .dust-particle { position: absolute; bottom: 0; animation: float-up 3s linear infinite; }
            @keyframes float-up { 0% { transform: translateY(20px) scale(0.5); opacity: 0; } 20% { opacity: 1; } 100% { transform: translateY(-150px) scale(1.5) rotate(45deg); opacity: 0; } }

            /* --- UI ELEMENTS --- */
            .btn-grad { transition: 0.5s; background-size: 200% auto; }
            .btn-grad:hover { background-position: right center; }
            
            .char-btn { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; }
            .char-btn:hover { transform: scale(1.2); }
            .char-btn.active { transform: scale(1.3); border-color: white; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
            
            .char-locked { filter: grayscale(100%); opacity: 0.7; }
            .lock-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; }

            .mic-active { animation: pulse-red 1.5s infinite; color: #ef4444 !important; }
            @keyframes pulse-red { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }

            .keyboard-active { color: #3b82f6 !important; transform: scale(1.1); }

            ::-webkit-scrollbar { width: 10px; }
            ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
            ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
            ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }

            .premium-glow { animation: glow-gold 2s infinite; }
            @keyframes glow-gold { 0% { box-shadow: 0 0 5px #ffd700; } 50% { box-shadow: 0 0 20px #ffd700, 0 0 10px #ffea00; } 100% { box-shadow: 0 0 5px #ffd700; } }

            .gift-bounce { animation: bounce 2s infinite; }
            @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }

            .safe-badge { background: #10b981; color: white; padding: 4px 10px; border-radius: 99px; font-size: 8px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 4px; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); width: fit-content; }

            .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #3b82f6; width: 40px; height: 40px; animation: spin 1s linear infinite; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

            .level-connector { position: absolute; width: 4px; background-color: #e5e7eb; left: 50%; transform: translateX(-50%); z-index: 0; }
            .bounce { animation: bounce 2s infinite; }

            .certificate-border { border: 20px solid #f59e0b; border-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h40v40H0z' fill='none'/%3E%3Cpath d='M20 0l5 15h15l-12 9 4 16-12-9-12 9 4-16-12-9h15z' fill='%23f59e0b'/%3E%3C/svg%3E") 30; }

            @media (max-width: 640px) {
                .daily-reward-btn { padding: 0.5rem !important; width: 52px; height: 52px; }
                .daily-reward-btn span.gift-bounce { font-size: 1.25rem !important; }
                .daily-reward-btn span.text-pink-500 { font-size: 7px !important; }
                .safe-badge { font-size: 7px; padding: 2px 8px; }
            }

           @media print {
    body * { visibility: hidden; }
    #printable-art, #printable-art *, #worksheet-print-area, #worksheet-print-area * { visibility: visible; }
    #printable-art { position: fixed; left: 0; top: 0; width: 100%; height: 100%; object-fit: contain; z-index: 9999; }
    #worksheet-print-area { position: absolute; left: 0; top: 0; width: 100%; padding: 40px; background: white; color: black; }
    .fixed, .absolute, .bg-black, .bg-slate-900, .bg-slate-50 { background: none !important; box-shadow: none !important; }
}
        </style>
    </head>
    <body x-data="aiTutor()" 
        :style="'background: ' + (currentChar?.bg || 'white')"
        :class="!isLoggedIn ? 'no-scroll-desktop' : ''">

        <div x-show="isLoading" class="fixed inset-0 z-[200] bg-white/80 flex items-center justify-center backdrop-blur-sm" x-transition>
            <div class="flex flex-col items-center">
                <div class="spinner mb-4"></div>
                <p class="font-kids text-blue-500">Syncing magic...</p>
            </div>
        </div>

        <div id="certificate-area" class="hidden flex-col items-center justify-center p-12 text-center bg-white certificate-border" style="min-height: 100vh;">
            <div class="text-6xl mb-4">üéì</div>
            <h1 class="text-5xl font-kids text-amber-600 mb-2">Certificate of Achievement</h1>
            <p class="text-2xl text-gray-600 mb-8">This award is proudly presented to</p>
            <h2 class="text-6xl font-kids text-slate-800 mb-8 underline" x-text="childProfile.name"></h2>
            <p class="text-xl text-gray-500 max-w-2xl mx-auto leading-relaxed">
                For successfully completing the <span class="font-bold text-slate-800" x-text="selectedCertificatePath?.name"></span> 
                adventure path and showing incredible curiosity and brilliance in learning!
            </p>
            <div class="mt-16 flex justify-between w-full max-w-3xl px-12">
                <div class="text-center">
                    <div class="border-b-2 border-gray-400 w-48 mb-2"></div>
                    <p class="font-bold text-gray-400 uppercase">Your Teacher</p>
                </div>
                <div class="text-center">
                    <div class="border-b-2 border-gray-400 w-48 mb-2"></div>
                    <p class="font-bold text-gray-400 uppercase">Date</p>
                </div>
            </div>
            <div class="mt-12 text-4xl">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
        </div>

        <div id="worksheet-print-area" class="hidden">
            <div style="border: 4px solid black; padding: 20px;">
                <h1 style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">AI Tutor: Learning Worksheet</h1>
                <p><strong>Student Name:</strong> <span x-text="childProfile.name"></span> ____________________</p>
                <p><strong>Date:</strong> ____________________</p>
                <hr style="margin: 20px 0;">
                <h2 style="font-size: 24px;">Topic of the Day: <span x-text="currentChar?.subject || 'Learning'"></span></h2>
                <div style="margin-top: 30px; height: 300px; border: 1px dashed gray; padding: 10px; text-align: center;">
                    <p style="color: gray;">Draw a picture about <span x-text="currentChar?.subject || 'today\s lesson'"></span> here!</p>
                </div>
                <div style="margin-top: 40px;">
                    <h3 style="font-size: 20px;">Writing Challenge:</h3>
                    <p style="margin-bottom: 20px;">Can you write two fun facts you learned today?</p>
                    <div style="border-bottom: 1px solid black; height: 40px;"></div>
                    <div style="border-bottom: 1px solid black; height: 40px; margin-top: 10px;"></div>
                </div>
                <div style="margin-top: 40px; text-align: center;">
                    <p>Great Job! ‚≠ê You earned 100 bonus coins!</p>
                </div>
            </div>
        </div>

        <div x-show="!isLoggedIn" class="fixed inset-0 z-[100] bg-white sm:bg-gradient-to-br sm:from-blue-400 sm:to-purple-600 overflow-y-auto overflow-x-hidden sm:overflow-hidden sm:flex sm:items-center sm:justify-center transition-all duration-700">
            <div class="min-h-full w-full p-0 sm:p-4 block sm:flex sm:items-center sm:justify-center">
                <div class="bg-white m-0 w-full min-w-full sm:min-w-0 min-h-screen sm:min-h-0 sm:rounded-[2rem] p-6 sm:p-12 sm:max-w-md shadow-2xl text-center relative overflow-hidden animate__animated animate__zoomIn sm:my-8 sm:border-8 border-white/20">
                    
                    <div class="absolute top-0 left-0 w-32 h-32 bg-yellow-300 rounded-full blur-3xl opacity-50 -translate-x-1/2 -translate-y-1/2"></div>
                    <div class="absolute bottom-0 right-0 w-32 h-32 bg-pink-300 rounded-full blur-3xl opacity-50 translate-x-1/2 translate-y-1/2"></div>

                    <div class="relative z-10">
                        <div class="text-6xl mb-4 animate__animated animate__bounceIn delay-500">üéì</div>
                        <h1 class="text-4xl font-kids text-slate-800 mb-2">AI Tutor</h1>
                        <p class="text-slate-500 font-bold mb-8">Parent Setup & Login</p>

                        <div x-show="!hasAccount" class="space-y-4 text-left">
                            <div x-show="!gateVerified" class="animate__animated animate__fadeIn">
                                <div class="bg-blue-50 p-6 rounded-2xl border-2 border-blue-200">
                                    <h3 class="font-kids text-blue-800 mb-2">Adult Verification</h3>
                                    <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Please solve this to continue:</p>
                                    <div class="flex items-center gap-4 mb-4">
                                        <span class="text-2xl font-kids text-blue-600" x-text="gateQuestion"></span>
                                        <input type="number" x-model="gateAnswer" placeholder="?" class="w-20 p-3 bg-white border-2 border-blue-300 rounded-xl text-center font-bold text-xl">
                                    </div>
                                    <button @click="verifyGate" class="w-full py-3 bg-blue-500 text-white rounded-xl font-bold uppercase tracking-widest text-xs hover:bg-blue-600 transition-colors">
                                        Verify I am an Adult
                                    </button>
                                    <p class="text-[10px] text-slate-400 mt-4 leading-tight italic">This "Parental Gate" ensures children cannot provide personal data without adult supervision, in compliance with COPPA and GDPR-K.</p>
                                </div>
                            </div>

                            <div x-show="gateVerified" class="animate__animated animate__fadeInUp">
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1 ml-2">Parent Full Name</label>
                                    <input type="text" x-model="loginForm.name" placeholder="Jane Doe" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl focus:border-blue-500 focus:bg-white outline-none font-bold text-slate-700 transition-all text-base">
                                </div>

                                <div class="animate__animated animate__fadeIn mt-4">
                                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 ml-2">Child's Age (Auto-Adjusts Difficulty)</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button @click="loginForm.ageRange = '4-6'" 
                                                :class="loginForm.ageRange === '4-6' ? 'bg-blue-500 text-white border-blue-600 shadow-md ring-2 ring-blue-200' : 'bg-slate-50 text-slate-400 border-slate-200 hover:bg-slate-100'"
                                                class="p-2 rounded-2xl border-2 font-bold transition-all text-xs flex flex-col items-center justify-center">
                                            <span class="text-lg">üê£</span>
                                            <span>4-6 (Basic)</span>
                                        </button>
                                        <button @click="loginForm.ageRange = '7-9'" 
                                                :class="loginForm.ageRange === '7-9' ? 'bg-green-500 text-white border-green-600 shadow-md ring-2 ring-green-200' : 'bg-slate-50 text-slate-400 border-slate-200 hover:bg-slate-100'"
                                                class="p-2 rounded-2xl border-2 font-bold transition-all text-xs flex flex-col items-center justify-center">
                                            <span class="text-lg">üéí</span>
                                            <span>7-9 (Logic)</span>
                                        </button>
                                        <button @click="loginForm.ageRange = '10-13'" 
                                                :class="loginForm.ageRange === '10-13' ? 'bg-purple-500 text-white border-purple-600 shadow-md ring-2 ring-purple-200' : 'bg-slate-50 text-slate-400 border-slate-200 hover:bg-slate-100'"
                                                class="p-2 rounded-2xl border-2 font-bold transition-all text-xs flex flex-col items-center justify-center">
                                            <span class="text-lg">üöÄ</span>
                                            <span>10-13 (Science)</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1 ml-2">Email Address</label>
                                    <input type="email" x-model="loginForm.email" placeholder="parent@email.com" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl focus:border-blue-500 focus:bg-white outline-none font-bold text-slate-700 transition-all text-base">
                                </div>
                                <div class="mt-4">
                                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1 ml-2">Create PIN</label>
                                    <input type="password" x-model="loginForm.password" placeholder="****" maxlength="4" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl focus:border-blue-500 focus:bg-white outline-none font-bold text-slate-700 transition-all text-base">
                                </div>
                                
                                <div class="mt-4 p-4 bg-slate-50 rounded-2xl border-2 border-slate-100">
                                    <label class="flex items-start gap-3 cursor-pointer">
                                        <input type="checkbox" x-model="legalAccepted" class="mt-1 w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <span class="text-[10px] font-bold text-slate-500 leading-tight uppercase">
                                            I confirm I am the parent/guardian and agree to the 
                                            <a href="#" @click.prevent="showLegalDoc = 'privacy'" class="text-blue-500 underline">Privacy Policy</a> & 
                                            <a href="#" @click.prevent="showLegalDoc = 'terms'" class="text-blue-500 underline">Terms</a>. 
                                            I consent to kid-safe AI processing (COPPA/GDPR).
                                        </span>
                                    </label>
                                </div>

                                <button @click="handleSignup" :disabled="!legalAccepted" class="w-full py-4 bg-blue-500 hover:bg-blue-600 text-white rounded-2xl font-kids text-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all mt-4 disabled:opacity-50 disabled:grayscale">
                                    Start Learning! üöÄ
                                </button>
                                
                                <div class="flex items-center justify-center gap-2 mt-4 opacity-80 border-t pt-4">
                                    <i class="fas fa-shield-alt text-green-500"></i>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Strict Privacy: No Data is ever Sold to 3rd Parties.</p>
                                </div>
                            </div>
                            
                            <p class="text-center mt-4 text-xs font-bold text-gray-400 cursor-pointer hover:text-blue-500" @click="hasAccount = true">Already have an account? Login</p>
                        </div>

                        <div x-show="hasAccount" class="space-y-6">
                            <!-- PIN Entry for existing sessions -->
                            <template x-if="session && !isLoggedIn">
                                <div class="animate__animated animate__fadeIn">
                                    <div class="bg-blue-50 p-4 rounded-2xl border-2 border-blue-100">
                                        <p class="text-sm text-blue-400 font-bold uppercase tracking-wide">Device is Authorized</p>
                                        <h3 class="text-xl font-kids text-slate-800 my-4">Enter PIN to Unlock</h3>
                                        <input type="password" 
                                               x-model="pinInput" 
                                               @keyup.enter="verifyPin"
                                               maxlength="4"
                                               placeholder="****" 
                                               class="w-full p-4 bg-white border-2 border-blue-200 rounded-2xl text-center font-bold text-3xl tracking-widest outline-none focus:border-blue-500 transition-all">
                                        
                                        <div class="mt-6 space-y-3">
                                            <button @click="verifyPin" class="w-full py-4 bg-green-500 hover:bg-green-600 text-white rounded-2xl font-kids text-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all">
                                                Unlock App üîì
                                            </button>

                                            <button @click="handleLogout" class="text-xs text-blue-400 font-bold hover:underline uppercase block mx-auto py-2">
                                                Sign Out / Change Account
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <!-- Email/Password Login flow -->
                            <template x-if="!session">
                                <div class="space-y-6">
                                    <div class="bg-blue-50 p-4 rounded-2xl border-2 border-blue-100">
                                        <p class="text-sm text-blue-400 font-bold uppercase tracking-wide">Welcome Back</p>
                                        <input type="email" x-model="loginForm.email" placeholder="Enter parent email" class="w-full mt-2 p-2 bg-white border border-blue-200 rounded-xl focus:outline-none text-center font-bold text-slate-700 text-base">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Enter PIN</label>
                                        <input type="password" x-model="loginForm.password" @keyup.enter="handleLogin" placeholder="****" maxlength="4" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl focus:border-blue-500 outline-none font-bold text-slate-700 text-center text-xl">
                                        <p class="text-right mt-2"><button @click="handlePasswordReset" class="text-xs text-blue-400 font-bold hover:underline">Forgot PIN?</button></p>
                                    </div>

                                    <button @click="handleLogin" class="w-full py-4 bg-green-500 hover:bg-green-600 text-white rounded-2xl font-kids text-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all">
                                        Unlock App üîì
                                    </button>
                                    
                                    <button @click="hasAccount = false" class="text-xs text-blue-400 hover:text-blue-600 font-bold uppercase tracking-widest mt-4">Create New Account</button>
                                </div>
                            </template>
                        </div>

                        <div class="mt-8 p-4 bg-slate-50 rounded-2xl border-2 border-slate-200 text-center">
                            <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Legal & Privacy</h3>
                            <div class="flex justify-center gap-6">
                                <button @click="showLegalDoc = 'privacy'" class="text-blue-500 font-bold text-[10px] hover:underline uppercase tracking-widest">Privacy Policy</button>
                                <button @click="showLegalDoc = 'terms'" class="text-blue-500 font-bold text-[10px] hover:underline uppercase tracking-widest">Terms of Service</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="absolute top-4 left-4 z-40 flex flex-col gap-2">
            <button @click="showRewards = true; toggleScroll(true)" class="daily-reward-btn bg-white p-3 sm:p-4 rounded-2xl shadow-lg hover:scale-110 transition-transform border-b-4 border-pink-400 flex flex-col items-center justify-center">
                <span class="text-2xl sm:text-3xl gift-bounce">üéÅ</span>
                <span class="text-[10px] font-bold text-pink-500 uppercase" x-text="t('daily_gift')">Daily Gift</span>
            </button>
            <!-- Web Version: Under Daily Gift -->
            <div x-show="!isPremium" class="hidden md:flex bg-white px-3 py-2 rounded-xl shadow-lg border-2 border-orange-400 flex-col items-center min-w-[80px]">
                <p class="text-[9px] font-bold text-orange-600 uppercase text-center leading-tight">Free Questions</p>
                <p class="text-[12px] font-kids text-orange-500 leading-none mt-0.5" x-text="dailyQuestionsUsed + '/' + maxFreeQuestions"></p>
                <div class="w-full h-1 bg-gray-100 rounded-full mt-1.5 overflow-hidden">
                    <div class="h-full bg-orange-400 transition-all duration-500" :style="'width: ' + ((maxFreeQuestions - dailyQuestionsUsed) / maxFreeQuestions * 100) + '%'"></div>
                </div>
            </div>
            <div class="safe-badge animate__animated animate__fadeInLeft">
                <i class="fas fa-shield-alt"></i> Kid-Safe AI
            </div>
        </div>

        <div class="absolute top-4 right-4 flex flex-row items-center justify-end gap-1 sm:gap-4 z-40">

            <div class="bg-white px-2 py-1.5 sm:p-4 rounded-2xl shadow-lg border-b-4 border-gray-400 flex items-center gap-1 sm:gap-2">
                <span class="text-base sm:text-3xl">üí∞</span>
                <span class="font-kids text-sm sm:text-2xl text-yellow-700" x-text="coins"></span>
            </div>

            <button @click="showLearningPath = true; toggleScroll(true)" class="bg-white p-3 sm:p-4 rounded-2xl shadow-lg hover:scale-110 transition-transform border-b-4 border-green-500" :title="t('adventure_map')">
                <span class="text-xl sm:text-3xl">üó∫Ô∏è</span>
            </button>

            <button @click="showShop = true; toggleScroll(true)" class="bg-white p-3 sm:p-4 rounded-2xl shadow-lg hover:scale-110 transition-transform border-b-4 border-blue-400" :title="t('magic_auras')">
                <span class="text-xl sm:text-3xl">ü™Ñ</span>
            </button>

            <button @click="showStickerBook = true; toggleScroll(true)" class="bg-white p-3 sm:p-4 rounded-2xl shadow-lg hover:scale-110 transition-transform border-b-4 border-yellow-500" title="Sticker Book">
                <span class="text-xl sm:text-3xl">üìï</span>
            </button>

            <button @click="showProfileSwitcher = true; toggleScroll(true)" class="bg-white p-2 sm:p-4 rounded-2xl shadow-lg hover:scale-110 transition-transform border-b-4 border-orange-400" title="Switch Child">
                <div class="flex flex-col items-center">
                    <span class="text-xl sm:text-2xl">üë§</span>
                    <span class="hidden sm:block text-[9px] font-bold text-slate-400 mt-1 uppercase" x-text="childProfile.name"></span>
                </div>
            </button>

            <button @click="openParentPortal()" class="bg-white p-3 sm:p-4 rounded-2xl shadow-lg hover:scale-110 transition-transform border-b-4 border-gray-400">
                <span class="text-xl sm:text-2xl">üîí</span>
            </button>
        </div>

        <div class="container max-w-6xl mx-auto px-4 pt-28 sm:pt-12 pb-8 sm:pb-12">
            <div class="flex justify-center gap-2 sm:gap-4 mb-6 sm:mb-8">
                <template x-for="char in characters">
                    <button 
                        @click="trySetChar(char)"
                        class="char-btn w-14 h-14 sm:w-16 sm:h-16 md:w-20 md:h-20 rounded-full bg-white flex items-center justify-center text-3xl sm:text-4xl border-4 border-transparent shadow-lg"
                        :class="{
                            'active border-white': currentChar.name === char.name, 
                            'opacity-60': currentChar.name !== char.name && (!char.premium || isPremium),
                            'char-locked': char.premium && !isPremium
                        }"
                    >
                        <span x-text="char.icon"></span>
                        <div x-show="char.premium && !isPremium" class="lock-overlay">
                            <i class="fas fa-lock"></i>
                        </div>
                    </button>
                </template>
            </div>
            
            <!-- Mobile Version: Smaller & Centered -->
            <div x-show="!isPremium" class="flex md:hidden justify-center mb-6 animate__animated animate__fadeIn">
                <div class="bg-white/90 backdrop-blur-sm px-4 py-1.5 rounded-xl border-2 border-orange-300 shadow-md flex items-center gap-3 transform scale-90">
                    <div class="flex flex-col">
                        <span class="text-[8px] font-bold text-orange-600 uppercase tracking-widest leading-none">Free Questions</span>
                        <span class="font-kids text-base text-orange-500 mt-0.5" x-text="dailyQuestionsUsed + '/' + maxFreeQuestions"></span>
                    </div>
                    <div class="w-16 h-1.5 bg-gray-100 rounded-full overflow-hidden border border-orange-100">
                        <div class="h-full bg-orange-400 transition-all duration-500" :style="'width: ' + ((maxFreeQuestions - dailyQuestionsUsed) / maxFreeQuestions * 100) + '%'"></div>
                    </div>
                </div>
            </div>

            <div class="text-center mb-6 sm:mb-10">

                <p class="font-bold text-base sm:text-lg md:text-xl mt-3 opacity-80" :style="'color: ' + (currentChar?.accent || '#3b82f6')" x-text="t('teacher_of') + ' ' + (currentChar?.subject || 'Learning') + ' ‚ú®'"></p>
                <div x-show="isVisualMode" class="mt-4 animate__animated animate__fadeInDown">
                    <span class="bg-blue-100 text-blue-600 px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-widest border border-blue-200">
                        <i class="fas fa-eye mr-2"></i> Visual learning mode ON
                    </span>
                </div>
            </div>

            <div class="flex flex-col lg:flex-row items-center justify-center lg:justify-between gap-10 sm:gap-8 lg:gap-12">
                
                <div class="relative flex flex-col items-center order-2 lg:order-1">
                    
                    <div class="relative char-float select-none cursor-pointer transition-all duration-300 rounded-full" 
                        :class="[isSpeaking ? 'wiggle-speak' : '', getEquippedItemData().effectType === 'glow' ? 'effect-glow' : '', isListening ? 'listening-pulse' : '']">
                        
                        <template x-if="getEquippedItemData().effectType === 'sparkles'">
                            <div class="absolute inset-0 pointer-events-none">
                                <template x-for="i in 6">
                                    <div class="sparkle-particle text-yellow-400 text-4xl"
                                        :style="'top: ' + (Math.random() * 100) + '%; left: ' + (Math.random() * 100) + '%; animation-delay: ' + (Math.random() * 2) + 's'">
                                        ‚ú®
                                    </div>
                                </template>
                            </div>
                        </template>

                        <template x-if="getEquippedItemData().effectType === 'fireflies'">
                            <div class="absolute inset-0 pointer-events-none">
                            <template x-for="i in 5">
                                <div class="firefly-particle"
                                        :style="'top: ' + (Math.random() * 80 + 10) + '%; left: ' + (Math.random() * 80 + 10) + '%; animation-delay: ' + (Math.random() * 3) + 's'">
                                </div>
                            </template>
                            </div>
                        </template>

                        <template x-if="getEquippedItemData().effectType === 'stars'">
                            <div class="orbit-container pointer-events-none">
                                <div class="star-item text-4xl text-yellow-300" style="top: 0; left: 50%; transform: translateX(-50%);">‚≠ê</div>
                                <div class="star-item text-3xl text-yellow-400" style="bottom: 10%; left: 10%;">‚≠ê</div>
                                <div class="star-item text-3xl text-yellow-400" style="bottom: 10%; right: 10%;">‚≠ê</div>
                            </div>
                        </template>

                        <template x-if="getEquippedItemData().effectType === 'dust'">
                            <div class="absolute inset-0 pointer-events-none overflow-visible">
                            <template x-for="i in 8">
                                <div class="dust-particle text-blue-300 text-2xl"
                                        :style="'left: ' + (Math.random() * 100) + '%; animation-delay: ' + (Math.random() * 2) + 's; animation-duration: ' + (2 + Math.random()) + 's'">
                                        ü™Ñ
                                </div>
                            </template>
                            </div>
                        </template>

                        <div class="text-[6rem] sm:text-[9rem] md:text-[12rem] lg:text-[15rem]" x-text="currentMoodIcon"></div>
                    </div>
                    
                    <div x-show="isThinking" class="absolute -top-8 left-8 sm:-top-10 sm:left-10 animate__animated animate__fadeIn">
                        <div class="bg-white rounded-full px-4 py-2 shadow-lg flex flex-col items-center gap-1">
                            <div x-show="isPremium" class="text-[8px] font-bold text-amber-500 uppercase mb-1">Priority AI Processing</div>
                            <div class="flex gap-2">
                                <div class="w-3 h-3 rounded-full animate-bounce" :style="'background: ' + currentChar?.accent"></div>
                                <div class="w-3 h-3 rounded-full animate-bounce" style="animation-delay: 0.2s; background: #ff512f"></div>
                                <div class="w-3 h-3 rounded-full animate-bounce" style="animation-delay: 0.4s; background: #24d4dd"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="w-full max-w-2xl order-1 lg:order-2">
                    <!-- 30-Day Path Banner -->
                    <button @click="startDailyLesson()" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 rounded-3xl p-4 sm:p-6 mb-6 shadow-xl flex items-center justify-between text-white transform hover:scale-105 transition-all text-left group border-4 border-blue-400">
                        <div class="flex items-center gap-3 sm:gap-4">
                            <div class="bg-white/20 p-3 rounded-2xl text-2xl sm:text-3xl group-hover:rotate-12 transition-transform">üìÖ</div>
                            <div>
                                <div class="text-xs font-bold opacity-80 uppercase tracking-wider mb-1">Your Learning Plan</div>
                                <div class="text-xl sm:text-3xl font-kids" x-text="getDailyContent().title">Start Day 1</div>
                                <div class="text-xs font-bold opacity-90 mt-1 text-blue-100" x-text="getDailyContent().content.substring(0,30) + '...'"></div>
                            </div>
                        </div>
                        <div class="bg-white text-blue-600 px-3 py-2 sm:px-6 sm:py-3 rounded-2xl font-bold font-kids shadow-lg group-hover:bg-yellow-400 group-hover:text-yellow-900 transition-colors text-sm sm:text-base">
                            START <i class="fas fa-play ml-1"></i>
                        </div>
                    </button>
                    <div class="chat-bubble p-6 sm:p-8 md:p-10 mb-8 min-h-[180px] sm:min-h-[220px] flex flex-col justify-between transition-all duration-500"
                        :style="'border-color: ' + (currentChar?.accent || '#3b82f6')">
                        <div class="p-6">
                            <span class="font-kids text-base sm:text-lg uppercase tracking-widest block mb-2" :style="'color: ' + (currentChar?.accent || '#3b82f6')" x-text="(currentChar?.name || 'Owl') + ' ' + t('says') + ':'"></span>
                            <p class="text-xl sm:text-2xl md:text-3xl text-gray-800 font-semibold leading-relaxed" x-text="displayText"></p>
                        </div>
                        
                        <div class="flex flex-wrap justify-end gap-3 mt-6" x-show="hasAnswered && !isThinking">
                            <button 
                                @click="startQuiz()"
                                class="flex items-center gap-2 px-5 py-3 rounded-2xl font-kids text-base sm:text-lg transition-all transform hover:scale-110 active:scale-95 border-b-4 bg-yellow-400 border-yellow-600 text-yellow-900 shadow-md"
                            >
                                <span class="text-xl">üèÜ</span> <span x-text="t('challenge_me')">Challenge Me!</span>
                            </button>

                            <button 
                                @click="isSpeaking ? stopSpeaking() : speak(displayText)"
                                class="flex items-center gap-3 px-5 sm:px-6 py-2 sm:py-3 rounded-2xl font-kids text-base sm:text-lg transition-all transform hover:scale-110 active:scale-95 border-b-4"
                                :style="'background: ' + (currentChar?.accent || '#3b82f6') + '22; color: ' + (currentChar?.accent || '#3b82f6') + '; border-color: ' + (currentChar?.accent || '#3b82f6') + '44'"
                            >
                                <i class="fas" :class="isSpeaking ? 'fa-pause-circle' : 'fa-play-circle'"></i>
                                <span x-text="isSpeaking ? t('stop') : t('listen')"></span>
                            </button>
                        </div>
                    </div>

                    <div class="relative bg-white rounded-3xl shadow-2xl p-2 sm:p-3 border-4 transition-all flex items-center gap-2 sm:gap-4 pr-2 sm:pr-3"
                        :style="'border-color: ' + (isListening ? '#3b82f6' : (currentChar?.accent || '#3b82f6') + '44')">
                        
                        <button 
                            @click="isKeyboardMode = !isKeyboardMode; if(isKeyboardMode) { stopVoiceMode(); $nextTick(() => $refs.queryInput.focus()); }"
                            class="ml-2 sm:ml-4 text-2xl transition-all hover:scale-110"
                            :class="isKeyboardMode ? 'keyboard-active animate-pulse' : 'text-gray-400'"
                            :style="isKeyboardMode ? 'color: ' + (currentChar?.accent || '#3b82f6') : ''"
                            title="Type to Talk"
                        >
                            <i class="fas fa-keyboard"></i>
                        </button>

                        <button 
                            @click="isVoiceNativeMode ? stopVoiceMode() : startVoiceMode()"
                            class="text-2xl transition-all hover:scale-110 relative"
                            :class="isListening || isVoiceNativeMode ? 'mic-active' : 'text-gray-400'"
                            :style="(!isListening && !isVoiceNativeMode) ? 'color: ' + (currentChar?.accent || '#3b82f6') : ''"
                        >
                            <i class="fas fa-microphone"></i>
                            <span x-show="isVoiceNativeMode" class="absolute -top-2 -right-2 flex h-3 w-3">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                            </span>
                        </button>

                        <button 
                            @click="openVisionModal()"
                            class="text-2xl text-gray-400 transition-all hover:scale-110"
                            :style="'color: ' + (currentChar?.accent || '#3b82f6')"
                            title="Vision Helper"
                        >
                            <i class="fas fa-camera"></i>
                        </button>

                        <input 
                            type="text" 
                            x-model="userQuery" 
                            x-ref="queryInput"
                            @keyup="if(isKeyboardMode) playClickSound()"
                            @keyup.enter="askTutor()"
                            :placeholder="isListening ? t('listening') + '...' : (isKeyboardMode ? t('type_here') + '...' : t('ask_about') + ' ' + (currentChar?.subject || 'Learning') + '...')" 
                            class="flex-1 bg-transparent px-2 py-3 sm:py-4 outline-none text-base sm:text-xl font-bold text-gray-700 min-w-0"
                        >
                        


                        <button 
                            @click="askTutor()"
                            class="btn-grad text-white rounded-2xl px-3 py-2 sm:px-6 sm:py-2 font-kids text-xs sm:text-lg shadow-lg transform transition hover:scale-105 active:scale-90 mr-1 sm:mr-0 whitespace-nowrap"
                            :style="'background: linear-gradient(to right, ' + (currentChar?.accent || '#3b82f6') + ', #ff512f)'"
                        >
                            <span x-text="t('ask')">ASK!</span> üöÄ
                        </button>
                        
                        <div class="absolute -bottom-6 left-0 right-0 flex justify-center opacity-70">
                            <span class="text-[9px] font-bold text-slate-400 flex items-center gap-1 bg-white/80 px-2 py-0.5 rounded-full shadow-sm">
                                <i class="fas fa-lock text-green-500"></i> Safe-Response Mode ON
                            </span>
                        </div>

                    </div>

                    <div class="mt-6 sm:mt-8 flex flex-wrap gap-2 sm:gap-3 justify-center">
                        <template x-for="q in (currentChar?.suggestions || suggestions)">
                            <button 
                                @click="userQuery = q; askTutor()"
                                class="bg-white hover:bg-opacity-90 px-3 py-1.5 sm:px-5 sm:py-2 rounded-full text-xs sm:text-sm font-bold shadow-sm hover:shadow-md transition-all border-2"
                                :style="'color: ' + (currentChar?.accent || '#3b82f6') + '; border-color: ' + (currentChar?.accent || '#3b82f6') + '22'"
                                x-text="q">
                            </button>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="showVisionModal" x-cloak class="fixed inset-0 z-[80] flex items-center justify-center p-6 bg-black bg-opacity-80" x-transition.opacity>
            <div @click.away="!isThinking ? closeVisionModal() : null" class="bg-white rounded-[2.5rem] max-w-lg w-full p-8 shadow-2xl relative animate__animated animate__zoomIn border-4 border-blue-200">
                <button @click="closeVisionModal()" class="absolute top-6 right-6 text-2xl text-gray-400 hover:text-gray-600"><i class="fas fa-times-circle"></i></button>
                
                <h2 class="text-3xl font-kids text-blue-500 text-center mb-2">Vision Studio üì∏</h2>
                <p class="text-center text-gray-500 font-bold mb-6">Show me your homework or a drawing!</p>

                <div class="flex flex-col items-center gap-6">
                    <!-- Standard Upload / Preview Area -->
                    <div x-show="!isCameraActive" class="w-full aspect-[3/4] md:aspect-video bg-gray-50 rounded-2xl border-4 border-dashed border-gray-200 flex items-center justify-center overflow-hidden relative group">
                        <template x-if="visionPreview">
                            <img :src="visionPreview" class="w-full h-full object-contain">
                        </template>
                        <template x-if="!visionPreview">
                            <div class="text-center">
                                <i class="fas fa-image text-4xl text-gray-300 mb-2"></i>
                                <p class="text-xs font-bold text-gray-400">SELECT A PHOTO</p>
                            </div>
                        </template>
                        
                        <input type="file" @change="handleVisionUpload" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
                    </div>

                    <!-- Live Camera Area -->
                    <div x-show="isCameraActive" class="w-full aspect-[3/4] md:aspect-video bg-black rounded-2xl flex items-center justify-center overflow-hidden relative">
                        <video x-ref="cameraFeed" autoplay playsinline class="w-full h-full object-cover"></video>
                        <canvas x-ref="cameraCanvas" class="hidden"></canvas>
                    </div>

                    <div x-show="isThinking" class="flex flex-col items-center">
                        <div class="spinner border-blue-500 mb-2"></div>
                        <p class="font-kids text-blue-500 animate-pulse">Analyzing magic...</p>
                    </div>

                    <div class="flex flex-col w-full gap-3" x-show="!isThinking">
                        <!-- Camera Controls -->
                        <div class="flex gap-2">
                             <button x-show="!isCameraActive && !visionPreview" @click="startCamera()" class="flex-1 py-3 bg-blue-100 text-blue-600 rounded-xl font-bold hover:bg-blue-200 transition-colors">
                                <i class="fas fa-camera mr-2"></i> Use Camera
                            </button>
                            
                            <button x-show="isCameraActive" @click="capturePhoto()" class="flex-1 py-3 bg-white border-4 border-blue-500 text-blue-600 rounded-full font-bold hover:bg-blue-50 transition-colors shadow-lg">
                                <i class="fas fa-circle mr-2"></i> SNAP PHOTO
                            </button>

                            <button x-show="isCameraActive" @click="stopCamera()" class="px-4 py-3 bg-gray-100 text-gray-500 rounded-xl font-bold hover:bg-gray-200 transition-colors">
                                Cancel
                            </button>
                        </div>

                        <!-- Action Buttons -->
                        <button 
                            x-show="visionPreview && !isCameraActive"
                            @click="analyzeImage()"
                            class="w-full py-4 bg-blue-500 text-white rounded-2xl font-kids text-xl shadow-lg hover:scale-105 transition-transform"
                        >
                            Explain it to me! üöÄ
                        </button>

                        <button x-show="visionPreview && !isCameraActive" @click="visionFile = null; visionPreview = null" class="text-xs font-bold text-gray-400 uppercase tracking-widest">
                            Clear / Retake
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="showStickerBook" x-cloak class="fixed inset-0 z-[65] bg-slate-900 bg-opacity-95 flex items-center justify-center p-4 sm:p-6" x-transition.opacity>
            <div class="bg-white rounded-[2.5rem] w-full max-w-4xl h-full max-h-[90vh] flex flex-col shadow-2xl overflow-hidden animate__animated animate__zoomIn">
                <div class="p-6 sm:p-8 border-b-4 border-gray-100 flex justify-between items-center bg-white z-10">
                    <div>
                        <h2 class="text-3xl font-kids text-slate-800">Sticker Book üìï</h2>
                        <p class="text-gray-500 font-bold uppercase tracking-widest text-xs mt-1">Collect them all, <span x-text="childProfile.name"></span>!</p>
                    </div>
                    <button @click="showStickerBook = false; toggleScroll(false)" class="bg-gray-100 p-3 rounded-full hover:bg-red-100 text-gray-500 hover:text-red-500 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-6 sm:p-10 bg-slate-50">
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-6 sm:gap-8">
                        <template x-for="badge in availableBadges" :key="badge.id">
                            <div class="relative group">
                                <div class="bg-white rounded-3xl p-6 shadow-lg flex flex-col items-center text-center transition-all transform hover:scale-105"
                                     :class="learningStats.achievements.includes(badge.id) ? 'border-4 border-yellow-400 opacity-100' : 'border-4 border-dashed border-gray-200 opacity-50 grayscale'">
                                    
                                    <div class="w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-slate-50 flex items-center justify-center text-4xl sm:text-5xl mb-4 shadow-inner">
                                        <span x-text="learningStats.achievements.includes(badge.id) ? badge.icon : '‚ùì'"></span>
                                    </div>
                                    
                                    <h3 class="font-kids text-lg sm:text-xl text-slate-800 mb-1" x-text="learningStats.achievements.includes(badge.id) ? badge.name : 'Unknown'"></h3>
                                    <p class="text-[10px] sm:text-xs font-bold text-slate-400 leading-tight uppercase tracking-wider" x-text="badge.desc"></p>
                                    
                                    <template x-if="learningStats.achievements.includes(badge.id)">
                                        <div class="absolute -top-2 -right-2 bg-yellow-400 text-yellow-900 w-8 h-8 rounded-full flex items-center justify-center shadow-lg animate__animated animate__bounceIn">
                                            <i class="fas fa-check text-sm"></i>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div class="mt-12 bg-white/50 rounded-3xl p-6 border-2 border-dashed border-gray-200 flex flex-col items-center">
                        <p class="text-slate-400 font-bold uppercase tracking-widest text-xs mb-2">Progress</p>
                        <div class="w-full max-w-xs bg-gray-200 rounded-full h-4 overflow-hidden shadow-inner">
                            <div class="h-full bg-gradient-to-r from-yellow-400 to-orange-500 transition-all duration-1000" 
                                 :style="'width: ' + (learningStats.achievements.length / availableBadges.length * 100) + '%'"></div>
                        </div>
                        <p class="mt-3 font-kids text-slate-600" x-text="learningStats.achievements.length + ' / ' + availableBadges.length + ' Badges Earned'"></p>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="showLearningPath" x-cloak class="fixed inset-0 z-[65] bg-slate-100 flex items-center justify-center p-0" x-transition.opacity>
            <div class="w-full h-full max-w-5xl mx-auto flex flex-col bg-white sm:rounded-[2rem] shadow-2xl relative overflow-hidden">
                
                <div class="p-6 bg-white border-b-4 border-gray-100 flex justify-between items-center z-20 shadow-sm">
                    <div>
                        <h2 class="text-3xl font-kids text-slate-800" x-text="t('adventure_map')">Adventure Map üó∫Ô∏è</h2>
                        <p class="text-gray-500 font-bold" x-show="!currentPath" x-text="t('choose_journey')">Choose your journey!</p>
                        <p class="text-gray-500 font-bold" x-show="currentPath" x-text="currentPath ? currentPath.name : ''"></p>
                    </div>
                    <div class="flex gap-2">
                        <button @click="resetMapProgress()" class="bg-red-100 p-3 rounded-full hover:bg-red-200 text-red-500 transition-colors" title="Reset Progress">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button @click="showLearningPath = false; currentPath = null; toggleScroll(false)" class="bg-gray-100 p-3 rounded-full hover:bg-red-100 text-gray-500 hover:text-red-500 transition-colors">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                </div>

                <div x-show="!currentPath" class="flex-1 overflow-y-auto p-8 bg-slate-50">
                    <div x-show="isPremium" class="mb-10 bg-gradient-to-r from-amber-400 to-orange-500 rounded-3xl p-6 text-white shadow-xl animate__animated animate__fadeIn">
                        <div class="flex items-center gap-4">
                            <div class="text-4xl bg-white/20 p-3 rounded-2xl">üéØ</div>
                            <div>
                                <h3 class="font-kids text-2xl" x-text="t('personalized_mission')">Personalized Mission</h3>
                                <p class="font-bold opacity-90" x-text="'Goal: Complete ' + (childProfile.ageRange === '4-5' ? '10 simple counts' : '5 Science lessons') + ' this week!'"></p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mt-8 pb-12">
                        <template x-for="path in curriculum">
                            <button @click="currentPath = path" class="bg-white rounded-[2rem] p-8 shadow-lg hover:shadow-2xl transition-all transform hover:-translate-y-2 border-b-8 border-gray-200 group flex flex-col items-center text-center relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-full h-2 group-hover:h-full transition-all duration-500 opacity-10" :class="path.color"></div>
                                
                                <div class="w-24 h-24 rounded-full bg-gray-50 flex items-center justify-center text-5xl mb-6 shadow-inner group-hover:scale-110 transition-transform">
                                    <span x-text="path.icon"></span>
                                </div>
                                
                                <div class="flex items-center gap-2 mb-2">
                                    <h3 class="text-2xl font-kids text-gray-800" x-text="path.name"></h3>
                                    <i x-show="path.premium && !isPremium" class="fas fa-lock text-slate-400 text-sm"></i>
                                </div>
                                <span class="bg-gray-100 text-gray-500 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mb-4" x-text="path.grade"></span>
                                
                                <div class="w-full bg-gray-100 rounded-full h-3 overflow-hidden">
                                    <div class="h-full rounded-full transition-all duration-1000" :class="path.color" :style="'width: ' + getPathProgress(path.id) + '%'"></div>
                                </div>
                                <p class="text-xs text-gray-400 font-bold mt-2" x-text="Math.round(getPathProgress(path.id)) + '% ' + t('complete')"></p>

                                <template x-if="isPremium && getPathProgress(path.id) === 100">
                                    <button @click.stop="printCertificate(path)" class="mt-4 bg-amber-400 text-amber-900 px-4 py-2 rounded-xl text-xs font-kids shadow-lg hover:scale-105 transition-transform">
                                        üéì Claim Certificate
                                    </button>
                                </template>
                            </button>
                        </template>

                        <button @click="generateNewPath()" 
                                class="bg-white rounded-[2rem] p-8 border-4 border-dashed border-purple-200 hover:border-purple-400 group transition-all flex flex-col items-center text-center relative overflow-hidden"
                                :disabled="isGeneratingPath">
                            <div x-show="isGeneratingPath" class="absolute inset-0 bg-white/80 z-20 flex flex-col items-center justify-center">
                                <div class="spinner border-purple-500 mb-4"></div>
                                <p class="font-kids text-purple-600 animate-pulse text-sm">Magic in progress...</p>
                            </div>
                            <div class="w-24 h-24 rounded-full bg-purple-50 flex items-center justify-center text-5xl mb-6 group-hover:rotate-12 transition-transform">
                            ‚ú®
                            </div>
                            <h3 class="text-2xl font-kids text-purple-600 mb-2">Magic Wand</h3>
                            <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">Generate New Quest</p>
                            <div class="mt-6 text-[10px] bg-purple-100 text-purple-600 px-3 py-1 rounded-full font-bold">Powered by AI ü™Ñ</div>
                        </button>
                    </div>
                </div>

                <div x-show="currentPath" class="flex-1 overflow-y-auto relative bg-slate-50 custom-scroll">
                    <button @click="currentPath = null" class="absolute top-4 left-4 z-20 bg-white px-4 py-2 rounded-xl shadow-md font-bold text-gray-600 hover:text-blue-500">
                        <i class="fas fa-arrow-left mr-2"></i> Back
                    </button>

                    <div x-show="currentPath && currentPath.premium && !isPremium" class="absolute inset-0 z-30 bg-white/90 flex flex-col items-center justify-center text-center p-8 backdrop-blur-sm">
                        <div class="text-6xl mb-4">üëë</div>
                        <h2 class="text-3xl font-kids text-slate-800 mb-2">Premium Curriculum</h2>
                        <p class="text-slate-500 font-bold max-w-sm mb-6">Unlock all Adventure Paths, Personalized Plans, and Certificates for just $4.99/mo!</p>
                        <button @click="showPremiumModal = true; showLearningPath = false" class="bg-yellow-400 text-yellow-900 px-8 py-3 rounded-2xl font-kids text-xl shadow-lg border-b-4 border-yellow-600">Upgrade Now</button>
                    </div>

                    <div class="flex flex-col items-center py-20 px-4 min-h-full">
                        <template x-for="(level, index) in currentPath ? currentPath.levels : []">
                            <div class="relative flex flex-col items-center w-full max-w-md z-10">
                                
                                <div x-show="index < currentPath.levels.length - 1" 
                                    class="level-connector h-24 top-16 w-3"
                                    :class="isLevelUnlocked(currentPath.id, index + 2) ? currentPath.color : 'bg-gray-200'">
                                </div>

                                <button 
                                    @click="isLevelUnlocked(currentPath.id, level.id) ? openLesson(level) : null"
                                    class="w-20 h-20 rounded-full flex items-center justify-center border-4 shadow-xl relative transition-transform hover:scale-110 z-10 bg-white"
                                    :class="[
                                        isLevelUnlocked(currentPath.id, level.id) ? ('border-white ' + currentPath.color + ' text-white') : 'border-gray-300 bg-gray-100 text-gray-400 cursor-not-allowed',
                                        isLevelComplete(currentPath.id, level.id) ? 'ring-4 ring-green-400 ring-offset-2' : ''
                                    ]"
                                >
                                    <span x-show="isLevelComplete(currentPath.id, level.id)" class="text-3xl">üèÜ</span>
                                    <span x-show="!isLevelComplete(currentPath.id, level.id) && isLevelUnlocked(currentPath.id, level.id)" class="text-2xl font-bold" x-text="level.id"></span>
                                    <i x-show="!isLevelUnlocked(currentPath.id, level.id)" class="fas fa-lock"></i>
                                </button>

                                <div class="relative z-10 bg-white px-4 py-2 rounded-xl shadow-md mt-3 mb-16 text-center border-2" 
                                    :class="isLevelUnlocked(currentPath.id, level.id) ? 'border-gray-100' : 'border-transparent opacity-50'">
                                    <h4 class="font-bold text-slate-700 text-sm" x-text="level.title"></h4>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="activeLesson" x-cloak class="fixed inset-0 z-[70] bg-black bg-opacity-90 flex items-center justify-center p-4" x-transition.opacity>
            <div class="bg-white rounded-[2rem] max-w-2xl w-full max-h-[90vh] overflow-y-auto p-0 relative animate__animated animate__zoomIn">
                
                <div class="bg-slate-100 p-6 flex justify-between items-center sticky top-0 z-10">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-xl text-white shadow-sm" :class="currentPath ? currentPath.color : 'bg-gray-500'">
                            <span x-text="activeLesson ? activeLesson.id : ''"></span>
                        </div>
                        <h3 class="font-bold text-xl text-slate-800" x-text="activeLesson ? activeLesson.title : ''"></h3>
                    </div>
                    <button @click="closeLesson()" class="text-gray-400 hover:text-red-500 text-2xl"><i class="fas fa-times-circle"></i></button>
                </div>

                <div class="p-8">
                    <div x-show="lessonStep === 'learn'" class="text-center">
                        <div class="text-6xl mb-6 bounce">üë®‚Äçüè´</div>
                        <p class="text-xl sm:text-2xl text-slate-700 font-medium leading-relaxed mb-8" x-text="activeLesson ? activeLesson.content : ''"></p>
                        
                        <button @click="speak(activeLesson.content)" class="mb-8 text-blue-500 font-bold hover:underline"><i class="fas fa-volume-up mr-2"></i> <span x-text="t('read_to_me')">Read to me</span></button>

                        <button @click="lessonStep = 'quiz'" class="w-full py-4 bg-green-500 text-white rounded-2xl font-kids text-xl shadow-lg hover:bg-green-600 transition-transform transform hover:scale-105">
                            <span x-text="t('start_quiz')">Start Quiz!</span> üìù
                        </button>
                    </div>

                    <div x-show="lessonStep === 'quiz'" class="text-left">
                        <div class="mb-4 flex justify-between items-center">
                            <span class="text-xs font-bold uppercase text-gray-400">Question <span x-text="currentLessonQuizIndex + 1"></span>/3</span>
                            <div class="flex gap-1">
                                <template x-for="i in 3">
                                    <div class="w-2 h-2 rounded-full transition-colors" :class="i <= currentLessonQuizIndex ? 'bg-blue-500' : 'bg-gray-200'"></div>
                                </template>
                            </div>
                        </div>

                        <h3 class="text-2xl font-bold text-gray-800 mb-6" x-text="getCurrentLessonQuestion().q"></h3>

                        <div class="space-y-3">
                            <template x-for="(opt, idx) in getCurrentLessonQuestion().options">
                                <button 
                                    @click="checkLessonAnswer(idx)"
                                    class="w-full p-4 rounded-xl border-2 border-gray-100 hover:bg-blue-50 hover:border-blue-300 text-left font-bold text-gray-700 transition-all flex items-center gap-3"
                                >
                                    <span class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-xs text-gray-500" x-text="['A','B','C'][idx]"></span>
                                    <span x-text="opt"></span>
                                </button>
                            </template>
                        </div>
                    </div>

                    <div x-show="lessonStep === 'success'" class="text-center py-8">
                        <div class="text-8xl mb-4 animate__animated animate__tada">üéâ</div>
                        <h2 class="text-4xl font-kids text-green-500 mb-2">Lesson Complete!</h2>
                        <p class="text-gray-500 font-bold mb-8">You are getting smarter!</p>
                        
                        <div class="flex justify-center gap-4 mb-8">
                            <div class="bg-yellow-50 px-6 py-3 rounded-2xl border border-yellow-200">
                                <span class="text-2xl">üí∞</span> <span class="font-bold text-yellow-700">+50 Coins</span>
                            </div>
                            <div class="bg-purple-50 px-6 py-3 rounded-2xl border border-purple-200">
                                <span class="text-2xl">‚≠ê</span> <span class="font-bold text-purple-700">+100 XP</span>
                            </div>
                        </div>

                        <button @click="completeLesson()" class="w-full py-4 bg-blue-500 text-white rounded-2xl font-kids text-xl shadow-lg hover:bg-green-600 transition-transform transform hover:scale-105">
                            Continue Journey üöÄ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="showQuiz" x-cloak class="fixed inset-0 z-[80] flex items-center justify-center p-6 bg-black bg-opacity-80" x-transition.opacity>
            <div @click.away="showQuiz = false; toggleScroll(false)" class="bg-white rounded-[2.5rem] max-w-lg w-full p-8 shadow-2xl relative animate__animated animate__bounceIn">
                <button @click="showQuiz = false; toggleScroll(false)" class="absolute top-6 right-6 text-2xl text-gray-400 hover:text-gray-600"><i class="fas fa-times-circle"></i></button>
                
                <div class="text-center" x-show="quizState === 'loading'">
                    <div class="spinner mx-auto mb-4 border-yellow-400"></div>
                    <h2 class="text-2xl font-kids text-yellow-500" x-text="t('thinking') + '... ü§î'">Thinking up a tricky one... ü§î</h2>
                    <p class="text-xs text-slate-400 font-bold mt-2" x-text="'Adjusting difficulty for ' + (childProfile.ageRange || '6-7') + ' year olds...'"></p>
                </div>

                <div x-show="quizState === 'active'">
                    <span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide">Pop Quiz!</span>
                    <h2 class="text-2xl font-bold text-gray-800 mt-4 mb-6 leading-tight" x-text="quizQuestion"></h2>
                    
                    <div class="space-y-3">
                        <template x-for="(option, index) in quizOptions">
                            <button 
                                @click="checkAnswer(index)"
                                class="w-full text-left p-4 rounded-2xl border-2 border-gray-100 hover:border-blue-400 hover:bg-blue-50 transition-all font-bold text-gray-700 flex items-center gap-3"
                            >
                                <span class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-sm font-bold" x-text="['A','B','C'][index]"></span>
                                <span x-text="option"></span>
                            </button>
                        </template>
                    </div>
                </div>

                <div class="text-center" x-show="quizState === 'correct'">
                    <div class="text-6xl mb-4 animate__animated animate__tada">üéâ</div>
                    <h2 class="text-3xl font-kids text-green-500 mb-2" x-text="t('correct') + '!'">Correct!</h2>
                    <p class="font-bold text-gray-500 mb-6">You earned 20 Coins!</p>
                    <button @click="showQuiz = false; toggleScroll(false)" class="bg-green-500 text-white px-8 py-3 rounded-xl font-kids shadow-lg hover:scale-105 transition-transform" x-text="t('awesome')">Awesome!</button>
                </div>

                <div class="text-center" x-show="quizState === 'wrong'">
                    <div class="text-6xl mb-4 animate__animated animate__shakeX">üòÖ</div>
                    <h2 class="text-3xl font-kids text-orange-500 mb-2">Oops!</h2>
                    <p class="font-bold text-gray-500 mb-6" x-text="consecutiveMistakes >= 2 ? 'Let\'s try something easier together!' : 'That wasn\'t quite right. Try again?'"></p>
                    <button @click="quizState = 'active'" class="bg-orange-400 text-white px-8 py-3 rounded-xl font-kids shadow-lg hover:scale-105 transition-transform">Try Again</button>
                </div>
            </div>
        </div>

        <div x-show="showDailyPath" x-cloak class="fixed inset-0 z-[100] bg-slate-100 flex items-center justify-center p-0" x-transition.opacity>
            <div class="w-full h-full max-w-5xl mx-auto flex flex-col bg-white sm:rounded-[2rem] shadow-2xl relative overflow-hidden">
                <!-- Header -->
                <div class="p-6 bg-white border-b-4 border-gray-100 flex justify-between items-center z-20 shadow-sm">
                    <div>
                        <h2 class="text-3xl font-kids text-slate-800" x-text="getDailyContent().title"></h2>
                         <p class="text-gray-500 font-bold" x-text="'Current Progress: Day ' + learningPathDay + ' of 30'"></p>
                    </div>
                    <button @click="showDailyPath = false; toggleScroll(false)" class="bg-gray-100 p-3 rounded-full hover:bg-red-100 text-gray-500 hover:text-red-500 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-8 bg-slate-50 flex flex-col items-center">
                    <p class="text-xl sm:text-2xl text-slate-600 font-medium mb-12 text-center max-w-3xl leading-relaxed" x-text="getDailyContent().content"></p>
                    
                    <!-- Type: Alphabet -->
                    <div x-show="getDailyContent().type === 'alphabet'" class="grid grid-cols-2 sm:grid-cols-5 gap-6 w-full max-w-4xl animate__animated animate__fadeInUp">
                        <template x-for="letter in getDailyContent().letters || []">
                            <div class="aspect-square bg-white rounded-3xl shadow-lg border-b-8 border-gray-200 flex items-center justify-center text-7xl font-kids text-blue-500 hover:scale-110 hover:-translate-y-2 transition-all cursor-pointer active:scale-95 active:border-b-0" @click="speakLetter(letter)">
                                <span x-text="letter"></span>
                            </div>
                        </template>
                    </div>

                    <!-- Type: Words -->
                    <div x-show="getDailyContent().type === 'words'" class="grid grid-cols-1 sm:grid-cols-3 gap-8 w-full max-w-5xl animate__animated animate__fadeInUp">
                        <template x-for="word in getDailyContent().words || []">
                            <div class="bg-white p-10 rounded-[2.5rem] shadow-xl border-b-8 border-green-200 flex flex-col items-center hover:-translate-y-2 transition-transform cursor-pointer group" @click="speak(word.word); playPing()">
                                <div class="text-8xl mb-6 group-hover:scale-125 transition-transform" x-text="word.icon"></div>
                                <div class="text-4xl font-kids text-slate-800" x-text="word.word"></div>
                            </div>
                        </template>
                    </div>

                    <!-- Type: Quiz (Simple Placeholder for now) -->
                    <div x-show="getDailyContent().type === 'quiz'" class="w-full max-w-3xl bg-white p-10 rounded-[2.5rem] shadow-xl text-center border-4 border-blue-100 animate__animated animate__zoomIn">
                        <h3 class="text-3xl font-bold mb-8 text-blue-600">Quick Check!</h3>
                        <template x-for="(q, idx) in getDailyContent().quiz || []">
                            <div class="mb-10 last:mb-0">
                                <p class="text-2xl font-bold text-slate-700 mb-6" x-text="q.q"></p>
                                <div class="flex flex-wrap gap-4 justify-center">
                                    <template x-for="(opt, optIdx) in q.options">
                                        <button @click="if(optIdx === q.correct) { playPing(); confetti({particleCount: 50, spread: 50}); alert('Correct! üéâ'); } else { alert('Try again!'); }" 
                                                class="bg-blue-50 hover:bg-blue-500 hover:text-white text-blue-600 px-8 py-4 rounded-2xl font-bold text-lg transition-all shadow-sm border-2 border-blue-100" x-text="opt"></button>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Type: Report -->
                    <div x-show="getDailyContent().type === 'report'" class="text-center bg-white p-12 rounded-[3rem] shadow-2xl w-full max-w-3xl border-8 border-yellow-300 animate__animated animate__tada">
                        <div class="text-9xl mb-6">üèÜ</div>
                        <h3 class="text-5xl font-kids text-yellow-600 mb-4">Super Star!</h3>
                        <p class="text-2xl text-gray-500 font-bold mb-10">You completed Week 1!</p>
                        <div class="flex justify-center gap-4">
                            <div class="bg-blue-50 px-8 py-4 rounded-3xl">
                                <span class="block text-3xl font-bold text-blue-600">7</span>
                                <span class="text-xs font-bold text-blue-400 uppercase">Days Streak</span>
                            </div>
                            <div class="bg-purple-50 px-8 py-4 rounded-3xl">
                                <span class="block text-3xl font-bold text-purple-600">A+</span>
                                <span class="text-xs font-bold text-purple-400 uppercase">Grade</span>
                            </div>
                        </div>
                    </div>

                    <!-- Generic/Fallback -->
                    <div x-show="!['alphabet','words','quiz','report'].includes(getDailyContent().type)" class="text-center mt-10">
                        <div class="w-40 h-40 bg-white rounded-full flex items-center justify-center text-8xl shadow-xl mx-auto mb-8 animate-bounce">üöÄ</div>
                        <h3 class="text-3xl font-kids text-slate-700 mb-4" x-text="getDailyContent().task"></h3>
                        <button @click="showDailyPath = false; $nextTick(() => $refs.queryInput.focus())" class="mt-8 bg-gradient-to-r from-purple-500 to-pink-500 text-white px-12 py-5 rounded-full font-bold text-xl shadow-xl hover:scale-105 transition-transform hover:shadow-2xl">
                            Go to Chat & Ask! <i class="fas fa-comment-dots ml-2"></i>
                        </button>
                    </div>

                </div>

                <!-- Footer -->
                <div class="p-6 bg-white border-t flex justify-between items-center z-20">
                     <button @click="if(learningPathDay > 1) learningPathDay--" :disabled="learningPathDay <= 1" class="text-gray-400 font-bold hover:text-blue-500 disabled:opacity-50 transition-colors flex items-center gap-2"><i class="fas fa-chevron-left"></i> Previous</button>
                     
                     <div class="w-full max-w-xs mx-4 bg-gray-100 rounded-full h-4 relative">
                        <div class="absolute inset-0 bg-gray-200 rounded-full"></div>
                        <div class="absolute left-0 top-0 bottom-0 bg-green-400 rounded-full transition-all duration-1000" :style="'width: ' + ((learningPathDay / 30) * 100) + '%'"></div>
                     </div>

                     <button @click="if(learningPathDay < 30) learningPathDay++" :disabled="learningPathDay >= 30" class="bg-green-500 text-white px-8 py-3 rounded-2xl font-bold shadow-lg hover:bg-green-600 transition-transform active:scale-95 flex items-center gap-2">Next <i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>

        <div x-show="showLegalDoc" x-cloak class="fixed inset-0 z-[110] flex items-center justify-center p-6 bg-black bg-opacity-80" x-transition.opacity>
            <div class="bg-white rounded-[2rem] max-w-lg w-full p-8 shadow-2xl relative flex flex-col max-h-[80vh]">
                <button @click="showLegalDoc = null" class="absolute top-6 right-6 text-2xl text-gray-400 hover:text-gray-600"><i class="fas fa-times-circle"></i></button>
                <h2 class="text-2xl font-kids mb-4 text-slate-800" x-text="showLegalDoc === 'privacy' ? 'Privacy Policy' : 'Terms of Service'"></h2>
                <div class="overflow-y-auto pr-2 text-sm text-slate-600 space-y-4">
                    
                    <template x-if="showLegalDoc === 'privacy'">
                        <div class="space-y-4">
                            <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                                <p class="font-bold text-green-700 flex items-center gap-2"><i class="fas fa-shield-alt"></i> STRICT NO DATA SALE POLICY</p>
                                <p class="text-xs text-green-800 mt-1">We do NOT sell, trade, or rent your child's personal identification information to others. Ever.</p>
                            </div>

                            <div>
                                <h3 class="font-bold text-slate-800">1. Information We Collect (Strictly Necessary Only)</h3>
                                <ul class="list-disc ml-4 text-xs space-y-1 mt-1">
                                    <li><strong>Parent Email:</strong> Used solely for account recovery and login.</li>
                                    <li><strong>PIN Code:</strong> Encrypted locally and used for parental controls.</li>
                                    <li><strong>Progress Data:</strong> Coins, inventory, and learning stats (synced securely).</li>
                                </ul>
                            </div>

                            <div>
                                <h3 class="font-bold text-slate-800">2. What We Do NOT Collect</h3>
                                <p>We do NOT store voice recordings. Voice inputs are processed instantly and discarded. We do not collect GPS location or physical addresses.</p>
                            </div>

                            <div>
                                <h3 class="font-bold text-slate-800">3. AI & COPPA Compliance</h3>
                                <p>Our AI interactions are filtered for safety. No personally identifiable information (PII) is sent to AI models for training purposes. We use stateless inference APIs.</p>
                            </div>

                            <div>
                                <h3 class="font-bold text-slate-800">4. Your Rights</h3>
                                <p>You can delete your account and all associated data instantly via the "Reset Account" button in the login screen.</p>
                            </div>
                        </div>
                    </template>

                    <template x-if="showLegalDoc === 'terms'">
                        <div class="space-y-4">
                            <div>
                                <h3 class="font-bold text-slate-800">1. Acceptance of Terms</h3>
                                <p>By accessing AI Tutor, you agree to be bound by these Terms of Service. This app is intended for educational use by children under parental supervision.</p>
                            </div>

                            <div>
                                <h3 class="font-bold text-slate-800">2. Parental Responsibility</h3>
                                <p>You represent that you are the parent or legal guardian of the child using this app. You are responsible for maintaining the confidentiality of your PIN.</p>
                            </div>

                            <div>
                                <h3 class="font-bold text-slate-800">3. Subscriptions & Payments</h3>
                                <p>Premium features are offered on a monthly basis. You may cancel at any time via the Parent Portal. (Note: This is a demo application; payments are simulated).</p>
                            </div>

                            <div>
                                <h3 class="font-bold text-slate-800">4. Limitation of Liability</h3>
                                <p>The app is provided "as is". While we strive for educational accuracy, AI responses may occasionally vary. We are not liable for incidental damages.</p>
                            </div>
                        </div>
                    </template>

                </div>
            </div>
        </div>

        <div x-show="showShop" x-cloak
            class="fixed inset-0 z-50 flex items-center justify-center p-0 sm:p-6 bg-black bg-opacity-70 overflow-y-auto"
            x-transition.opacity>
            <div @click.away="showShop = false; toggleScroll(false)" class="bg-white rounded-none sm:rounded-[3rem] max-w-none sm:max-w-2xl w-full h-full sm:h-auto sm:max-h-[90vh] p-4 sm:p-8 shadow-2xl relative animate__animated animate__zoomIn border-0 sm:border-4 border-blue-200 overflow-y-auto flex flex-col">
                <button @click="showShop = false; toggleScroll(false)" class="absolute top-4 right-4 sm:top-6 sm:right-6 text-2xl text-gray-400 hover:text-gray-600 z-10">
                    <i class="fas fa-times-circle"></i>
                </button>
                
                <h2 class="text-3xl sm:text-4xl font-kids text-center mb-2 text-purple-600" x-text="t('magic_auras')">Magic Auras</h2>
                <p class="text-center text-gray-500 font-bold mb-6 sm:mb-8">Add magic effects to your teacher!</p>
                
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 sm:gap-6">
                    <template x-for="item in shopItems">
                        <div class="flex flex-col items-center gap-2 sm:gap-3 p-2 sm:p-4 rounded-2xl border-2 transition-all hover:scale-105"
                            :class="equippedItem === item.id ? 'bg-purple-50 border-purple-400 ring-2 ring-purple-200' : 'bg-gray-50 border-gray-100'">
                            
                            <div class="relative w-16 h-16 sm:w-24 sm:h-24 flex items-center justify-center bg-white rounded-full shadow-inner text-3xl sm:text-5xl">
                                <span x-text="item.icon"></span>
                                <div x-show="inventory.includes(item.id)" class="absolute -bottom-1 -right-1 sm:-bottom-2 sm:-right-2 bg-green-500 text-white rounded-full w-6 h-6 sm:w-8 sm:h-8 flex items-center justify-center text-[10px] sm:text-xs border-2 border-white">
                                    <i class="fas fa-check"></i>
                                </div>
                            </div>
                            
                            <div class="text-center w-full">
                                <h3 class="font-bold text-gray-700 text-xs sm:text-base truncate w-full" x-text="item.name"></h3>
                                <div x-show="!inventory.includes(item.id)" class="text-yellow-600 font-bold text-xs sm:text-sm bg-yellow-100 px-2 sm:px-3 py-0.5 sm:py-1 rounded-full mt-1 inline-block">
                                    <span x-text="item.price"></span> üí∞
                                </div>
                            </div>

                            <button 
                                @click="inventory.includes(item.id) ? toggleEquip(item.id) : buyItem(item)"
                                class="w-full py-1.5 sm:py-2 rounded-xl font-bold text-xs sm:text-sm shadow-md transition-transform active:scale-95"
                                :class="inventory.includes(item.id) 
                                    ? (equippedItem === item.id ? 'bg-purple-500 text-white' : 'bg-gray-200 text-gray-600') 
                                    : (coins >= item.price ? 'bg-green-500 text-white hover:bg-green-600' : 'bg-gray-300 text-gray-500 cursor-not-allowed')"
                                :disabled="!inventory.includes(item.id) && coins < item.price"
                            >
                                <span x-text="(inventory.includes(item.id) || inventory.includes(String(item.id))) ? (equippedItem === item.id ? 'Active Now' : t('activate')) : t('buy_now')"></span>
                            </button>
                        </div>
                    </template>
                </div>
                
                <div class="mt-6 sm:mt-8 flex justify-center">
                    <div class="bg-yellow-100 px-4 sm:px-6 py-2 rounded-full flex items-center gap-2 border-2 border-yellow-300">
                        <span class="text-xl sm:text-2xl">üí∞</span>
                        <span class="font-bold text-sm sm:text-base text-yellow-800" x-text="'You have ' + coins + ' coins'"></span>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="showRewards" x-cloak
            class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black bg-opacity-70"
            x-transition.opacity>
            <div @click.away="showRewards = false; toggleScroll(false)" class="bg-white rounded-[3rem] max-w-md w-full p-8 shadow-2xl relative animate__animated animate__backInDown text-center">
                <button @click="showRewards = false; toggleScroll(false)" class="absolute top-6 right-6 text-2xl text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times-circle"></i>
                </button>
                <h2 class="text-4xl font-kids text-pink-500 mb-2" x-text="t('daily_rewards')">Daily Rewards!</h2>
                <p class="font-bold text-gray-500 mb-6">Come back every day for free coins!</p>
                <div class="grid grid-cols-4 gap-3 mb-8">
                    <template x-for="(day, index) in ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']">
                        <div class="p-3 rounded-2xl border-2 flex flex-col items-center"
                            :class="todayIndex === index ? 'border-pink-500 bg-pink-50' : 'border-gray-100 bg-gray-50 opacity-60'">
                            <span class="text-[10px] font-bold uppercase" x-text="day"></span>
                            <span class="text-xl" x-text="index === 6 ? 'üéÅ' : 'üí∞'"></span>
                            <span class="text-xs font-bold text-gray-600" x-text="index === 6 ? '100' : '50'"></span>
                        </div>
                    </template>
                </div>
                <button @click="claimReward()" 
                    class="w-full py-4 rounded-3xl font-kids text-2xl text-white shadow-xl transform transition hover:scale-105 active:scale-95 disabled:opacity-50 disabled:grayscale disabled:hover:scale-100"
                    :class="(!isPremium || rewardClaimedToday) ? 'bg-gray-400' : 'bg-gradient-to-r from-pink-500 to-orange-400 border-b-4 border-pink-700'"
                    :disabled="rewardClaimedToday">
                    <span x-text="!isPremium ? 'Join Premium to Claim! üëë' : (rewardClaimedToday ? t('see_you_tomorrow') : (todayIndex === 6 ? t('claim') + ' 100 Coins! ‚ú®' : t('claim') + ' 50 Coins! ‚ú®'))"></span>
                </button>
            </div>
        </div>

        <!-- Profile Switcher Modal -->
        <div x-show="showProfileSwitcher" x-cloak class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate__animated animate__fadeIn">
            <div class="bg-white rounded-[40px] w-full max-w-md overflow-hidden shadow-2xl border-4 border-white transform animate__animated animate__zoomIn">
                <div class="p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-kids text-slate-800">Switch Explorer üó∫Ô∏è</h2>
                        <button @click="showProfileSwitcher = false" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <template x-for="profile in allProfiles">
                            <button @click="switchProfile(profile.id)" 
                                    class="p-4 rounded-3xl border-4 transition-all flex flex-col items-center gap-2 group"
                                    :class="activeProfileId === profile.id ? 'border-blue-400 bg-blue-50' : 'border-slate-100 hover:border-blue-200 bg-white'">
                                <div class="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center text-3xl group-hover:scale-110 transition-transform">
                                    üë§
                                </div>
                                <span class="font-kids text-slate-800" x-text="profile.name"></span>
                                <span class="text-[10px] font-bold text-slate-400 uppercase" x-text="profile.xp + ' XP'"></span>
                            </button>
                        </template>
                    </div>

                    <button @click="showProfileSwitcher = false; openParentPortal()" class="w-full mt-6 py-3 bg-slate-100 text-slate-500 rounded-2xl font-bold text-sm hover:bg-slate-200 transition-colors uppercase tracking-widest">
                        Manage Children in Portal
                    </button>
                </div>
            </div>
        </div>

        <!-- Manage Children Modal (Parent Only) -->
        <div x-show="showManageChildren" x-cloak class="fixed inset-0 z-[101] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md animate__animated animate__fadeIn">
            <div class="bg-white rounded-[40px] w-full max-w-2xl overflow-hidden shadow-2xl border-4 border-white transform animate__animated animate__zoomIn">
                <div class="p-8">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-3xl font-kids text-slate-800">Family Management üë®‚Äçüë©‚Äçüëß‚Äçüë¶</h2>
                            <p class="text-slate-400 text-sm">Add or remove explorers from your account.</p>
                        </div>
                        <button @click="showManageChildren = false" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-2xl"></i></button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Current Profiles -->
                        <div class="space-y-4">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Active Explorers</h3>
                            <div class="space-y-3 max-h-[300px] overflow-y-auto pr-2 custom-scroll">
                                <template x-for="profile in allProfiles">
                                    <div class="bg-slate-50 p-4 rounded-2xl border-2 border-slate-100 flex justify-between items-center group hover:border-blue-200 transition-colors">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm">üë§</div>
                                            <div>
                                                <p class="font-kids text-slate-800 leading-none" x-text="profile.name"></p>
                                                <p class="text-[10px] font-bold text-slate-400 uppercase mt-1" x-text="profile.ageRange + ' Years'"></p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <button @click="switchProfile(profile.id); showManageChildren = false" class="p-2 text-blue-500 hover:bg-blue-100 rounded-lg transition-colors" title="Switch to this profile">
                                                <i class="fas fa-sign-in-alt"></i>
                                            </button>
                                            <button @click="deleteProfile(profile.id)" class="p-2 text-red-400 hover:bg-red-50 rounded-lg transition-colors" title="Delete Profile">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Add New Profile -->
                        <div class="bg-blue-50 p-6 rounded-3xl border-2 border-blue-100">
                            <h3 class="font-bold text-blue-700 mb-4 flex items-center gap-2">
                                <i class="fas fa-user-plus"></i> Add New Explorer
                            </h3>
                            <div class="space-y-4" x-data="{ newChild: { name: '', age: '6-7' } }">
                                <div>
                                    <label class="text-[10px] font-bold text-blue-400 uppercase ml-1">Explorer Name</label>
                                    <input type="text" x-model="newChild.name" class="w-full mt-1 p-3 rounded-xl border-2 border-white bg-white shadow-sm font-bold text-slate-700" placeholder="e.g. Sami">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-blue-400 uppercase ml-1">Age Range</label>
                                    <select x-model="newChild.age" class="w-full mt-1 p-3 rounded-xl border-2 border-white bg-white shadow-sm font-bold text-slate-700">
                                        <option value="4-6">4-6 Years</option>
                                        <option value="7-9">7-9 Years</option>
                                        <option value="10-13">10-13 Years</option>
                                    </select>
                                </div>
                                <button @click="if(newChild.name) { addNewProfile(newChild.name, newChild.age); newChild.name = ''; }" 
                                        class="w-full py-3 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600 shadow-lg shadow-blue-200 transition-all transform active:scale-95">
                                    Create Profile üöÄ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Time's Up Lock Screen -->
        <div x-show="isTimeUp && isLoggedIn" x-cloak class="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-slate-900 bg-opacity-95 animate__animated animate__fadeIn">
            <div class="bg-white rounded-[50px] w-full max-w-xl overflow-hidden shadow-2xl border-8 border-blue-400 transform animate__animated animate__bounceIn text-center p-12 relative">
                <div class="text-8xl mb-8 animate-bounce">ü¶â</div>
                <h2 class="text-4xl font-kids text-slate-800 mb-4">Time for a Break!</h2>
                <p class="text-xl text-slate-500 mb-8 font-semibold">You've done an amazing job learning today! Time to rest your eyes and play outside. üè†üå≥</p>
                
                <!-- Parent Unlock Flow -->
                <div x-show="!parentVerified" class="space-y-6">
                    <div class="bg-blue-50 p-6 rounded-3xl border-2 border-blue-100">
                        <p class="text-blue-800 font-bold mb-4 uppercase tracking-widest text-sm">Parent Secret Unlock üîí</p>
                        <div class="flex justify-center gap-3">
                            <input type="password" maxlength="4" x-model="pinInput" placeholder="****" 
                                class="w-48 text-center text-3xl font-bold p-4 bg-white border-4 border-blue-200 rounded-2xl focus:border-blue-500 outline-none transition-all"
                                @keyup.enter="verifyPin()">
                            <button @click="verifyPin()" class="bg-blue-500 text-white px-8 rounded-2xl font-bold hover:scale-105 active:scale-95 transition-all">
                                <i class="fas fa-arrow-right text-xl"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-slate-400 text-sm">See you tomorrow for more adventures!</p>
                </div>

                <!-- Bonus Time Options (Shown after PIN verified) -->
                <div x-show="parentVerified" class="mt-8 pt-8 border-t border-slate-100 animate__animated animate__fadeIn">
                    <p class="text-2xl font-kids text-green-600 mb-6">Permission Granted! üåü</p>
                    <p class="font-bold text-slate-700 mb-6 uppercase tracking-widest text-sm">How much extra time?</p>
                    <div class="flex justify-center gap-4">
                        <button @click="timeUsedToday = Math.max(0, timeUsedToday - 15); isTimeUp = false; parentVerified = false; pinInput = ''; syncData()" 
                            class="flex-1 py-4 bg-green-500 text-white rounded-2xl font-kids text-xl shadow-lg border-b-4 border-green-700 hover:scale-105 transition-all">
                            +15 Mins
                        </button>
                        <button @click="timeUsedToday = Math.max(0, timeUsedToday - 30); isTimeUp = false; parentVerified = false; pinInput = ''; syncData()" 
                            class="flex-1 py-4 bg-blue-500 text-white rounded-2xl font-kids text-xl shadow-lg border-b-4 border-blue-700 hover:scale-105 transition-all">
                            +30 Mins
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="showPremiumModal" x-cloak
            class="fixed inset-0 z-50 flex items-center justify-center p-0 sm:p-6 bg-black bg-opacity-70 sm:overflow-y-auto overflow-hidden"
            x-transition.opacity>
            <div @click.away="showPremiumModal = false; toggleScroll(false)" class="bg-gradient-to-b from-yellow-200 to-yellow-400 rounded-none sm:rounded-[3rem] max-w-none sm:max-w-md w-full h-full sm:h-auto sm:max-h-[90vh] p-0 sm:p-8 shadow-2xl relative animate__animated animate__bounceIn border-0 sm:border-4 border-yellow-100 sm:overflow-y-auto overflow-hidden flex flex-col">
                <button @click="showPremiumModal = false; toggleScroll(false)" class="absolute top-6 right-6 text-2xl text-yellow-800 hover:text-white z-10">
                    <i class="fas fa-times-circle"></i>
                </button>
                <div class="text-center p-6 sm:p-0 flex-1 flex flex-col justify-center">
                    <div class="text-6xl mb-4">üëë</div>
                    <h2 class="text-3xl font-kids text-yellow-900 mb-2">Go Premium!</h2>
                    <p class="text-yellow-900 font-bold text-lg mb-6">Unlock the full power of learning!</p>
                    <div class="bg-white/50 rounded-2xl p-6 mb-6 text-left space-y-3">
                        <div class="flex items-center gap-3 text-yellow-900 font-bold"><i class="fas fa-check-circle text-green-600"></i><span>Personalized Weekly Learning Plans</span></div>
                        <div class="flex items-center gap-3 text-yellow-900 font-bold"><i class="fas fa-check-circle text-green-600"></i><span>Monthly Progress Reports (PDF)</span></div>
                        <div class="flex items-center gap-3 text-yellow-900 font-bold"><i class="fas fa-check-circle text-green-600"></i><span>Priority AI Explanations</span></div>
                        <div class="flex items-center gap-3 text-yellow-900 font-bold"><i class="fas fa-check-circle text-green-600"></i><span>Official Path Certificates</span></div>
                        <div class="flex items-center gap-3 text-yellow-900 font-bold"><i class="fas fa-check-circle text-green-600"></i><span>Parent Email Summaries</span></div>
                    </div>
                    <button @click="openParentPortal(); showPremiumModal = false" class="bg-white text-yellow-600 rounded-2xl px-8 py-4 font-kids text-2xl shadow-xl w-full border-b-4 border-yellow-200 mt-6">
                        Get Premium ($4.99/mo)
                    </button>
                </div>
            </div>
        </div>

        <div x-show="showCheckout" x-cloak class="fixed inset-0 z-[70] flex items-center justify-center p-6 bg-slate-900 bg-opacity-95 overflow-y-auto" x-transition.opacity>
            <div class="bg-white rounded-[2rem] max-w-md w-full p-8 shadow-2xl text-center my-auto">
                <h2 class="text-3xl font-kids text-slate-800 mb-2">Secure Checkout</h2>
                <p class="text-gray-500 mb-6">Unlock <span class="font-bold text-slate-800">1 Month Premium</span> for $4.99</p>
                
                <div class="text-left space-y-4 mb-8">
                    <div>
                        <label class="block text-xs font-bold text-black uppercase tracking-widest mb-1">Cardholder Name</label>
                        <input type="text" x-model="checkoutForm.name" placeholder="John Doe" class="w-full p-4 bg-slate-50 border-2 border-black rounded-xl focus:border-blue-500 outline-none transition-colors font-bold text-slate-700">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-black uppercase tracking-widest mb-1">Card Number</label>
                        <div class="relative">
                            <input type="text" x-model="checkoutForm.card" placeholder="0000 0000 0000 0000" maxlength="19" class="w-full p-4 bg-slate-50 border-2 border-black rounded-xl focus:border-blue-500 outline-none transition-colors font-bold text-slate-700">
                            <i class="fas fa-credit-card absolute right-4 top-5 text-slate-300"></i>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-black uppercase tracking-widest mb-1">Expiry Date</label>
                            <input type="text" x-model="checkoutForm.expiry" placeholder="MM/YY" maxlength="5" class="w-full p-4 bg-slate-50 border-2 border-black rounded-xl focus:border-blue-500 outline-none transition-colors font-bold text-slate-700 text-center">
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-black uppercase tracking-widest mb-1">CVV</label>
                            <input type="password" x-model="checkoutForm.cvv" placeholder="***" maxlength="3" class="w-full p-4 bg-slate-50 border-2 border-black rounded-xl focus:border-blue-500 outline-none transition-colors font-bold text-slate-700 text-center">
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <button 
                        @click="processPayment" 
                        :disabled="!checkoutForm.name || !checkoutForm.card || !checkoutForm.expiry || !checkoutForm.cvv"
                        class="w-full py-4 bg-green-500 text-white rounded-2xl font-kids text-xl shadow-lg hover:bg-green-600 transition-colors disabled:opacity-50 disabled:grayscale"
                    >
                        <i class="fas fa-lock mr-2"></i> Complete Payment
                    </button>
                    <button @click="showCheckout = false" class="w-full py-4 text-black font-bold hover:text-slate-600">Cancel</button>
                </div>
                <p class="text-[10px] text-slate-400 mt-6 italic">Simulation: Do not enter real sensitive information.</p>
            </div>
        </div>

        <div x-show="showParentPortal" x-cloak
            class="fixed inset-0 z-[60] flex items-center justify-center p-0 sm:p-6 bg-slate-900 bg-opacity-95 overflow-y-auto"
            x-transition.opacity>
            
            <div class="bg-slate-50 rounded-none sm:rounded-[2rem] w-full h-full sm:h-auto sm:max-h-[90vh] max-w-none sm:max-w-5xl flex flex-col shadow-2xl animate__animated animate__zoomIn overflow-hidden">
                
                <div class="bg-white p-6 sm:p-8 border-b border-gray-200 flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl sm:text-3xl font-kids text-slate-800" x-text="t('parent_portal')">Parent Dashboard</h2>
                        <p class="text-xs text-slate-400 font-bold uppercase tracking-widest mt-1">Overview for <span x-text="childProfile.name || 'Your Child'"></span></p>
                    </div>
                    <button @click="closeParentPortal" class="text-gray-400 hover:text-red-500 transition-colors text-2xl"><i class="fas fa-times-circle"></i></button>
                </div>

                <div class="flex-1 overflow-y-auto custom-scroll p-6 sm:p-8">
                    
                    <!-- PIN Gated Content -->
                    <template x-if="!parentVerified">
                        <div class="flex flex-col items-center justify-center h-full space-y-6">
                            <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-blue-500 mb-2">
                                <i class="fas fa-user-shield text-3xl"></i>
                            </div>
                            <h3 class="text-2xl font-kids text-slate-700">Enter Parent PIN</h3>
                            <p class="text-slate-400 text-sm font-bold uppercase tracking-widest">Verify it's you to access settings</p>
                            
                            <input type="password" 
                                   x-model="pinInput" 
                                   maxlength="4" 
                                   placeholder="****" 
                                   class="text-4xl text-center tracking-[1em] font-bold border-b-4 border-blue-200 focus:border-blue-500 outline-none w-48 py-2 bg-transparent transition-all text-slate-700 placeholder-slate-200"
                                   @keyup.enter="verifyPin">
                            
                            <button @click="verifyPin" class="px-8 py-3 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600 transition-colors shadow-lg shadow-blue-200 transform active:scale-95">
                                Unlock Dashboard üîì
                            </button>

                            <p class="text-xs text-slate-300 mt-4">Default PIN is your account PIN or 0000</p>
                        </div>
                    </template>

                    <template x-if="parentVerified">
                        <div class="animate__animated animate__fadeIn">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                                <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                                    <div class="flex justify-between items-start mb-4">
                                        <h3 class="font-bold text-slate-700 text-lg"><i class="fas fa-id-card text-blue-500 mr-2"></i>Child Profile</h3>
                                        <button @click="isEditingProfile = !isEditingProfile" class="text-xs font-bold text-blue-500 uppercase hover:underline" x-text="isEditingProfile ? 'Save' : 'Edit'"></button>
                                    </div>
                                    
                                    <div x-show="!isEditingProfile" class="space-y-3">
                                        <div><p class="text-xs text-slate-400 font-bold uppercase">Name</p><p class="text-xl font-kids text-slate-800" x-text="childProfile.name"></p></div>
                                        <div class="flex gap-6">
                                            <div><p class="text-xs text-slate-400 font-bold uppercase">Age Group</p><p class="text-lg font-bold text-slate-700" x-text="(childProfile.ageRange || '6-7') + ' Years'"></p></div>
                                            <div><p class="text-xs text-slate-400 font-bold uppercase">Difficulty</p><p class="text-lg font-bold text-slate-700" x-text="['4-6','4-5'].includes(childProfile.ageRange) ? 'Beginner' : (['7-9','6-7','8-9'].includes(childProfile.ageRange) ? 'Intermediate' : 'Advanced')"></p></div>
                                        </div>
                                    </div>

                                    <div x-show="isEditingProfile" class="space-y-3 animate__animated animate__fadeIn">
                                        <input type="text" x-model="childProfile.name" class="w-full p-2 border rounded-xl bg-slate-50 font-bold text-sm" placeholder="Name">
                                        
                                        <div>
                                            <label class="text-xs text-slate-400 font-bold uppercase">Adjust Age Group</label>
                                            <select x-model="childProfile.ageRange" class="w-full p-2 border rounded-xl bg-slate-50 font-bold text-sm mt-1">
                                                <option value="4-6">4-6 Years (Basic)</option>
                                                <option value="7-9">7-9 Years (Logic)</option>
                                                <option value="10-13">10-13 Years (Science)</option>
                                            </select>
                                        </div>
                                        

                                        
                                        <button @click="saveChildProfile()" class="w-full py-2 bg-blue-500 text-white rounded-xl text-sm font-bold mt-2">Update Profile</button>
                                    </div>
                                    
                                    <div class="mt-4 pt-4 border-t border-slate-50">
                                        <div class="mb-4">
                                            <label class="text-xs text-slate-400 font-bold uppercase">Daily Screen Time</label>
                                            <select x-model="dailyTimeLimit" @change="syncData()" class="w-full p-2 border rounded-xl bg-slate-50 font-bold text-sm mt-1">
                                                <option value="0">Unlimited ‚ôæÔ∏è</option>
                                                <option value="15">15 Minutes</option>
                                                <option value="30">30 Minutes</option>
                                                <option value="45">45 Minutes</option>
                                                <option value="60">60 Minutes</option>
                                                <option value="120">2 Hours</option>
                                            </select>
                                        </div>
                                        <button @click="showManageChildren = true" class="w-full py-2 bg-slate-100 text-slate-500 rounded-xl text-xs font-bold uppercase hover:bg-slate-200 transition-colors">
                                            <i class="fas fa-users-cog mr-2"></i>Manage All Children
                                        </button>
                                        <button @click="showOnboarding = true; onboardingStep = 0; showParentPortal = false" class="w-full py-2 bg-blue-100 text-blue-600 rounded-xl text-xs font-bold uppercase hover:bg-blue-200 transition-colors mt-2">
                                            <i class="fas fa-redo mr-2"></i>Restart Tutorial
                                        </button>
                                    </div>
                                </div>

                                <div class="bg-blue-50 p-6 rounded-3xl shadow-sm border border-blue-100 flex flex-col justify-center">
                                    <h3 class="font-bold text-blue-800 text-sm uppercase tracking-widest mb-3 flex items-center gap-2">
                                        <i class="fas fa-flag-checkered"></i> 30-Day Outcomes
                                    </h3>
                                    <div class="space-y-3">
                                        <template x-for="outcome in getRegionalOutcomes()">
                                            <div class="flex items-center gap-3">
                                                <div class="w-6 h-6 rounded-full bg-white flex items-center justify-center text-xs text-blue-500 font-bold shadow-sm" x-text="outcome.id"></div>
                                                <p class="text-xs font-bold text-blue-700" x-text="outcome.text"></p>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                                    <h3 class="font-bold text-slate-800 text-lg mb-4 flex items-center gap-2">
                                        <i class="fas fa-shield-virus text-green-500"></i> AI Guardrails Active
                                    </h3>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">App Language</label>
                                            <select x-model="currentLanguage" @change="syncData()" class="w-full p-2 border-2 border-slate-100 rounded-xl bg-slate-50 font-bold text-sm outline-none focus:border-blue-300">
                                                <template x-for="lang in availableLanguages">
                                                    <option :value="lang" x-text="lang"></option>
                                                </template>
                                            </select>
                                        </div>

                                        <div>
                                            <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Regional Curriculum</label>
                                            <select x-model="currentCurriculumRegion" @change="syncData()" class="w-full p-2 border-2 border-slate-100 rounded-xl bg-slate-50 font-bold text-sm outline-none focus:border-blue-300">
                                                <option value="Global">Global Standards üåç</option>
                                                <option value="US">US (Common Core) üá∫üá∏</option>
                                                <option value="UK">UK (National Curriculum) üá¨üáß</option>
                                            </select>
                                        </div>

                                        <div class="flex items-start gap-3">
                                            <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-500 mt-1 flex-shrink-0"><i class="fas fa-book"></i></div>
                                            <div>
                                                <p class="text-xs font-bold text-slate-700 uppercase">Curriculum Aligned</p>
                                                <p class="text-[10px] text-slate-500 leading-tight">AI answers are restricted to age-appropriate educational topics only.</p>
                                            </div>
                                        </div>
                                        <div class="flex items-start gap-3">
                                            <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-500 mt-1 flex-shrink-0"><i class="fas fa-envelope-open-text"></i></div>
                                            <div>
                                                <p class="text-xs font-bold text-slate-700 uppercase">Learning Wins Summaries</p>
                                                <div class="flex items-center gap-2 mt-1">
                                                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                                                    <span class="text-[10px] font-bold text-green-600">Daily Automated Reports Active</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                                     <h3 class="font-bold text-slate-800 text-lg mb-4 flex items-center gap-2">
                                        <i class="fas fa-smile-beam text-pink-500"></i> Emotional Insights (New)
                                    </h3>
                                    <div class="space-y-4 min-h-[200px] flex flex-col justify-center">
                                        <template x-for="insight in getEmotionalInsights()">
                                            <div class="flex items-start gap-3 p-3 rounded-xl" :class="insight.color">
                                                <div class="text-2xl" x-text="insight.icon"></div>
                                                <div>
                                                    <p class="text-xs font-bold uppercase" x-text="insight.subject"></p>
                                                    <p class="text-sm font-semibold text-slate-700" x-text="insight.text"></p>
                                                </div>
                                            </div>
                                        </template>
                                        <div x-show="parentLogs.length < 3" class="text-center py-4 text-gray-400 text-xs italic">
                                            Asking more questions will reveal emotional patterns!
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                                    <h3 class="font-bold text-slate-800 text-lg mb-4 flex items-center gap-2">
                                        <i class="fas fa-chart-pie text-indigo-500"></i> Learning Mood Trend
                                    </h3>
                                    <div class="h-40 flex items-end justify-between px-4 pb-2 border-b-2 border-slate-50 gap-2">
                                        <template x-for="mood in getMoodStats()">
                                            <div class="flex-1 flex flex-col items-center">
                                                <div class="w-full rounded-t-lg transition-all duration-1000" 
                                                    :class="mood.bg"
                                                    :style="'height: ' + mood.percent + '%'"></div>
                                                <span class="text-[10px] font-bold text-slate-400 mt-2 uppercase" x-text="mood.label"></span>
                                            </div>
                                        </template>
                                    </div>
                                    <p class="text-[10px] text-center text-slate-400 font-bold uppercase mt-4 tracking-widest">Aggregate Sentiment Analysis</p>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex flex-col justify-between">
                                    <div class="flex justify-between items-start">
                                        <h3 class="font-bold text-slate-700 text-lg"><i class="fas fa-crown text-yellow-500 mr-2"></i>Membership</h3>
                                        <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase" :class="isPremium ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'" x-text="isPremium ? 'Premium' : 'Free'"></span>
                                    </div>
                                    <div class="mt-4">
                                        <p class="text-sm text-gray-600 mb-4" x-text="isPremium ? 'All teachers and features unlocked.' : 'Limited to 5 questions per day.'"></p>
                                        
                                        <template x-if="isPremium && premiumExpiry">
                                            <p class="text-xs text-gray-400 font-bold mb-3">
                                                Renews on: <span class="text-slate-600" x-text="new Date(premiumExpiry).toLocaleDateString()"></span>
                                            </p>
                                        </template>

                                        <button @click="isPremium ? cancelSubscription() : processPayment()" 
                                            class="w-full py-3 rounded-xl font-bold text-sm transition-all" 
                                            :class="isPremium ? 'bg-red-50 text-red-500 border border-red-100' : 'bg-gradient-to-r from-yellow-400 to-orange-400 text-white shadow-lg transform hover:-translate-y-1'">
                                            <span x-text="isPremium ? 'Cancel Subscription' : 'Upgrade Now ($4.99/mo)'"></span>
                                        </button>
                                    </div>
                                </div>

                                <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 relative overflow-hidden">
                                    <div x-show="!isPremium" class="absolute inset-0 bg-white/60 backdrop-blur-[2px] z-10 flex items-center justify-center p-6 text-center">
                                        <div>
                                            <i class="fas fa-lock text-gray-400 mb-2"></i>
                                            <p class="text-xs font-bold text-gray-500 uppercase">Premium Feature</p>
                                            <p class="text-[10px] text-gray-400">Unlock Detailed Weekly Reports</p>
                                        </div>
                                    </div>
                                    <h3 class="font-bold text-slate-800 text-lg mb-4 flex items-center gap-2">
                                        <i class="fas fa-chart-line text-blue-500"></i> Monthly Report
                                    </h3>
                                    <div class="space-y-4">
                                        <p class="text-[10px] text-gray-500">A detailed analysis of subjects learned, questions asked, and vocabulary milestones.</p>
                                        <button @click="downloadMonthlyReport()" class="w-full py-2 bg-blue-100 text-blue-600 rounded-xl font-bold text-xs uppercase tracking-widest hover:bg-blue-200 transition-colors">
                                            <i class="fas fa-file-download mr-2"></i> Download Report (PDF)
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-sm border border-gray-100 mb-8">
                                <h3 class="font-bold text-slate-800 text-xl mb-6 flex items-center gap-2">
                                    <i class="fas fa-rocket text-purple-500"></i> Learning Journey
                                </h3>
                                
                                <div class="relative w-full mt-4 mb-8 px-2 sm:px-10">
                                    <div class="absolute left-4 right-4 top-5 h-1.5 bg-gray-100 rounded-full z-0"></div>
                                    <div class="absolute left-4 top-5 h-1.5 bg-green-400 rounded-full z-0 transition-all duration-1000" :style="'width: ' + journeyProgress + '%'"></div>

                                    <div class="relative flex justify-between items-start z-10">
                                        <div class="flex flex-col items-center gap-2">
                                            <div class="w-12 h-12 rounded-full flex items-center justify-center border-4 bg-white transition-all shadow-md"
                                                :class="xp >= 0 ? 'border-green-400 text-green-500' : 'border-gray-200 text-gray-300'">
                                                <i class="fas fa-egg text-lg"></i>
                                            </div>
                                            <span class="text-[10px] font-bold uppercase tracking-wider mt-1" 
                                                :class="xp >= 0 ? 'text-green-600' : 'text-gray-300'">Beginner</span>
                                        </div>
                                        
                                        <div class="flex flex-col items-center gap-2">
                                            <div class="w-12 h-12 rounded-full flex items-center justify-center border-4 bg-white transition-all shadow-md"
                                                :class="xp >= 1000 ? 'border-blue-400 text-blue-500' : 'border-gray-200 text-gray-300'">
                                                <i class="fas fa-book-reader text-lg"></i>
                                            </div>
                                            <span class="text-[10px] font-bold uppercase tracking-wider mt-1" 
                                                :class="xp >= 1000 ? 'text-blue-600' : 'text-gray-300'">Intermediate</span>
                                        </div>

                                        <div class="flex flex-col items-center gap-2">
                                            <div class="w-12 h-12 rounded-full flex items-center justify-center border-4 bg-white transition-all shadow-md"
                                                :class="xp >= 3000 ? 'border-purple-400 text-purple-500' : 'border-gray-200 text-gray-300'">
                                                <i class="fas fa-graduation-cap text-lg"></i>
                                            </div>
                                            <span class="text-[10px] font-bold uppercase tracking-wider mt-1" 
                                                :class="xp >= 3000 ? 'text-purple-600' : 'text-gray-300'">Advanced</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mt-8">
                                    <div class="bg-orange-50 p-4 rounded-2xl border-orange-100 border text-center">
                                        <div class="text-2xl mb-1">‚ùì</div>
                                        <div class="text-2xl font-bold text-orange-600" x-text="parentLogs.length"></div>
                                        <div class="text-[10px] text-orange-400 font-bold uppercase">Questions Asked</div>
                                    </div>
                                    <div class="bg-blue-50 p-4 rounded-2xl border-blue-100 border text-center">
                                        <div class="text-2xl mb-1">üìñ</div>
                                        <div class="text-2xl font-bold text-blue-600" x-text="learningStats.wordsLearned"></div>
                                        <div class="text-[10px] text-blue-400 font-bold uppercase">Words Read</div>
                                    </div>
                                    <div class="bg-yellow-50 p-4 rounded-2xl border-yellow-100 border text-center">
                                        <div class="text-2xl mb-1">üí∞</div>
                                        <div class="text-2xl font-bold text-yellow-600" x-text="coins"></div>
                                        <div class="text-[10px] text-yellow-400 font-bold uppercase">Coins Earned</div>
                                    </div>
                                    <div class="bg-pink-50 p-4 rounded-2xl border-pink-100 border text-center">
                                        <div class="text-2xl mb-1">‚≠ê</div>
                                        <div class="text-2xl font-bold text-pink-600" x-text="xp"></div>
                                        <div class="text-[10px] text-pink-400 font-bold uppercase">Total XP</div>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                                    <h3 class="font-bold text-slate-800 text-lg mb-4">Evidence-Based Mastery Levels</h3>
                                    <div class="space-y-6">
                                        <template x-for="(score, subject) in getTopSubjects()">
                                            <div>
                                                <div class="flex justify-between items-center mb-1">
                                                    <span class="text-xs font-bold text-gray-500 uppercase" x-text="subject"></span>
                                                    <span class="px-2 py-0.5 rounded-full text-[9px] font-bold uppercase shadow-sm" 
                                                          :class="getMasteryBadge(score).bg" 
                                                          x-text="getMasteryBadge(score).label"></span>
                                                </div>
                                                <div class="flex justify-between text-[9px] font-bold text-gray-400 mb-1">
                                                    <span x-text="currentCurriculumRegion + ' Standard Alignment'"></span>
                                                    <span x-text="score + ' pts'"></span>
                                                </div>
                                                <div class="h-3 bg-gray-100 rounded-full overflow-hidden border border-gray-200">
                                                    <div class="h-full rounded-full transition-all duration-1000" 
                                                        :class="getSubjectColor(subject)" 
                                                        :style="'width: ' + Math.min((score / 150) * 100, 100) + '%'"></div>
                                                </div>
                                            </div>
                                        </template>
                                        <div x-show="Object.values(learningStats.subjects).reduce((a, b) => a + b, 0) === 0" class="text-center text-gray-400 text-sm py-4">
                                            No mastery data yet. Start asking questions!
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex flex-col">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="font-bold text-slate-800 text-lg">Recent Questions</h3>
                                        <button @click="clearLogs" class="text-[10px] font-bold text-red-400 hover:text-red-600 uppercase">Clear History</button>
                                    </div>
                                    <div class="flex-1 overflow-y-auto max-h-[200px] custom-scroll pr-2 space-y-3">
                                        <template x-for="log in parentLogs.slice().reverse().slice(0, 10)">
                                            <div class="bg-gray-50 p-3 rounded-xl border-l-4 border-blue-400">
                                                <div class="flex justify-between items-center mb-1">
                                                    <div class="flex items-center gap-2">
                                                        <span class="text-[10px] text-gray-400 font-bold" x-text="log.time"></span>
                                                        <span x-show="log.emotion" :title="log.emotion" class="text-xs" x-text="getEmotionIcon(log.emotion)"></span>
                                                    </div>
                                                    <span class="text-[9px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold uppercase whitespace-nowrap ml-2" x-text="'FROM: ' + log.char"></span>
                                                </div>
                                                <p class="text-slate-700 text-sm font-semibold" x-text="log.query"></p>
                                            </div>
                                        </template>
                                        <div x-show="parentLogs.length === 0" class="text-center text-gray-400 text-sm py-8">
                                            No activity recorded yet.
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-8 pt-6 border-t flex flex-wrap justify-between items-center gap-4">
                                <button @click="handleLogout" class="text-red-500 font-bold text-xs hover:underline uppercase tracking-widest">Log Out</button>
                                <button @click="closeParentPortal" class="bg-slate-800 text-white px-8 py-3 rounded-xl font-kids text-sm hover:bg-slate-700 transition-colors">Exit Dashboard</button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Interactive Onboarding Modal -->
        <div x-show="showOnboarding" x-cloak class="fixed inset-0 z-[150] bg-black bg-opacity-90 flex items-center justify-center p-0 sm:p-4" x-transition.opacity>
            <div class="bg-white rounded-none sm:rounded-[3rem] max-w-none sm:max-w-2xl w-full h-full sm:h-auto sm:max-h-[95vh] p-4 sm:p-8 shadow-2xl relative animate__animated animate__zoomIn overflow-y-auto flex flex-col">
                
                <!-- Progress Bar -->
                <div class="absolute top-0 left-0 right-0 h-2 bg-gray-100">
                    <div class="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-500" :style="'width: ' + ((onboardingStep + 1) / 5 * 100) + '%'"></div>
                </div>

                <!-- Skip Button -->
                <button @click="skipOnboarding()" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 text-sm font-bold uppercase tracking-widest">
                    Skip Tour
                </button>

                <!-- Step 0: Welcome -->
                <div x-show="onboardingStep === 0" class="text-center py-4 sm:py-8 animate__animated animate__fadeIn">
                    <div class="text-5xl sm:text-8xl mb-3 sm:mb-6 animate-bounce">ü¶ñ</div>
                    <h2 class="text-2xl sm:text-4xl font-kids text-slate-800 mb-2 sm:mb-4">Welcome to AI Tutor!</h2>
                    <p class="text-base sm:text-xl text-gray-600 mb-4 sm:mb-8 leading-relaxed">Hi there! I'm Professor Dino, and I'll be your guide today! Let me show you around this amazing learning adventure!</p>
                    <div class="bg-blue-50 p-4 sm:p-6 rounded-2xl border-2 border-blue-200 mb-4 sm:mb-8">
                        <p class="text-blue-800 font-bold text-base sm:text-lg">üéØ What You'll Learn:</p>
                        <ul class="text-left text-blue-700 mt-3 space-y-1.5 sm:space-y-2 text-sm sm:text-base">
                            <li>‚ú® How to ask questions and learn</li>
                            <li>üé® Meet your fun teacher friends</li>
                            <li>üí∞ Earn coins and unlock rewards</li>
                            <li>üëë Discover Premium features</li>
                        </ul>
                    </div>
                    <button @click="nextOnboardingStep()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-8 sm:px-12 py-3 sm:py-4 rounded-2xl font-kids text-xl sm:text-2xl shadow-lg hover:scale-105 transition-transform">
                        Let's Start! üöÄ
                    </button>
                </div>

                <!-- Step 1: Meet Your Teachers -->
                <div x-show="onboardingStep === 1" class="py-3 sm:py-8 animate__animated animate__fadeIn">
                    <div class="text-center mb-4 sm:mb-6">
                        <div class="text-4xl sm:text-6xl mb-2 sm:mb-4">üë®‚Äçüè´</div>
                        <h2 class="text-2xl sm:text-3xl font-kids text-slate-800 mb-1 sm:mb-2">Meet Your Teachers!</h2>
                        <p class="text-sm sm:text-base text-gray-600">Each teacher is an expert in their subject. Click on them to switch!</p>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 sm:gap-4 mb-4 sm:mb-8">
                        <template x-for="char in characters.slice(0, 3)">
                            <div class="bg-gradient-to-br from-blue-50 to-purple-50 p-3 sm:p-6 rounded-2xl border-2 border-gray-200 hover:border-blue-400 transition-all cursor-pointer text-center" @click="playCharIntro(char.name)">
                                <div class="text-3xl sm:text-5xl mb-1 sm:mb-3" x-text="char.icon"></div>
                                <p class="font-bold text-slate-800 text-xs sm:text-base" x-text="char.name"></p>
                                <p class="text-[10px] sm:text-xs text-gray-500" x-text="char.subject"></p>
                            </div>
                        </template>
                    </div>
                    
                    <div class="bg-yellow-50 p-3 sm:p-4 rounded-xl border-2 border-yellow-200 mb-4 sm:mb-6">
                        <p class="text-yellow-800 font-bold text-xs sm:text-sm">üí° Tip: Some teachers are locked! Upgrade to Premium to unlock them all!</p>
                    </div>
                    
                    <div class="flex gap-3">
                        <button @click="prevOnboardingStep()" class="flex-1 bg-gray-200 text-gray-700 px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl font-bold hover:bg-gray-300 transition-colors text-sm sm:text-base">
                            ‚Üê Back
                        </button>
                        <button @click="nextOnboardingStep()" class="flex-1 bg-blue-500 text-white px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl font-bold hover:bg-blue-600 transition-colors text-sm sm:text-base">
                            Next ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Step 2: How to Ask Questions -->
                <div x-show="onboardingStep === 2" class="py-3 sm:py-8 animate__animated animate__fadeIn">
                    <div class="text-center mb-4 sm:mb-6">
                        <div class="text-4xl sm:text-6xl mb-2 sm:mb-4">üí¨</div>
                        <h2 class="text-2xl sm:text-3xl font-kids text-slate-800 mb-1 sm:mb-2">Ask Me Anything!</h2>
                        <p class="text-sm sm:text-base text-gray-600">You can type or use your voice to ask questions!</p>
                    </div>
                    
                    <div class="bg-white border-4 border-blue-300 rounded-3xl p-4 sm:p-6 mb-4 sm:mb-6 shadow-lg">
                        <div class="flex items-center gap-3 sm:gap-4 mb-3 sm:mb-4">
                            <div class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-100 rounded-full flex items-center justify-center text-xl sm:text-2xl flex-shrink-0">‚å®Ô∏è</div>
                            <div class="flex-1">
                                <p class="font-bold text-slate-800 text-sm sm:text-base">Type Your Question</p>
                                <p class="text-xs sm:text-sm text-gray-500">Click the keyboard icon and type!</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 sm:gap-4">
                            <div class="w-10 h-10 sm:w-12 sm:h-12 bg-red-100 rounded-full flex items-center justify-center text-xl sm:text-2xl flex-shrink-0">üé§</div>
                            <div class="flex-1">
                                <p class="font-bold text-slate-800 text-sm sm:text-base">Use Your Voice</p>
                                <p class="text-xs sm:text-sm text-gray-500">Click the microphone and speak!</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 p-3 sm:p-4 rounded-xl border-2 border-green-200 mb-4 sm:mb-6">
                        <p class="text-green-800 font-bold text-xs sm:text-sm">üõ°Ô∏è Safe Learning: All answers are kid-friendly and educational!</p>
                    </div>
                    
                    <div class="flex gap-3">
                        <button @click="prevOnboardingStep()" class="flex-1 bg-gray-200 text-gray-700 px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl font-bold hover:bg-gray-300 transition-colors text-sm sm:text-base">
                            ‚Üê Back
                        </button>
                        <button @click="nextOnboardingStep()" class="flex-1 bg-blue-500 text-white px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl font-bold hover:bg-blue-600 transition-colors text-sm sm:text-base">
                            Next ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Step 3: Earn Coins & Rewards -->
                <div x-show="onboardingStep === 3" class="py-3 sm:py-8 animate__animated animate__fadeIn">
                    <div class="text-center mb-4 sm:mb-6">
                        <div class="text-4xl sm:text-6xl mb-2 sm:mb-4">üí∞</div>
                        <h2 class="text-2xl sm:text-3xl font-kids text-slate-800 mb-1 sm:mb-2">Earn Coins & Rewards!</h2>
                        <p class="text-sm sm:text-base text-gray-600">Learning is fun AND rewarding!</p>
                    </div>
                    
                    <div class="space-y-2 sm:space-y-4 mb-4 sm:mb-6">
                        <div class="bg-yellow-50 p-3 sm:p-5 rounded-2xl border-2 border-yellow-200 flex items-center gap-3 sm:gap-4">
                            <div class="text-2xl sm:text-4xl">‚ùì</div>
                            <div class="flex-1">
                                <p class="font-bold text-slate-800 text-sm sm:text-base">Ask Questions</p>
                                <p class="text-xs sm:text-sm text-gray-600">Earn 10 coins for every question!</p>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 p-3 sm:p-5 rounded-2xl border-2 border-green-200 flex items-center gap-3 sm:gap-4">
                            <div class="text-2xl sm:text-4xl">üèÜ</div>
                            <div class="flex-1">
                                <p class="font-bold text-slate-800 text-sm sm:text-base">Complete Quizzes</p>
                                <p class="text-xs sm:text-sm text-gray-600">Earn 20 coins for correct answers!</p>
                            </div>
                        </div>
                        
                        <div class="bg-purple-50 p-3 sm:p-5 rounded-2xl border-2 border-purple-200 flex items-center gap-3 sm:gap-4">
                            <div class="text-2xl sm:text-4xl">ü™Ñ</div>
                            <div class="flex-1">
                                <p class="font-bold text-slate-800 text-sm sm:text-base">Buy Magic Auras</p>
                                <p class="text-xs sm:text-sm text-gray-600">Spend coins on cool effects!</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button @click="prevOnboardingStep()" class="flex-1 bg-gray-200 text-gray-700 px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl font-bold hover:bg-gray-300 transition-colors text-sm sm:text-base">
                            ‚Üê Back
                        </button>
                        <button @click="nextOnboardingStep()" class="flex-1 bg-blue-500 text-white px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl font-bold hover:bg-blue-600 transition-colors text-sm sm:text-base">
                            Next ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Step 4: Premium Benefits -->
                <div x-show="onboardingStep === 4" class="py-3 sm:py-8 animate__animated animate__fadeIn">
                    <div class="text-center mb-4 sm:mb-6">
                        <div class="text-4xl sm:text-6xl mb-2 sm:mb-4">üëë</div>
                        <h2 class="text-2xl sm:text-3xl font-kids text-slate-800 mb-1 sm:mb-2">Unlock Premium!</h2>
                        <p class="text-sm sm:text-base text-gray-600">Get the full learning experience for just $4.99/month</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-yellow-100 to-orange-100 p-4 sm:p-6 rounded-2xl border-4 border-yellow-300 mb-4 sm:mb-6">
                        <div class="space-y-2 sm:space-y-3">
                            <div class="flex items-center gap-2 sm:gap-3">
                                <div class="w-6 h-6 sm:w-8 sm:h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-xs sm:text-sm flex-shrink-0">‚úì</div>
                                <p class="font-bold text-slate-800 text-sm sm:text-base">Unlock ALL 5 Teachers</p>
                            </div>
                            <div class="flex items-center gap-2 sm:gap-3">
                                <div class="w-6 h-6 sm:w-8 sm:h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-xs sm:text-sm flex-shrink-0">‚úì</div>
                                <p class="font-bold text-slate-800 text-sm sm:text-base">Unlimited Questions Daily</p>
                            </div>
                            <div class="flex items-center gap-2 sm:gap-3">
                                <div class="w-6 h-6 sm:w-8 sm:h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-xs sm:text-sm flex-shrink-0">‚úì</div>
                                <p class="font-bold text-slate-800 text-sm sm:text-base">Daily Coin Rewards</p>
                            </div>
                            <div class="flex items-center gap-2 sm:gap-3">
                                <div class="w-6 h-6 sm:w-8 sm:h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-xs sm:text-sm flex-shrink-0">‚úì</div>
                                <p class="font-bold text-slate-800 text-sm sm:text-base">Personalized Learning Paths</p>
                            </div>
                            <div class="flex items-center gap-2 sm:gap-3">
                                <div class="w-6 h-6 sm:w-8 sm:h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-xs sm:text-sm flex-shrink-0">‚úì</div>
                                <p class="font-bold text-slate-800 text-sm sm:text-base">Progress Reports for Parents</p>
                            </div>
                            <div class="flex items-center gap-2 sm:gap-3">
                                <div class="w-6 h-6 sm:w-8 sm:h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-xs sm:text-sm flex-shrink-0">‚úì</div>
                                <p class="font-bold text-slate-800 text-sm sm:text-base">Official Certificates</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-3 sm:p-4 rounded-xl border-2 border-blue-200 mb-4 sm:mb-6 text-center">
                        <p class="text-blue-800 font-bold text-xs sm:text-base">üéÅ Special Offer: Get 50 bonus coins just for completing this tour!</p>
                    </div>
                    
                    <div class="flex gap-3">
                        <button @click="prevOnboardingStep()" class="flex-1 bg-gray-200 text-gray-700 px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl font-bold hover:bg-gray-300 transition-colors text-sm sm:text-base">
                            ‚Üê Back
                        </button>
                        <button @click="nextOnboardingStep()" class="flex-1 bg-gradient-to-r from-green-500 to-blue-500 text-white px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl font-bold hover:scale-105 transition-transform shadow-lg text-sm sm:text-base">
                            Finish Tour! üéâ
                        </button>
                    </div>
                </div>

                <!-- Step Indicator -->
                <div class="flex justify-center gap-2 mt-6">
                    <template x-for="i in 5">
                        <div class="w-2 h-2 rounded-full transition-all" :class="onboardingStep === (i - 1) ? 'bg-blue-500 w-8' : 'bg-gray-300'"></div>
                    </template>
                </div>
            </div>
        </div>

        <script>
            if ("serviceWorker" in navigator) {
                navigator.serviceWorker.register("service-worker.js");
            }

            function aiTutor() {
                return {
                    supabase: null,
                    isLoading: true, // Start in loading state
                    isLoggedIn: false,
                    hasAccount: false,
                    savedProfile: null,
                    loginForm: { name: '', email: '', password: '', ageRange: '6-7' },
                    registeredEmail: '',
                    session: null,

                    
                    legalAccepted: false,
                    showLegalDoc: null,

                    // Adaptive Difficulty State
                    consecutiveMistakes: 0,
                    isVisualMode: false,

                    // Parental Gate State
                    gateVerified: false,
                    gateQuestion: '',
                    gateAnswer: '',
                    correctGateResult: 0,

                    userQuery: '',
                    isKeyboardMode: false,
                    isVoiceNativeMode: false, 
                    displayText: "Hi friend! üåü I'm Professor Dino. I teach History! What do you want to know about the past?",
                    isThinking: false,
                    isSpeaking: false,
                    isListening: false,
                    hasAnswered: true,
                    currentMoodIcon: 'ü¶ñ',
                    suggestions: ["Who built the pyramids? üèúÔ∏è", "What is a mummy? ü§ï", "Who was the first king? üëë"],
                    isPremium: false,
                    premiumExpiry: null,
                    showCheckout: false,
                    checkoutForm: { name: '', card: '', expiry: '', cvv: '' },
                    maxFreeQuestions: 5,
                    dailyQuestionsUsed: 0,
                    lastUsageDate: new Date().toDateString(),
                    
                    // Monthly Quest Quotas
                    monthlyQuestsUsed: 0,
                    maxMonthlyQuests: 20,
                    lastQuestMonth: new Date().getMonth(), // 0-11
                    
                    coins: 0, 
                    
                    showRewards: false,
                    rewardClaimedToday: false,
                    todayIndex: (new Date().getDay() + 6) % 7, 
                    showPremiumModal: false,
                    safetySettings: {
                        blockedWords: localStorage.getItem('blocked_words') || 'war, killing, blood, gun, scary',
                        forbiddenTopics: ['violence', 'horror', 'politics', 'death', 'crime']
                    },
                    
                    showParentPortal: false,
                    parentVerified: false,
                    masterPin: '', 
                    pinInput: '',
                    parentLogs: [],
                    
                    currentLanguage: 'English',
                    availableLanguages: ['English', 'Spanish', 'French', 'German', 'Arabic'],
                    currentCurriculumRegion: 'Global',

                    childProfile: { name: '', age: '', grade: '', ageRange: '6-7' },
                    totalMinutesLearned: 0,
                    isEditingProfile: false,
                    sessionStartTime: null,
                    emailSummaryEnabled: false,
                    lastSummaryDate: null,

                    // Multi-Child State
                    allProfiles: [], 
                    activeProfileId: null,
                    showProfileSwitcher: false,
                    showManageChildren: false,

                    // Onboarding State
                    showOnboarding: false,
                    onboardingStep: 0,
                    hasCompletedOnboarding: false,

                    // Time Tracking State
                    timeUsedToday: 0,
                    dailyTimeLimit: 0, // 0 = Unlimited
                    isTimeUp: false,
                    lastTimeUpdate: Date.now(),
                    timeCheckInterval: null,

                    learningStats: {
                        wordsLearned: 0,
                        subjects: { history: 0, robots: 0, space: 0, science: 0, nature: 0 },
                        child_profile: null,
                        recent_mistakes: [],
                        emotions: { excited: 0, curious: 0, frustrated: 0, happy: 0, neutral: 0 },
                        achievements: [],
                        quizzesCompleted: 0
                    },
                    xp: 0,
                    level: 1,

                    showShop: false,
                    inventory: [],
                    equippedItem: null,
                    
                    showQuiz: false,
                    quizState: 'loading',
                    quizQuestion: '',
                    quizOptions: [],
                    quizCorrectIndex: 0,



                    // --- VISION STATE ---
                    showVisionModal: false,
                    visionFile: null,
                    visionPreview: null,
                    isCameraActive: false,

                    showLearningPath: false,
                    showStickerBook: false,
                    showDailyPath: false, // Toggle for 30-Day Path
                    learningPathDay: 1, // Tracks progress 1-30
                    currentPath: null,
                    activeLesson: null,
                    lessonStep: 'learn', 
                    currentLessonQuizIndex: 0,
                    pathProgress: {}, 
                    selectedCertificatePath: null,
                    isGeneratingPath: false,

                    availableBadges: [
                        { id: 'first_question', name: 'Curious Explorer', icon: 'üîç', desc: 'Asked your first question!' },
                        { id: 'quiz_wizard', name: 'Quiz Wizard', icon: 'ü™Ñ', desc: 'Completed your first lesson quiz!' },
                        { id: 'word_smith', name: 'Word Smith', icon: 'üìö', desc: 'Learned at least 10 words!' },
                        { id: 'coin_collector', name: 'Coin Collector', icon: 'üí∞', desc: 'Saved up 200 coins!' },
                        { id: 'path_finder', name: 'Path Finder', icon: 'üó∫Ô∏è', desc: 'Completed a full adventure path!' },
                        { id: 'super_star', name: 'Super Star', icon: '‚≠ê', desc: 'Reached Level 5!' }
                    ],

                    checkAchievements() {
                        if (!this.learningStats.achievements) this.learningStats.achievements = [];
                        
                        const badges = [
                            { id: 'first_question', condition: () => this.parentLogs.length >= 1 },
                            { id: 'quiz_wizard', condition: () => this.learningStats.quizzesCompleted >= 1 },
                            { id: 'word_smith', condition: () => this.learningStats.wordsLearned >= 10 },
                            { id: 'coin_collector', condition: () => this.coins >= 200 },
                            { id: 'path_finder', condition: () => Object.values(this.pathProgress).some(v => v >= 3) },
                            { id: 'super_star', condition: () => this.level >= 5 }
                        ];

                        badges.forEach(badge => {
                            if (!this.learningStats.achievements.includes(badge.id) && badge.condition()) {
                                this.awardBadge(badge.id);
                            }
                        });
                    },

                    awardBadge(badgeId) {
                        const badge = this.availableBadges.find(b => b.id === badgeId);
                        if (!badge) return;

                        this.learningStats.achievements.push(badgeId);
                        this.playPing();
                        
                        // Small delay for the confetti to feel linked to the award
                        setTimeout(() => {
                            confetti({
                                particleCount: 150,
                                spread: 70,
                                origin: { y: 0.6 },
                                colors: ['#FFD700', '#FFA500', '#FF4500']
                            });
                        }, 200);

                        // Toast-like notification logic could go here if we had one, 
                        // for now we'll just let the sticker book reflect it.
                        console.log("üèÜ Achievement Unlocked: " + badge.name);
                        this.syncData();
                    },

                    dailyPathData: {
                        day1: { title: "Day 1: Magic Alphabets", type: "alphabet", content: "Let's learn our ABCs! A is for Apple, B is for Ball.", letters: ['A','B','C','D','E'] },
                        day2: { title: "Day 2: Wonderful Words", type: "words", content: "Let's build some words!", words: [{word: "CAT", icon: "üê±"}, {word: "DOG", icon: "üê∂"}, {word: "SUN", icon: "‚òÄÔ∏è"}] },
                        day3: { title: "Day 3: Pop Quiz!", type: "quiz", content: "Show me what you learned!", quiz: [{q: "What starts with A?", options: ["Apple", "Ball", "Cat"], correct: 0}, {q: "Which is an animal?", options: ["Car", "Dog", "Table"], correct: 1}] },
                        day7: { title: "Day 7: Weekly Report", type: "report", content: "You did great this week!" }
                    },

                    curriculum: [
                        { 
                            id: 'math', name: 'Math Geniuses', grade: 'Grade 2', icon: 'üßÆ', color: 'bg-blue-500', premium: false,
                            levels: [
                                { id: 1, title: 'Counting to 100', content: 'Numbers help us count toys! Can you count to 100? 1, 2, 3...', quiz: [{q: 'What comes after 9?', options:['8', '10', '11'], correct:1}, {q: 'Which number is biggest?', options:['5', '50', '2'], correct:1}, {q: '1 + 1 is?', options:['2', '3', '11'], correct:0}] },
                                { id: 2, title: 'Simple Adding', content: 'Adding means putting things together. 2 apples plus 2 apples makes 4!', quiz: [{q: '2 + 2 = ?', options:['3', '4', '5'], correct:1}, {q: '5 + 0 = ?', options:['5', '0', '50'], correct:0}, {q: '1 + 2 = ?', options:['2', '3', '4'], correct:1}] },
                                { id: 3, title: 'Shape Hunter', content: 'Shapes are everywhere! A ball is a circle. A box is a square.', quiz: [{q: 'A ball is a...', options:['Square', 'Circle', 'Triangle'], correct:1}, {q: 'A box has how many sides?', options:['2', '3', '4'], correct:2}, {q: 'Is a pizza round?', options:['Yes', 'No', 'Maybe'], correct:0}] },
                                { id: 4, title: 'Subtraction', content: 'Subtraction is taking away. If you have 3 cookies and eat 1, you have 2 left!', quiz: [{q: '3 - 1 = ?', options:['2', '1', '4'], correct:0}, {q: '5 - 5 = ?', options:['5', '1', '0'], correct:2}, {q: '10 - 1 = ?', options:['8', '9', '11'], correct:1}] },
                                { id: 5, title: 'Money Math', content: 'We use coins to buy things. A penny is 1 cent.', quiz: [{q: 'A penny is...', options:['1 cent', '5 cents', '10 cents'], correct:0}, {q: '2 pennies = ?', options:['2 cents', '5 cents', '100 cents'], correct:0}, {q: 'Is money for eating?', options:['Yes', 'No', 'Sometimes'], correct:1}] }
                            ]
                        },
                        { 
                            id: 'english', name: 'English ABCs', grade: 'Basics', icon: 'üìù', color: 'bg-green-500', premium: true,
                            levels: [
                                { id: 1, title: 'The Vowels', content: 'Vowels are special letters: A, E, I, O, U. Every word needs one!', quiz: [{q: 'Which is a vowel?', options:['B', 'E', 'Z'], correct:1}, {q: 'Is "K" a vowel?', options:['Yes', 'No', 'Maybe'], correct:1}, {q: 'How many vowels?', options:['3', '5', '10'], correct:1}] },
                                { id: 2, title: 'Rhyme Time', content: 'Rhyming words sound the same at the end. Cat, Hat, Bat!', quiz: [{q: 'Rhymes with Dog?', options:['Cat', 'Log', 'Pig'], correct:1}, {q: 'Rhymes with Sun?', options:['Moon', 'Fun', 'Hot'], correct:1}, {q: 'Do Tree and Bee rhyme?', options:['Yes', 'No', 'Maybe'], correct:0}] },
                                { id: 3, title: 'Naming Nouns', content: 'A Noun is a person, place, or thing. Like "Mom", "Park", or "Car".', quiz: [{q: 'Which is a noun?', options:['Run', 'Blue', 'Cat'], correct:2}, {q: 'Is "Jump" a noun?', options:['Yes', 'No', 'Maybe'], correct:1}, {q: 'School is a...', options:['Person', 'Place', 'Thing'], correct:1}] }
                            ]
                        },
                        { 
                            id: 'science', name: 'Science Fun', grade: 'Fun Facts', icon: 'üî¨', color: 'bg-purple-500', premium: true,
                            levels: [
                                { id: 1, title: 'Solar System', content: 'We live on Earth! The Sun is a giant hot star in the middle.', quiz: [{q: 'We live on...', options:['Mars', 'Earth', 'Sun'], correct:1}, {q: 'Is the sun hot?', options:['Yes', 'No', 'Cold'], correct:0}, {q: 'The moon is made of cheese?', options:['Yes', 'No', 'Maybe'], correct:1}] },
                                { id: 2, title: 'Dinosaurs', content: 'Dinosaurs lived long ago. The T-Rex was very big and scary!', quiz: [{q: 'T-Rex was...', options:['Small', 'Big', 'Tiny'], correct:1}, {q: 'Are dinos alive today?', options:['Yes', 'No', 'Birds are!'], correct:2}, {q: 'Did they eat pizza?', options:['Yes', 'No', 'Always'], correct:1}] },
                                { id: 3, title: 'Water Cycle', content: 'Water comes from clouds. Sun dries it up. Then it rains again!', quiz: [{q: 'Rain comes from...', options:['Ground', 'Clouds', 'Trees'], correct:1}, {q: 'Sun makes water...', options:['Freeze', 'Dry up', 'Green'], correct:1}, {q: 'Is snow water?', options:['Yes', 'No', 'Maybe'], correct:0}] }
                            ]
                        }
                    ],

                    shopItems: [
                        { id: 'sparkles', name: 'Magic Sparkles', icon: '‚ú®', price: 100, effectType: 'sparkles' },
                        { id: 'glow', name: 'Super Glow', icon: 'üåü', price: 250, effectType: 'glow' },
                        { id: 'fireflies', name: 'Fireflies', icon: 'üêù', price: 350, effectType: 'fireflies' },
                        { id: 'stars', name: 'Star Orbit', icon: '‚≠ê', price: 450, effectType: 'stars' },
                        { id: 'dust', name: 'Magic Dust', icon: 'ü™Ñ', price: 500, effectType: 'dust' }
                    ],
                    characters: [
                        { 
                            name: "Professor Dino", 
                            subject: "History", 
                            subjectKey: "history",
                            suggestions: ["Who built the pyramids? üèúÔ∏è", "What is a mummy? ü§ï", "Who was the first king? üëë"],
                            icon: "ü¶ñ", mood_happy: "ü¶ñ", mood_think: "ü¶ï", bg: "radial-gradient(circle, #fff9c4 0%, #ffecb3 100%)", accent: "#f59e0b", personality: "History Teacher", intro_phrase: "Rawr! ", premium: false,
                            voiceId: "9740af7a-9674-4be1-967b-cf6daba06596",
                            preferredVoice: "Microsoft Steffan Online (Natural)"
                        },
                        { 
                            name: "Milo Monkey", 
                            subject: "Maths", 
                            subjectKey: "robots",
                            suggestions: ["What is 2 + 2? üçå", "Count to 10! üîü", "What is a circle? üîµ"],
                            icon: "üêµ", mood_happy: "üêµ", mood_think: "ü§î", bg: "radial-gradient(circle, #e0f2fe 0%, #bae6fd 100%)", accent: "#0369a1", personality: "Math Teacher", intro_phrase: "Ooh ooh! Let's count bananas! ", premium: true,
                            voiceId: "79005bb6-7ae3-4768-b2a0-efc774a3c7a9",
                            preferredVoice: "Microsoft Christopher Online (Natural)"
                        },
                        { 
                            name: "Starry Alien", 
                            subject: "Space Exploration", 
                            subjectKey: "space",
                            suggestions: ["How hot is the sun? ‚òÄÔ∏è", "What is a black hole? üï≥Ô∏è", "How many planets are there? ü™ê"],
                            icon: "üëæ", mood_happy: "üõ∏", mood_think: "üëÅÔ∏è", bg: "radial-gradient(circle, #f3e8ff 0%, #e9d5ff 100%)", accent: "#9333ea", personality: "Space Teacher", intro_phrase: "Greetings from the stars! ", premium: true,
                            voiceId: "0062153d-dd11-4330-a6b1-87cd29187ed7",
                            preferredVoice: "Microsoft Jenny Online (Natural)"
                        },
                        { 
                            name: "Magic Cat", 
                            subject: "Science", 
                            subjectKey: "science",
                            suggestions: ["Why does ice melt? üßä", "What is a signature? üçé", "How do magnets work? üß≤"],
                            icon: "üê±", mood_happy: "üò∏", mood_think: "üêà", bg: "radial-gradient(circle, #fce7f3 0%, #fbcfe8 100%)", accent: "#db2777", personality: "Science Teacher", intro_phrase: "Meow! ", premium: true,
                            voiceId: "2c96d996-4e88-44e8-944a-303d5b063775",
                            preferredVoice: "Microsoft Aria Online (Natural)"
                        },
                        { 
                            name: "Bouncy Bee", 
                            subject: "Nature", 
                            subjectKey: "nature",
                            suggestions: ["Why do bees make honey? üçØ", "How do flowers grow? üåª", "Why is the sky blue? ‚òÅÔ∏è"],
                            icon: "üêù", mood_happy: "üåª", mood_think: "üçØ", bg: "radial-gradient(circle, #fef9c3 0%, #fef08a 100%)", accent: "#854d0e", personality: "Nature Teacher", intro_phrase: "Buzz buzz! ", premium: true,
                            voiceId: "a09a1325-058b-4bc7-9105-b96b1cce27c5",
                            preferredVoice: "Microsoft Ana Online (Natural)"
                        }
                    ],
                     currentChar: null,
                     initializeCurrentChar() {
                         if (!this.currentChar && this.characters && this.characters.length > 0) {
                             this.currentChar = this.characters[0];
                         }
                     },

                    t(key) {
                        const dict = {
                            'English': {
                                adventure_map: 'Adventure Map üó∫Ô∏è', magic_auras: 'Magic Auras', daily_gift: 'Daily Gift',
                                parent_portal: 'Parent Dashboard', says: 'says', challenge_me: 'Challenge Me!', listen: 'Listen',
                                stop: 'Stop', ask: 'ASK!', ask_about: 'Ask about', listening: 'Listening',
                                teacher_of: 'Teacher of', thinking: 'Thinking', correct: 'Correct', awesome: 'Awesome!',
                                daily_rewards: 'Daily Rewards!', claim: 'Claim',
                                see_you_tomorrow: 'See You Tomorrow!', active: 'Active Now', buy_now: 'Buy Now', activate: 'Activate',
                                personalized_mission: 'Personalized Mission', choose_journey: 'Choose your journey!', complete: 'Complete',
                                read_to_me: 'Read to me', start_quiz: 'Start Quiz!', type_here: 'Type here'
                            },
                            'Spanish': {
                                adventure_map: 'Mapa de Aventuras üó∫Ô∏è', magic_auras: 'Auras M√°gicas', daily_gift: 'Regalo Diario',
                                parent_portal: 'Panel de Padres', says: 'dice', challenge_me: '¬°Desaf√≠ame!', listen: 'Escuchar',
                                stop: 'Parar', ask: '¬°PREGUNTAR!', ask_about: 'Preguntar sobre', listening: 'Escuchando',
                                teacher_of: 'Profesor de', thinking: 'Pensando', correct: '¬°Correcto!', awesome: '¬°Genial!',
                                daily_rewards: '¬°Premios Diarios!', claim: 'Reclamar',
                                see_you_tomorrow: '¬°Hasta Ma√±ana!', active: 'Activo', buy_now: 'Comprar', activate: 'Activar',
                                personalized_mission: 'Misi√≥n Personalizada', choose_journey: '¬°Elige tu viaje!', complete: 'Completo',
                                read_to_me: 'L√©eme', start_quiz: '¬°Empezar Quiz!', type_here: 'Escribe aqu√≠'
                            },
                            'French': {
                                adventure_map: 'Carte d\'Aventure üó∫Ô∏è', magic_auras: 'Auras Magiques', daily_gift: 'Cadeau Quotidien',
                                parent_portal: 'Tableau de Bord', says: 'dit', challenge_me: 'D√©fie-moi!', listen: '√âcouter',
                                stop: 'Arr√™ter', ask: 'DEMANDER!', ask_about: 'Demander sur', listening: '√âcoute',
                                teacher_of: 'Professeur de', thinking: 'R√©flexion', correct: 'Correct!', awesome: 'G√©nial!',
                                daily_rewards: 'R√©compenses Quotidiennes!', claim: 'R√©clamer',
                                see_you_tomorrow: '√Ä Demain!', active: 'Actif', buy_now: 'Acheter', activate: 'Activer',
                                personalized_mission: 'Mission Personnalis√©e', choose_journey: 'Choisis ton voyage!', complete: 'Termin√©',
                                read_to_me: 'Lis pour moi', start_quiz: 'Commencer le Quiz!', type_here: '√âcris ici'
                            },
                            'German': {
                                adventure_map: 'Abenteuerkarte üó∫Ô∏è', magic_auras: 'Magische Auren', daily_gift: 'T√§gliches Geschenk',
                                parent_portal: 'Eltern-Dashboard', says: 'sagt', challenge_me: 'Fordere mich heraus!', listen: 'H√∂ren',
                                stop: 'Stopp', ask: 'FRAGEN!', ask_about: 'Fragen √ºber', listening: 'H√∂ren',
                                teacher_of: 'Lehrer f√ºr', thinking: 'Nachdenken', correct: 'Richtig!', awesome: 'Super!',
                                daily_rewards: 'T√§gliche Belohnungen!', claim: 'Abholen',
                                see_you_tomorrow: 'Bis morgen!', active: 'Aktiv', buy_now: 'Kaufen', activate: 'Aktivieren',
                                personalized_mission: 'Personalisierte Mission', choose_journey: 'W√§hle deine Reise!', complete: 'Abgeschlossen',
                                read_to_me: 'Lies mir vor', start_quiz: 'Quiz starten!', type_here: 'Hier tippen'
                            },
                            'Arabic': {
                                adventure_map: 'ÿÆÿ±Ÿäÿ∑ÿ© ÿßŸÑŸÖÿ∫ÿßŸÖÿ±ÿ© üó∫Ô∏è', magic_auras: 'ÿßŸÑŸáÿßŸÑÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿ±Ÿäÿ©', daily_gift: 'ŸáÿØŸäÿ© ŸäŸàŸÖŸäÿ©',
                                parent_portal: 'ŸÑŸàÿ≠ÿ© ÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸàÿßŸÑÿØŸäŸÜ', says: 'ŸäŸÇŸàŸÑ', challenge_me: 'ÿ™ÿ≠ÿØÿßŸÜŸä!', listen: 'ÿßÿ≥ÿ™ŸÖÿπ',
                                stop: 'ÿ™ŸàŸÇŸÅ', ask: 'ÿßÿ≥ÿ£ŸÑ!', ask_about: 'ÿßÿ≥ÿ£ŸÑ ÿπŸÜ', listening: 'ÿ£ÿ≥ŸÖÿπŸÉ',
                                teacher_of: 'ŸÖÿØÿ±ÿ≥', thinking: 'ŸäŸÅŸÉÿ±', correct: 'ÿµÿ≠Ÿäÿ≠!', awesome: 'ÿ±ÿßÿ¶ÿπ!',
                                daily_rewards: 'ŸÖŸÉÿßŸÅÿ¢ÿ™ ŸäŸàŸÖŸäÿ©!', claim: 'ÿßÿ≠ÿµŸÑ ÿπŸÑŸäŸáÿß',
                                see_you_tomorrow: 'ÿ£ÿ±ÿßŸÉ ÿ∫ÿØÿßŸã!', active: 'ŸÜÿ¥ÿ∑', buy_now: 'ÿ¥ÿ±ÿßÿ°', activate: 'ÿ™ŸÅÿπŸäŸÑ',
                                personalized_mission: 'ŸÖŸáŸÖÿ© ŸÖÿÆÿµÿµÿ©', choose_journey: 'ÿßÿÆÿ™ÿ± ÿ±ÿ≠ŸÑÿ™ŸÉ!', complete: 'ŸÖŸÉÿ™ŸÖŸÑ',
                                read_to_me: 'ÿßŸÇÿ±ÿ£ ŸÑŸä', start_quiz: 'ÿßÿ®ÿØÿ£ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±!', type_here: 'ÿßŸÉÿ™ÿ® ŸáŸÜÿß'
                            }
                        };
                        return dict[this.currentLanguage][key] || dict['English'][key];
                    },
                    
                    isProfileLoading: false,
                    async init() {
                        this.initializeCurrentChar();
                        this.startTimeTracking();
                        
                        // Check if user has completed onboarding
                        const onboardingCompleted = localStorage.getItem('onboarding_completed');
                        this.hasCompletedOnboarding = onboardingCompleted === 'true';
                        // Safety Timeout: Force loading off after 5 seconds if still stuck
                        setTimeout(() => {
                            console.log("SAFETY TIMEOUT CHECK: isLoading is", this.isLoading);
                            if (this.isLoading) {
                                console.warn("Forcing loading screen off due to timeout.");
                                this.isLoading = false;
                            }
                        }, 15000); // Increased from 5s to 15s

                        this.currentMoodIcon = this.currentChar?.icon || 'ü¶ñ';
                        this.isLoading = true;

                        this.generateGate();

                        this.sessionStartTime = Date.now();
                        setInterval(() => {
                            this.totalMinutesLearned++;
                            this.syncData();
                        }, 60000);

                        try {
                            const res = await fetch('/api/config');
                            const config = await res.json();
                            this.supabase = supabase.createClient(config.supabaseUrl, config.supabaseKey);

                            // 1. Check for existing session immediately before showing ANY UI
                            const { data: { session } } = await this.supabase.auth.getSession();
                            this.session = session;
                            
                            if (session) {
                                this.registeredEmail = session.user.email;
                                this.hasAccount = true;
                                // No longer calling loadUserProfile here to avoid duplication with onAuthStateChange
                            }

                            // 2. Set up the auth listener for future events
                            this.supabase.auth.onAuthStateChange(async (event, session) => {
                                console.log("Auth Event:", event);
                                this.session = session;
                                if (session) {
                                    this.registeredEmail = session.user.email;
                                    this.hasAccount = true;
                                    await this.loadUserProfile(session.user.email);
                                } else if (event === 'SIGNED_OUT') {
                                    this.isLoggedIn = false;
                                    this.session = null;
                                    this.childProfile = { name: '', age: '', grade: '', ageRange: '6-7' };
                                    this.coins = 0;
                                    this.xp = 0;
                                    this.isLoading = false; 
                                }
                            });

                        } catch (e) {
                            console.error("Initialization error:", e);
                        } finally {
                            console.log("INIT FINALLY BLOCK EXECUTED");
                            // spinner handled by session state
                            this.isLoading = false;
                            
                            // Show onboarding for first-time users after login
                            if (this.isLoggedIn && !this.hasCompletedOnboarding) {
                                setTimeout(() => {
                                    this.showOnboarding = true;
                                    this.toggleScroll(true);
                                }, 1000);
                            }
                        }

                        this.$watch('safetySettings.blockedWords', value => localStorage.setItem('blocked_words', value));
                        this.$watch('isTimeUp', value => {
                            if (value) this.parentVerified = false;
                        });
                    },

                    generateGate() {
                        const num1 = Math.floor(Math.random() * 20) + 10;
                        const num2 = Math.floor(Math.random() * 15) + 5;
                        this.gateQuestion = `${num1} + ${num2}`;
                        this.correctGateResult = num1 + num2;
                    },
                    verifyGate() {
                        if (parseInt(this.gateAnswer) === this.correctGateResult) {
                            this.gateVerified = true;
                            this.playPing();
                        } else {
                            alert("Incorrect. Please try again or ask an adult for help.");
                            this.gateAnswer = '';
                            this.generateGate();
                        }
                    },

                    startVoiceMode() {
                        this.isVoiceNativeMode = true;
                        this.isKeyboardMode = false;
                        this.stopSpeaking();
                        this.startListening();
                    },

                    stopVoiceMode() {
                        this.isVoiceNativeMode = false;
                        this.isListening = false;
                        this.stopSpeaking();
                        this.isSpeaking = false;
                    },



                    mediaRecorder: null,
                    audioChunks: [],
                    async startListening() {
                        if (this.isListening) return;
                        
                        try {
                            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                            this.mediaRecorder = new MediaRecorder(stream);
                            this.audioChunks = [];

                            this.mediaRecorder.ondataavailable = (event) => {
                                this.audioChunks.push(event.data);
                            };

                            this.mediaRecorder.onstop = async () => {
                                const audioBlob = new Blob(this.audioChunks, { type: 'audio/wav' });
                                const reader = new FileReader();
                                reader.readAsDataURL(audioBlob);
                                reader.onloadend = async () => {
                                    const base64Audio = reader.result.split(',')[1];
                                    this.isThinking = true;
                                    try {
                                        const response = await fetch('/api/stt', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ audio: base64Audio })
                                        });
                                        const data = await response.json();
                                        if (data.transcript) {
                                            this.userQuery = data.transcript;
                                            this.askTutor();
                                        }
                                    } catch (e) {
                                        console.error("STT Error:", e);
                                    } finally {
                                        this.isThinking = false;
                                        this.isListening = false;
                                    }
                                };
                            };

                            this.mediaRecorder.start();
                            this.isListening = true;
                            this.stopSpeaking();

                            // Auto-stop after 5 seconds of silence or fixed duration for kids
                            setTimeout(() => {
                                if (this.isListening && this.mediaRecorder.state === "recording") {
                                    this.mediaRecorder.stop();
                                    stream.getTracks().forEach(track => track.stop());
                                }
                            }, 5000);

                        } catch (e) {
                            console.error("Mic Access Error:", e);
                            alert("Please allow microphone access to talk!");
                            this.isListening = false;
                        }
                    },


                    currentAudio: null,
                    audioContext: null,

                    // Helper to unlock audio on first interaction
                    unlockAudio() {
                        if (!this.audioContext) {
                            const AudioContext = window.AudioContext || window.webkitAudioContext;
                            if (AudioContext) {
                                this.audioContext = new AudioContext();
                            }
                        }
                        
                        // Create a dummy audio object to 'unlock' playback if it doesn't exist
                        if (!this.currentAudio) {
                            this.currentAudio = new Audio();
                        }
                        
                        // Play a silent buffer if possible
                        if (this.audioContext && this.audioContext.state === 'suspended') {
                            this.audioContext.resume();
                        }
                    },

                    async speak(text) {
                        this.unlockAudio();

                        if (this.currentAudio) {
                            this.currentAudio.pause();
                            this.currentAudio.src = "";
                        }
                        this.isSpeaking = false;

                        if (!text) return;

                        try {
                            const cleanText = text.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '');
                            
                            const response = await fetch('/api/tts', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    text: cleanText,
                                    voiceId: this.currentChar.voiceId || "9740af7a-9674-4be1-967b-cf6daba06596"
                                })
                            });
                            
                            if (!response.ok) {
                                throw new Error("TTS API Limit or Failure");
                            }

                            const blob = await response.blob();
                            const url = URL.createObjectURL(blob);
                            
                            this.currentAudio.src = url;
                            
                            this.currentAudio.onplay = () => { this.isSpeaking = true; };
                            this.currentAudio.onended = () => { 
                                this.isSpeaking = false; 
                                if (this.isVoiceNativeMode) {
                                    this.startListening();
                                }
                                URL.revokeObjectURL(url);
                            };
                            this.currentAudio.onerror = (e) => { 
                                console.error("Audio playback error:", e);
                                this.speakNative(text); // Fallback on playback error
                                URL.revokeObjectURL(url);
                            };
                            
                            await this.currentAudio.play();
                        } catch (e) {
                            console.warn("Cloud TTS failed, using browser fallback:", e.message);
                            this.speakNative(text);
                        }
                    },

                    playCharIntro(name) {
                        try {
                            const AudioContext = window.AudioContext || window.webkitAudioContext;
                            const context = new AudioContext();
                            const osc = context.createOscillator();
                            const gain = context.createGain();
                            const time = context.currentTime;
                            
                            gain.connect(context.destination);
                            osc.connect(gain);

                            const profiles = {
                                "Professor Dino": () => {
                                    osc.type = 'triangle';
                                    osc.frequency.setValueAtTime(300, time);
                                    osc.frequency.exponentialRampToValueAtTime(600, time + 0.2);
                                    osc.frequency.exponentialRampToValueAtTime(450, time + 0.4);
                                    gain.gain.setValueAtTime(0.2, time);
                                    gain.gain.exponentialRampToValueAtTime(0.01, time + 0.5);
                                    osc.start(time); osc.stop(time + 0.5);
                                },
                                "Milo Monkey": () => {
                                    osc.type = 'square';
                                    osc.frequency.setValueAtTime(440, time);
                                    osc.frequency.exponentialRampToValueAtTime(880, time + 0.1);
                                    osc.frequency.exponentialRampToValueAtTime(440, time + 0.2);
                                    gain.gain.setValueAtTime(0.05, time);
                                    gain.gain.exponentialRampToValueAtTime(0.01, time + 0.3);
                                    osc.start(time); osc.stop(time + 0.3);
                                },
                                "Starry Alien": () => {
                                    osc.type = 'triangle';
                                    osc.frequency.setValueAtTime(660, time);
                                    osc.frequency.sineCurveToValueAtTime = (v, t) => osc.frequency.setValueAtTime(v, t); // helper
                                    for(let i=0; i<10; i++) osc.frequency.exponentialRampToValueAtTime(660 + (i%2?100:-100), time + (i*0.05));
                                    gain.gain.setValueAtTime(0.1, time);
                                    gain.gain.exponentialRampToValueAtTime(0.01, time + 0.6);
                                    osc.start(time); osc.stop(time + 0.6);
                                },
                                "Magic Cat": () => {
                                    osc.type = 'sine';
                                    osc.frequency.setValueAtTime(880, time);
                                    gain.gain.setValueAtTime(0, time);
                                    gain.gain.linearRampToValueAtTime(0.1, time + 0.1);
                                    gain.gain.exponentialRampToValueAtTime(0.01, time + 0.6);
                                    // Sparkle effect using multiple oscillators isn't possible with one var, so we just do a nice swipe
                                    osc.frequency.exponentialRampToValueAtTime(1760, time + 0.4);
                                    osc.start(time); osc.stop(time + 0.6);
                                },
                                "Bouncy Bee": () => {
                                    osc.type = 'sawtooth';
                                    osc.frequency.setValueAtTime(220, time);
                                    for(let i=0; i<15; i++) osc.frequency.setValueAtTime(220 + (i%2?50:0), time + (i*0.02));
                                    gain.gain.setValueAtTime(0.05, time);
                                    gain.gain.exponentialRampToValueAtTime(0.01, time + 0.4);
                                    osc.start(time); osc.stop(time + 0.4);
                                }
                            };

                            const play = profiles[name] || profiles["Magic Cat"];
                            play();
                            setTimeout(() => context.close(), 1000);
                        } catch (e) { console.error("Intro sound error", e); }
                    },

                    speakNative(text) {
                        console.log("üì¢ Using Browser Native Speech Synthesis Fallback");
                        this.stopSpeaking();
                        this.isSpeaking = true;
                        
                        this.playCharIntro(this.currentChar.name);

                        const msg = new SpeechSynthesisUtterance(text);
                        const voices = window.speechSynthesis.getVoices();
                        
                        // 1. Try to find the specific high-quality Microsoft Edge Neural voice
                        let targetVoice = voices.find(v => v.name === this.currentChar.preferredVoice);
                        
                        // 2. Fallback to any "Natural" voice for the language
                        if (!targetVoice) {
                            const langCodes = { 'English': 'en', 'Spanish': 'es', 'French': 'fr', 'German': 'de', 'Arabic': 'ar' };
                            const targetCode = langCodes[this.currentLanguage] || 'en';
                            targetVoice = voices.find(v => v.lang.startsWith(targetCode) && (v.name.includes("Online (Natural)") || v.name.includes("Google") || v.name.includes("Natural")));
                        }
                        
                        // 3. Ultimate fallback
                        if (!targetVoice) targetVoice = voices.find(v => v.lang.startsWith('en')) || voices[0];
                        
                        if (targetVoice) msg.voice = targetVoice;

                        // Natural settings for high-quality voices + Intro sounds
                        const voiceSettings = {
                            "Professor Dino": { pitch: 1.0, rate: 0.95 },
                            "Milo Monkey": { pitch: 1.05, rate: 1.05 },
                            "Starry Alien": { pitch: 1.0, rate: 0.85 },
                            "Magic Cat": { pitch: 1.05, rate: 1.0 },
                            "Bouncy Bee": { pitch: 1.05, rate: 1.1 }
                        };

                        const settings = voiceSettings[this.currentChar.name] || { pitch: 1.0, rate: 1.0 };
                        msg.pitch = settings.pitch;
                        msg.rate = settings.rate;

                        msg.onend = () => { 
                            this.isSpeaking = false;
                            if (this.isVoiceNativeMode) {
                                this.startListening();
                            }
                        };
                        msg.onerror = (err) => {
                            console.error("Native Speech Error:", err);
                            this.isSpeaking = false;
                        };

                        window.speechSynthesis.speak(msg);
                    },

                    stopSpeaking() {
                        // 1. Stop MP3 Audio (API)
                        if (this.currentAudio) {
                            this.currentAudio.pause();
                            this.currentAudio.src = "";
                        }
                        // 2. Stop Speech Synthesis (Fallback/Native)
                        window.speechSynthesis.cancel();
                        
                        this.isSpeaking = false;
                    },


                    async generateNewPath() {
                        if (this.isGeneratingPath) return;
                        
                        if (!this.isPremium) {
                            this.showPremiumModal = true;
                            return;
                        }

                        // --- Usage Quota Check ---
                        const currentMonth = new Date().getMonth();
                        if (this.lastQuestMonth !== currentMonth) {
                            this.monthlyQuestsUsed = 0;
                            this.lastQuestMonth = currentMonth;
                        }

                        if (this.monthlyQuestsUsed >= this.maxMonthlyQuests) {
                            alert(`üåü You've reached your monthly limit of ${this.maxMonthlyQuests} AI quests! This helps us keep the app running for everyone. Try again next month!`);
                            return;
                        }

                        this.isGeneratingPath = true;
                        const ageRange = this.childProfile.ageRange || '6-7';
                        const currentTopics = this.curriculum.map(p => p.name).join(", ");
                        const region = this.currentCurriculumRegion || 'Global';

                        try {
                            const systemPrompt = `You are a curriculum designer for kids. Create a NEW 3-level learning path for a ${ageRange} year old.
                            The topic must be educational (Science, Math, History, or Arts) and NOT already in this list: ${currentTopics}.
                            All content must be in ${this.currentLanguage}.
                            Strictly follow ${region} educational standards.
                            
                            Return ONLY JSON in this format:
                            {
                                "id": "unique_string_id",
                                "name": "Fun Path Name",
                                "grade": "Level Description",
                                "icon": "Emoji",
                                "color": "bg-[color]-500",
                                "premium": true,
                                "levels": [
                                    {
                                        "id": 1,
                                        "title": "Level 1 Title",
                                        "content": "A short teaching paragraph (max 4 sentences) for a ${ageRange} year old.",
                                        "quiz": [
                                            {"q": "Q1?", "options": ["A", "B", "C"], "correct": 0},
                                            {"q": "Q2?", "options": ["A", "B", "C"], "correct": 1},
                                            {"q": "Q3?", "options": ["A", "B", "C"], "correct": 2}
                                        ]
                                    }
                                ]
                            }
                            Create exactly 3 levels. Ensure content is simple and engaging.`;

                            const response = await fetch("/api/chat", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    "messages": [
                                        { "role": "system", "content": systemPrompt },
                                        { "role": "user", "content": "Generate a new learning adventure path." }
                                    ]
                                })
                            });

                            const data = await response.json();
                            
                            // Support potential markdown wrapping in the response
                            let rawResponse = data.response;
                            if (typeof rawResponse === 'string') {
                                rawResponse = rawResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                            }
                            
                            const newPath = JSON.parse(rawResponse);
                            
                            newPath.id = 'gen_' + Date.now();
                            
                            this.curriculum.push(newPath);
                            this.monthlyQuestsUsed++; // Increment monthly usage
                            this.playPing();
                            confetti({
                                particleCount: 150,
                                spread: 70,
                                origin: { y: 0.6 },
                                colors: ['#A855F7', '#EC4899', '#3B82F6']
                            });
                            
                            await this.syncData();
                        } catch (e) {
                            console.error("Generator Error:", e);
                            alert("The magic wand is recharging! Try again in a minute.");
                        } finally {
                            this.isGeneratingPath = false;
                        }
                    },

                    printCertificate(path) {
                        this.selectedCertificatePath = path;
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF({
                            orientation: "landscape",
                            unit: "mm",
                            format: "a4"
                        });

                        doc.setFillColor(255, 255, 255);
                        doc.rect(0, 0, 297, 210, 'F');
                        doc.setDrawColor(245, 158, 11); 
                        doc.setLineWidth(5);
                        doc.rect(10, 10, 277, 190);

                        doc.setTextColor(245, 158, 11);
                        doc.setFontSize(40);
                        doc.text("Certificate of Achievement", 148, 40, { align: "center" });

                        doc.setTextColor(100, 100, 100);
                        doc.setFontSize(20);
                        doc.text("This award is proudly presented to", 148, 60, { align: "center" });

                        doc.setTextColor(30, 41, 59);
                        doc.setFontSize(50);
                        doc.text(this.childProfile.name, 148, 90, { align: "center" });

                        doc.setTextColor(100, 100, 100);
                        doc.setFontSize(16);
                        const description = `For successfully completing the ${path.name} adventure path and showing incredible curiosity and brilliance in learning!`;
                        const splitDescription = doc.splitTextToSize(description, 200);
                        doc.text(splitDescription, 148, 110, { align: "center" });

                        doc.text("Date: " + new Date().toLocaleDateString(), 148, 150, { align: "center" });
                        doc.text("Teacher: AI Tutor " + path.icon, 148, 160, { align: "center" });

                        doc.save(`Certificate_${this.childProfile.name}_${path.id}.pdf`);
                    },

                    downloadMonthlyReport() {
                        if (!this.isPremium) {
                            this.showPremiumModal = true;
                            return;
                        }
                        
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF();
                        
                        doc.setFontSize(22);
                        doc.text("Monthly Learning Report", 20, 20);
                        
                        doc.setFontSize(14);
                        doc.text(`Student: ${this.childProfile.name}`, 20, 35);
                        doc.text(`Report Date: ${new Date().toLocaleDateString()}`, 20, 42);
                        
                        doc.setLineWidth(0.5);
                        doc.line(20, 48, 190, 48);

                        doc.setFontSize(16);
                        doc.text("Stats Overview", 20, 60);
                        doc.setFontSize(12);
                        doc.text(`- Questions Asked: ${this.parentLogs.length}`, 30, 70);
                        doc.text(`- Words Read: ${this.learningStats.wordsLearned}`, 30, 77);
                        doc.text(`- Coins Earned: ${this.coins}`, 30, 84);
                        doc.text(`- Total Experience (XP): ${this.xp}`, 30, 91);

                        doc.setFontSize(16);
                        doc.text("Subject Mastery", 20, 110);
                        let y = 120;
                        Object.entries(this.getTopSubjects()).forEach(([subject, score]) => {
                            doc.setFontSize(12);
                            doc.text(`${subject}: ${score} pts`, 30, y);
                            y += 7;
                        });

                        doc.save(`Report_${this.childProfile.name}.pdf`);
                    },

                     async sendDailyReport(force = false) {
                        if (!this.isPremium) return;
                        
                        const today = new Date();
                        const lastSent = this.lastSummaryDate ? new Date(this.lastSummaryDate) : null;

                        // Check if it's been at least 24 hours since the last report
                        if (!force && lastSent && (today - lastSent) < (24 * 60 * 60 * 1000)) return;

                        try {
                            const topSubjects = Object.entries(this.getTopSubjects())
                                .filter(([_, score]) => score > 0)
                                .map(([name, score]) => `${name} (${score} pts)`)
                                .join(", ");

                            const summaryContent = `
                                VERIFIED DAILY PROGRESS REPORT
                                --------------------------------------------------
                                Student: ${this.childProfile.name}
                                Report Date: ${today.toLocaleDateString()}
                                
                                üèÜ LEARNING MILESTONES
                                - Active Learning Time: ${this.totalMinutesLearned} minutes
                                - New Words Mastered: ${this.learningStats.wordsLearned}
                                - Total XP Gained: ${this.xp}
                                - Questions Asked Today: ${this.parentLogs.length}

                                üìö SUBJECT BREAKDOWN
                                ${Object.entries(this.getTopSubjects()).map(([k,v]) => `- ${k}: ${v} pts`).join('\n')}

                                üìù RECENT CURIOSITY
                                ${this.parentLogs.slice(-5).reverse().map(l => `- Asked "${l.query}"`).join('\n')}
                                
                                This report verifies daily engagement with the AI Tutor curriculum.
                            `;

                            console.log("AUTOMATED: SENDING DAILY REPORT TO: " + this.registeredEmail);

                            const response = await fetch("/api/send-email", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    to: this.registeredEmail,
                                    subject: `Daily Progress Report: ${this.childProfile.name}`,
                                    body: summaryContent
                                })
                            });

                            if (!response.ok) throw new Error("Email service error");

                            this.lastSummaryDate = today.toISOString();
                            await this.syncData();
                        } catch (e) {
                            console.error("Failed to send automated daily report:", e);
                        }
                    },

                    getPathProgress(pathId) {
                        const completed = this.pathProgress[pathId] || 0;
                        const total = this.curriculum.find(p => p.id === pathId).levels.length;
                        return (completed / total) * 100;
                    },
                    isLevelUnlocked(pathId, levelId) {
                        const completed = this.pathProgress[pathId] || 0;
                        return levelId === 1 || completed >= (levelId - 1);
                    },
                    isLevelComplete(pathId, levelId) {
                        const completed = this.pathProgress[pathId] || 0;
                        return completed >= levelId;
                    },
                    openLesson(level) {
                        this.activeLesson = level;
                        this.lessonStep = 'learn';
                        this.currentLessonQuizIndex = 0;
                        this.toggleScroll(true);
                    },
                    closeLesson() {
                        this.activeLesson = null;
                        this.toggleScroll(false);
                    },
                    getCurrentLessonQuestion() {
                        if (!this.activeLesson) return {q:'', options:[], correct:0};
                        return this.activeLesson.quiz[this.currentLessonQuizIndex];
                    },
                    checkLessonAnswer(index) {
                        const currentQ = this.getCurrentLessonQuestion();
                        if(index === currentQ.correct) {
                            this.consecutiveMistakes = 0; // Reset mistakes on success
                            this.isVisualMode = false;
                            this.playPing();
                            if(this.currentLessonQuizIndex < 2) {
                                this.currentLessonQuizIndex++;
                            } else {
                                this.lessonStep = 'success';
                                this.playPing();
                                confetti({ particleCount: 200, spread: 100 });
                            }
                        } else {
                            this.handleMistake();
                            alert("Oops! Try again!");
                        }
                    },
                    handleMistake() {
                        this.consecutiveMistakes++;
                        if (this.consecutiveMistakes >= 2) {
                            this.isVisualMode = true;
                            this.playPing(); // Trigger different feedback sound maybe
                        }
                    },
                    async completeLesson() {
                        const pathId = this.currentPath.id;
                        const currentLevel = this.pathProgress[pathId] || 0;
                        
                        if (this.activeLesson.id > currentLevel) {
                            this.pathProgress[pathId] = this.activeLesson.id;
                        }
                        
                        this.coins += 50;
                        this.xp += 100;
                        if (!this.learningStats.quizzesCompleted) this.learningStats.quizzesCompleted = 0;
                        this.learningStats.quizzesCompleted++;
                        this.updateLevel();
                        this.checkAchievements();
                        await this.syncData();
                        this.closeLesson();
                    },

                    async resetMapProgress() {
                        if(confirm("Restart your Adventure Map progress? This will reset all paths to 0%.")) {
                            this.pathProgress = {};
                            await this.syncData();
                            alert("Map progress has been reset!");
                        }
                    },

                    // --- MULTI-CHILD MANAGEMENT ---
                    async addNewProfile(name, ageRange = '6-7') {
                        const newId = 'child_' + Date.now();
                        const newProfile = {
                            id: newId,
                            name: name,
                            ageRange: ageRange,
                            coins: 0,
                            xp: 0,
                            inventory: [],
                            equippedItem: null,
                            pathProgress: {},
                            monthlyQuestsUsed: 0,
                            lastQuestMonth: new Date().getMonth(),
                            dailyTimeLimit: 0,
                            timeUsedToday: 0,
                            curriculum: [
                                { 
                                    id: 'math', name: 'Math Geniuses', grade: 'Grade 2', icon: 'üßÆ', color: 'bg-blue-500', premium: false,
                                    levels: [
                                        { id: 1, title: 'Counting to 100', content: 'Numbers help us count toys! Can you count to 100? 1, 2, 3...', quiz: [{q: 'What comes after 9?', options:['8', '10', '11'], correct:1}, {q: 'Which number is biggest?', options:['5', '50', '2'], correct:1}, {q: '1 + 1 is?', options:['2', '3', '11'], correct:0}] }
                                    ]
                                }
                            ],
                            achievements: [],
                            quizzesCompleted: 0
                        };
                        this.allProfiles.push(newProfile);
                        if (!this.activeProfileId) {
                            await this.switchProfile(newId);
                        } else {
                            await this.syncData();
                        }
                        this.playPing();
                    },

                    saveCurrentProfileToCollection() {
                        if (!this.activeProfileId) return;
                        const index = this.allProfiles.findIndex(p => p.id === this.activeProfileId);
                        if (index === -1) return;

                        this.allProfiles[index] = {
                            ...this.allProfiles[index],
                            name: this.childProfile.name,
                            ageRange: this.childProfile.ageRange,
                            coins: this.coins,
                            xp: this.xp,
                            inventory: JSON.parse(JSON.stringify(this.inventory)),
                            equippedItem: this.equippedItem,
                            pathProgress: JSON.parse(JSON.stringify(this.pathProgress)),
                            dailyTimeLimit: this.dailyTimeLimit,
                            timeUsedToday: this.timeUsedToday,
                            curriculum: JSON.parse(JSON.stringify(this.curriculum)),
                            achievements: JSON.parse(JSON.stringify(this.learningStats.achievements || [])),
                            quizzesCompleted: this.learningStats.quizzesCompleted || 0
                        };
                    },

                    async switchProfile(profileId) {
                        this.isLoading = true;
                        this.saveCurrentProfileToCollection();
                        
                        const profile = this.allProfiles.find(p => p.id === profileId);
                        if (profile) {
                            this.activeProfileId = profileId;
                            this.childProfile = { name: profile.name, ageRange: profile.ageRange };
                            this.coins = profile.coins || 0;
                            this.xp = profile.xp || 0;
                            this.inventory = profile.inventory || [];
                            this.equippedItem = profile.equippedItem || null;
                            this.pathProgress = profile.pathProgress || {};
                            this.monthlyQuestsUsed = profile.monthlyQuestsUsed || 0;
                            this.lastQuestMonth = profile.lastQuestMonth;
                            this.dailyTimeLimit = profile.dailyTimeLimit || 0;
                            this.timeUsedToday = profile.timeUsedToday || 0;
                            this.isTimeUp = (this.dailyTimeLimit > 0 && this.timeUsedToday >= this.dailyTimeLimit);
                            this.lastTimeUpdate = Date.now();
                            this.curriculum = profile.curriculum || [];
                            this.learningStats.achievements = profile.achievements || [];
                            this.learningStats.quizzesCompleted = profile.quizzesCompleted || 0;
                        }
                        
                        await this.syncData();
                        this.isLoading = false;
                        this.showProfileSwitcher = false;
                        this.playPing();
                    },

                    async deleteProfile(profileId) {
                        if (this.allProfiles.length <= 1) {
                            alert("You must have at least one child profile!");
                            return;
                        }
                        if (confirm("Are you sure you want to delete this profile? All progress will be lost.")) {
                            this.allProfiles = this.allProfiles.filter(p => p.id !== profileId);
                            if (this.activeProfileId === profileId) {
                                await this.switchProfile(this.allProfiles[0].id);
                            } else {
                                await this.syncData();
                            }
                        }
                    },



                    startTimeTracking() {
                        if (this.timeCheckInterval) clearInterval(this.timeCheckInterval);
                        
                        this.timeCheckInterval = setInterval(() => {
                            if (!this.registeredEmail || !this.activeProfileId || this.isTimeUp) return;
                            
                            const now = Date.now();
                            const diffMinutes = Math.floor((now - this.lastTimeUpdate) / 60000);
                            
                            if (diffMinutes >= 1) {
                                this.timeUsedToday += diffMinutes;
                                this.lastTimeUpdate = now;
                                
                                // Check limit
                                if (this.dailyTimeLimit > 0 && this.timeUsedToday >= this.dailyTimeLimit) {
                                    this.isTimeUp = true;
                                    this.parentVerified = false;
                                    this.playPing();
                                }
                                
                                // Sync occasionally (every 5 mins of usage)
                                if (this.timeUsedToday % 5 === 0) {
                                    this.syncData();
                                }
                            }
                        }, 30000); // Check every 30 seconds
                    },

                    async loadUserProfile(email) {
                        if (this.isProfileLoading) return;
                        this.isProfileLoading = true;
                        console.log("Loading Profile for:", email);
                        try {
                            // Create a promise for the DB query
                            const queryPromise = this.supabase
                                .from('profiles')
                                .select('*')
                                .eq('email', email)
                                .single();

                            // Create a timeout promise
                            const timeoutPromise = new Promise((_, reject) => 
                                setTimeout(() => reject(new Error("Profile load timed out")), 20000)
                            );

                            // Race them
                            const { data, error } = await Promise.race([queryPromise, timeoutPromise]);
                            
                            console.log("Profile Data:", data, "Error:", error);

                            if (data) {
                                console.log("Profile found! Populating...");
                                this.populateUserData(data);
                                // Note: We do NOT set isLoggedIn = true here anymore.
                                // The user must enter their PIN to unlock the app if it's a session restoration.
                                // If they just logged in, we set isLoggedIn elsewhere or here if we detect it's a fresh login.
                                this.isLoading = false; 
                                this.playPing();
                                if (!this.rewardClaimedToday) {
                                    setTimeout(() => {
                                        this.showRewards = true;
                                        this.toggleScroll(true);
                                    }, 1000);
                                }
                            } else {
                                console.warn("No profile found - possibly deleted.");
                                this.isLoggedIn = false;
                                this.isLoading = false;
                                await this.supabase.auth.signOut();
                                alert("We couldn't find your profile data. Please create a new account.");
                                this.hasAccount = false; 
                            }
                        } catch (e) {
                            console.error("Sync error in loadUserProfile:", e);
                            this.isLoading = false;
                            
                            if (e.message === "Profile load timed out") {
                                console.warn("Profile load timed out. User might need to refresh or check connection.");
                            }
                        } finally {
                            this.isProfileLoading = false;
                        }
                    },

                    populateUserData(data) {
                        this.registeredEmail = data.email;
                        this.savedProfile = { name: data.name, email: data.email };
                        this.coins = Number(data.coins) || 0; 
                        this.xp = data.xp || 0;
                        this.masterPin = data.pin || ''; // Capture PIN from DB
                        this.parentLogs = data.parent_logs || [];
                        
                        // 1. Parse learning_stats once
                        let rawStats = data.learning_stats;
                        if (typeof rawStats === 'string') {
                            try { 
                                rawStats = JSON.parse(rawStats); 
                            } catch(e) { 
                                console.error("Parse stats failed", e); 
                                rawStats = {}; 
                            }
                        }
                        
                        // 2. Initialize learningStats with defaults if missing
                        this.learningStats = rawStats || {
                            wordsLearned: 0,
                            subjects: { history: 0, robots: 0, space: 0, science: 0, nature: 0 },
                            child_profile: { name: data.name, ageRange: '6-7' },
                            recent_mistakes: [],
                            emotions: { excited: 0, curious: 0, frustrated: 0, happy: 0, neutral: 0 },
                            inventory: [],
                            equipped_item: null,
                            path_progress: {}
                        };

                        // 3. Populate sub-states from learningStats
                        this.childProfile = this.learningStats.child_profile || { name: data.name, ageRange: '6-7' };
                        this.totalMinutesLearned = data.total_minutes || this.learningStats.total_minutes || 0;
                        this.emailSummaryEnabled = data.email_summary_enabled || this.learningStats.email_summary_enabled || false;
                        this.lastSummaryDate = data.last_summary_date || this.learningStats.last_summary_date || null;
                        this.currentLanguage = data.current_language || this.learningStats.current_language || 'English';
                        this.currentCurriculumRegion = this.learningStats.current_curriculum_region || 'Global';
                        this.inventory = this.learningStats.inventory || data.inventory || [];
                        this.equippedItem = this.learningStats.equipped_item || data.equipped_item || null;
                        this.pathProgress = this.learningStats.path_progress || {};
                        this.hasCompletedOnboarding = (this.learningStats.has_completed_onboarding !== undefined) ? this.learningStats.has_completed_onboarding : !!localStorage.getItem('onboarding_completed');
                        
                        // Load Monthly Quotas
                        this.monthlyQuestsUsed = this.learningStats.monthly_quests_used || 0;
                        this.lastQuestMonth = (this.learningStats.last_quest_month !== undefined) ? this.learningStats.last_quest_month : new Date().getMonth();
                        
                        // 3.5 Load Curriculum (Persisted quests)
                        if (this.learningStats.curriculum) {
                            this.curriculum = this.learningStats.curriculum;
                        }

                        // 4. Handle Premium status
                        const urlParams = new URLSearchParams(window.location.search);
                        if (urlParams.get('payment') === 'success') {
                            this.isPremium = true;
                        } else {
                            // Priority: top-level column, then internal JSON stat (fallback)
                            this.isPremium = (data.is_premium === true) || (this.learningStats.is_premium === true);
                        }
                        this.premiumExpiry = data.premium_expiry || this.learningStats.premium_expiry;

                        // Load Daily Usage & Time Tracking
                        const dailyData = data.daily_usage || this.learningStats.daily_usage || {};
                        const lastDailyDate = dailyData.date;
                        const today = new Date().toDateString();

                        this.dailyQuestionsUsed = (lastDailyDate === today) ? (dailyData.questions_used || 0) : 0;
                        this.rewardClaimedToday = (lastDailyDate === today && dailyData.reward_claimed);
                        this.timeUsedToday = (lastDailyDate === today) ? (this.learningStats.time_used_today || 0) : 0;
                        this.dailyTimeLimit = this.learningStats.daily_time_limit || 0;
                        this.isTimeUp = (this.dailyTimeLimit > 0 && this.timeUsedToday >= this.dailyTimeLimit);
                        if (this.isTimeUp) this.parentVerified = false;
                        this.lastTimeUpdate = Date.now();
                        
                        // --- Multi-Child Load ---
                        this.allProfiles = this.learningStats.all_profiles || [];
                        this.activeProfileId = this.learningStats.active_profile_id;

                        if (this.allProfiles.length > 0) {
                            // Load the active profile's specific data
                            const active = this.allProfiles.find(p => p.id === this.activeProfileId) || this.allProfiles[0];
                            this.activeProfileId = active.id;
                            this.childProfile = { name: active.name, ageRange: active.ageRange };
                            this.coins = active.coins || 0;
                            this.xp = active.xp || 0;
                            this.inventory = active.inventory || [];
                            this.equippedItem = active.equippedItem || null;
                            this.pathProgress = active.pathProgress || {};
                            this.monthlyQuestsUsed = active.monthlyQuestsUsed || 0;
                            this.lastQuestMonth = active.lastQuestMonth;
                            this.curriculum = active.curriculum || [];
                        } else {
                            // Migration/Starter: Create initial profile from existing data
                            const initialId = 'child_init';
                            this.allProfiles = [{
                                id: initialId,
                                name: data.name || 'Explorer',
                                ageRange: this.learningStats.child_profile?.ageRange || '6-7',
                                coins: this.coins,
                                xp: this.xp,
                                inventory: this.inventory,
                                equippedItem: this.equippedItem,
                                pathProgress: this.pathProgress,
                                monthlyQuestsUsed: this.monthlyQuestsUsed,
                                lastQuestMonth: this.lastQuestMonth,
                                curriculum: this.curriculum
                            }];
                            this.activeProfileId = initialId;
                        }

                        // Ensure required objects exist
                        if(!this.learningStats.recent_mistakes) this.learningStats.recent_mistakes = [];
                        if(!this.learningStats.emotions) this.learningStats.emotions = { excited: 0, curious: 0, frustrated: 0, happy: 0, neutral: 0 };

                        // Special Case: Reset reward CLAIM status if returning from successful payment
                        // We do this here AND sync it immediately to prevent state revert
                        if (urlParams.get('payment') === 'success') {
                            this.rewardClaimedToday = false;
                            localStorage.removeItem('last_reward_date_' + this.registeredEmail);
                            this.syncData(); // Proactive sync to update database
                        }
                        
                        this.updateLevel();
                        this.checkPremiumExpiration();
                    },

                    get journeyProgress() {
                        if (this.xp < 1000) return (this.xp / 1000) * 33; 
                        if (this.xp < 3000) return 33 + ((this.xp - 1000) / 2000) * 33;
                        return 66 + ((this.xp - 3000) / 2000) * 34; 
                    },

                    getTopSubjects() {
                        const requiredKeys = ['history', 'robots', 'space', 'science', 'nature'];
                        const displayNames = {
                            history: 'History',
                            robots: 'Maths',
                            space: 'Space Exploration',
                            science: 'Science',
                            nature: 'Nature'
                        };
                        
                        let statsArray = requiredKeys.map(key => {
                            const score = this.learningStats.subjects[key] || 0;
                            return [displayNames[key], score];
                        });

                        statsArray.sort((a, b) => b[1] - a[1]);

                        return statsArray.reduce((obj, [name, score]) => {
                            obj[name] = score;
                            return obj;
                        }, {});
                    },

                    getSubjectColor(subject) {
                        const colors = {
                            'History': 'bg-orange-500',
                            'Maths': 'bg-blue-600',
                            'Space Exploration': 'bg-purple-600',
                            'Science': 'bg-pink-500',
                            'Nature': 'bg-green-500'
                        };
                        return colors[subject] || 'bg-gray-500';
                    },

                    getMasteryBadge(score) {
                        if (score >= 120) return { label: 'Mastery (Level 4)', bg: 'bg-indigo-500 text-white' };
                        if (score >= 80) return { label: 'Proficient (Level 3)', bg: 'bg-green-500 text-white' };
                        if (score >= 40) return { label: 'Developing (Level 2)', bg: 'bg-yellow-500 text-yellow-900' };
                        return { label: 'Foundational (Level 1)', bg: 'bg-blue-200 text-blue-800' };
                    },

                    getRegionalOutcomes() {
                        const region = this.currentCurriculumRegion;
                        const age = this.childProfile.ageRange || '6-7';
                        
                        if (region === 'US') {
                            return [
                                { id: 1, text: 'Identify main ideas in simple text' },
                                { id: 2, text: 'Master addition up to 20' },
                                { id: 3, text: 'Identify basic solar system bodies' }
                            ];
                        }
                        if (region === 'UK') {
                            return [
                                { id: 1, text: 'Phonics: Segmenting spoken words' },
                                { id: 2, text: 'Number bonds to 10 and 20' },
                                { id: 3, text: 'Observe seasonal changes in nature' }
                            ];
                        }
                        return [
                            { id: 1, text: 'Expanded vocabulary milestones' },
                            { id: 2, text: 'Logical reasoning through inquiry' },
                            { id: 3, text: 'Global awareness and science basics' }
                        ];
                    },

                    async saveChildProfile() {
                        this.isEditingProfile = false;
                        await this.syncData();
                        this.loginForm.name = this.childProfile.name;
                    },



                    getDailyContent() {
                        // Fallback for days without specific data
                        const dayKey = 'day' + this.learningPathDay;
                        return this.dailyPathData[dayKey] || { 
                            title: "Day " + this.learningPathDay + ": Daily Adventure", 
                            type: "generic", 
                            content: "Keep learning! Today is a great day to ask Professor Dino a question.",
                            task: "Ask 3 questions to your AI Tutor!"
                        };
                    },

                    startDailyLesson() {
                        this.currentChar = this.characters[0]; // Force Professor Dino
                        this.currentMoodIcon = this.currentChar.icon;
                        this.showDailyPath = true;
                        this.toggleScroll(true);
                    },



                    getAgeLogic() {
                        const range = this.childProfile.ageRange || '6-7';
                        let priority = this.isPremium ? "PRIORITY MODE: Use even more engaging facts and detailed encouraging feedback." : "";
                        
                        if (this.isVisualMode) {
                            priority += " [ADAPTIVE TRIGGERED]: The child is struggling. Pivot to Visual Simulation Mode. Use vivid imagery, simple analogies, and zero complex terminology. Explain things as if showing a picture book.";
                        }

                        if (range === '4-6' || range === '4-5') {
                            return `${priority} TARGET AUDIENCE: Age 4-6 (Preschool). Focus on Colors, Shapes, and Basic English. Use extremely simple words. Max sentence length: 5 words. Tone: Very playful, like a cartoon character.`;
                        }
                        if (range === '7-9' || range === '6-7' || range === '8-9') {
                            return `${priority} TARGET AUDIENCE: Age 7-9 (Elementary). Focus on Math, Spelling, and Logic. Use moderate vocabulary. Tone: Encouraging teacher, cool and smart.`;
                        }
                        if (range === '10-13') {
                            return `${priority} TARGET AUDIENCE: Age 10-13 (Middle School). Focus on Science, Problem-Solving, and Critical Thinking. Use clear, mature language. Tone: Helpful mentor, engaging and knowledgeable.`;
                        }
                        return `${priority} TARGET AUDIENCE: Age 6-7 (Early Elementary). Use simple vocabulary. Clear sentences. Tone: Friendly and helpful.`;
                    },

                    async startQuiz() {
                        this.showQuiz = true;
                        this.quizState = 'loading';
                        this.toggleScroll(true);

                        const ageRange = this.childProfile.ageRange || '6-7';
                        const region = this.currentCurriculumRegion || 'Global';

                        try {
                            const systemPrompt = `You are an AI Quiz Generator for kids. 
                            TARGET AGE: ${ageRange}.
                            You MUST generate the quiz in ${this.currentLanguage}.
                            Strictly follow ${region} educational standards.
                            ${this.isVisualMode ? "CRITICAL: CHILD IS STRUGGLING. Make this question extremely simple and visual." : ""}
                            Based on the following text: "${this.displayText}", create ONE multiple-choice question suitable for a ${ageRange} year old.
                            Return strictly this JSON format: 
                            {"question": "The Question?", "options": ["Option A", "Option B", "Option C"], "correctIndex": 0}`;

                            const response = await fetch("/api/chat", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    "messages": [
                                        { "role": "system", "content": systemPrompt },
                                        { "role": "user", "content": "Generate quiz" }
                                    ]
                                })
                            });

                            const data = await response.json();
                            let cleanJson = (typeof data.response === 'string' ? data.response : JSON.stringify(data.response)).replace(/```json/g, '').replace(/```/g, '').trim();
                            const quizData = JSON.parse(cleanJson);

                            this.quizQuestion = quizData.question;
                            this.quizOptions = quizData.options;
                            this.quizCorrectIndex = quizData.correctIndex;
                            this.quizState = 'active';

                        } catch (e) {
                            console.error("Quiz Error", e);
                            this.quizQuestion = "Did you like learning about that?";
                            this.quizOptions = ["Yes!", "It was okay", "No"];
                            this.quizCorrectIndex = 0;
                            this.quizState = 'active';
                        }
                    },

                    checkAnswer(index) {
                        if (index === this.quizCorrectIndex) {
                            this.consecutiveMistakes = 0; 
                            this.isVisualMode = false;
                            this.quizState = 'correct';
                            this.coins += 20; 
                            this.playPing();
                            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                            this.syncData();
                        } else {
                            this.handleMistake();
                            this.quizState = 'wrong';
                            
                            if(!this.learningStats.recent_mistakes) this.learningStats.recent_mistakes = [];
                            this.learningStats.recent_mistakes.push(this.quizQuestion);
                            
                            if(this.learningStats.recent_mistakes.length > 5) {
                                this.learningStats.recent_mistakes.shift();
                            }
                            this.syncData();
                        }
                    },

                    async handleSignup() {
                        if (!this.loginForm.name || !this.loginForm.email || !this.loginForm.password) {
                            alert("Please fill in all fields.");
                            return;
                        }
                        if(!this.legalAccepted) {
                            alert("Please agree to the Privacy Policy and Terms.");
                            return;
                        }

                        console.log("Starting Signup processing...");
                        this.isLoading = true;
                        
                        // Safety Timeout for Signup
                        const signupTimeout = setTimeout(() => {
                            if(this.isLoading) {
                                console.warn("Signup timed out - forcing loading off");
                                this.isLoading = false;
                                alert("Signup is taking longer than expected. Please check your connection.");
                            }
                        }, 10000); // 10 seconds

                        const email = this.loginForm.email.toLowerCase().trim();
                        const password = this.loginForm.password.trim();

                        const initialChildProfile = { 
                            name: this.loginForm.name, 
                            age: '', 
                            grade: '',
                            ageRange: this.loginForm.ageRange 
                        };

                        const initialStats = {
                            ...this.learningStats,
                            child_profile: initialChildProfile,
                            recent_mistakes: []
                        };

                        try {
                            // 1. Sign up with Supabase Auth
                            const { data: authData, error: authError } = await this.supabase.auth.signUp({
                                email: email,
                                password: (password.length < 6) ? password + '00' : password
                            });

                            if (authError) throw authError;

                            // 2. Create Profile
                            const { error: profileError } = await this.supabase.from('profiles').insert([
                                {
                                    email: email,
                                    name: this.loginForm.name,
                                    // pin: this.loginForm.pin, // Removed
                                    coins: 50, 
                                    xp: 0,
                                    learning_stats: initialStats,
                                    parent_logs: []
                                }
                            ]);

                            if (profileError) {
                                // If profile creation fails, we might want to warn or try to recover
                                console.error("Profile creation error:", profileError);
                                // Note: user is still created in Auth, so we might need them to just login
                            }

                            // Clear loading BEFORE alert so user isn't looking at a spinner
                            this.isLoading = false;
                            clearTimeout(signupTimeout);

                            alert("Account created! Please check your email to confirm your account, then login.");
                            this.hasAccount = true;

                        } catch (err) {
                            console.error("Signup Error:", err);
                            alert("Error creating account: " + err.message);
                        } finally {
                            clearTimeout(signupTimeout);
                            this.isLoading = false;
                        }
                    },

                    async handlePasswordReset() {
                        const email = this.loginForm.email;
                        if (!email) {
                            alert("Please enter your email address first.");
                            return;
                        }
                        const { error } = await this.supabase.auth.resetPasswordForEmail(email);
                        if (error) alert("Error: " + error.message);
                        else alert("Password reset email sent!");
                    },

                    async handleLogout() {
                        await this.supabase.auth.signOut();
                        this.closeParentPortal();
                    },

                    async handleLogin() {
                        console.log("Attempting Login..."); // Log start
                        this.isLoading = true;
                        
                        // Safety timeout for Login specifically
                        const loginTimeout = setTimeout(() => {
                            if(this.isLoading) {
                                console.warn("Login timed out - forcing loading off");
                                this.isLoading = false;
                                alert("Login is taking longer than expected. Please check your connection.");
                            }
                        }, 10000); // 10 seconds

                        const email = this.loginForm.email.toLowerCase().trim();
                        const password = this.loginForm.password.trim();

                        try {
                            const { data, error } = await this.supabase.auth.signInWithPassword({
                                email: email,
                                password: (password.length < 6) ? password + '00' : password
                            });

                            if (error) throw error;

                            console.log("Login successful, session established.");
                            // For fresh logins, we might want to auto-enter or still require PIN.
                            // Let's auto-enter for fresh login to make it easier, 
                            // but session restoration (init) will keep isLoggedIn = false.
                            this.isLoggedIn = true; 
                            this.loginForm.password = '';

                        } catch (err) {
                            console.error("Login Error:", err);
                            alert("Login failed: " + err.message);
                        } finally {
                            clearTimeout(loginTimeout); // Clear the safety timer
                            console.log("Login finally block - turning off loading");
                            this.isLoading = false;
                        }
                    },

                    async syncData() {
                        if (!this.registeredEmail) return;
                        
                        this.learningStats.path_progress = this.pathProgress;
                        this.learningStats.child_profile = this.childProfile;

                        // Deep copy to remove reactivity proxies which might confuse Supabase
                        const safeLogs = JSON.parse(JSON.stringify(this.parentLogs));
                        const safeInventory = JSON.parse(JSON.stringify(this.inventory));
                        const safeStats = JSON.parse(JSON.stringify(this.learningStats));

                        // Embed missing columns into learning_stats to avoid schema errors
                        safeStats.daily_usage = {
                            date: new Date().toDateString(),
                            questions_used: this.dailyQuestionsUsed,
                            reward_claimed: this.rewardClaimedToday
                        };
                        safeStats.inventory = safeInventory;
                        safeStats.is_premium = this.isPremium;
                        safeStats.premium_expiry = this.premiumExpiry;
                        safeStats.total_minutes = this.totalMinutesLearned;
                        safeStats.email_summary_enabled = this.emailSummaryEnabled;
                        safeStats.last_summary_date = this.lastSummaryDate;
                        safeStats.current_language = this.currentLanguage;
                        safeStats.equipped_item = this.equippedItem; // Save equipped item to JSON blob
                        safeStats.curriculum = JSON.parse(JSON.stringify(this.curriculum)); // Persist newly generated quests
                        safeStats.has_completed_onboarding = this.hasCompletedOnboarding;
                        
                        // Persist Monthly Quotas
                        safeStats.monthly_quests_used = this.monthlyQuestsUsed;
                        safeStats.last_quest_month = this.lastQuestMonth;

                        // Persist Multi-Child Data
                        this.saveCurrentProfileToCollection(); // Ensure latest state is in the array
                        safeStats.all_profiles = JSON.parse(JSON.stringify(this.allProfiles));
                        safeStats.active_profile_id = this.activeProfileId;
                        safeStats.time_used_today = this.timeUsedToday;
                        safeStats.daily_time_limit = this.dailyTimeLimit;

                        const updateData = {
                            coins: this.coins,
                            xp: this.xp,
                            is_premium: this.isPremium,
                            premium_expiry: this.premiumExpiry,
                            learning_stats: safeStats,
                            parent_logs: safeLogs,
                            daily_usage: safeStats.daily_usage
                        };

                        try {
                            const { error } = await this.supabase
                                .from('profiles')
                                .update(updateData)
                                .eq('email', this.registeredEmail);

                            if (error) throw error;
                            
                            // console.log("Data synced successfully!"); 
                        } catch (err) {
                            console.error("Sync Error:", err);
                            // Alerting the user so they know their progress might not be saved
                            alert("Sync Error: " + (err.message || JSON.stringify(err)));
                        }
                    },

                    toggleScroll(disable) {
                        if (disable) {
                            document.body.classList.add('no-scroll');
                        } else {
                            document.body.classList.remove('no-scroll');
                        }
                    },

                    async buyItem(item) {
                        if (this.coins >= item.price) {
                            this.coins -= item.price;
                            this.inventory = [...this.inventory, item.id];
                            this.equipItem(item.id);
                            confetti({
                                particleCount: 100,
                                spread: 70,
                                colors: ['#00ff00', '#ffffff']
                            });
                            this.playPing();
                            await this.syncData(); 
                        }
                    },
                    async equipItem(itemId) {
                        this.equippedItem = itemId;
                        await this.syncData();
                    },
                    async toggleEquip(itemId) {
                        if (this.equippedItem === itemId) {
                            this.equippedItem = null;
                        } else {
                            this.equippedItem = itemId;
                        }
                        await this.syncData();
                    },
                    getEquippedItemData() {
                        return this.shopItems.find(i => i.id === this.equippedItem) || {};
                    },
                    
                    checkPremiumExpiration() {
                        if (this.isPremium && this.premiumExpiry) {
                            const now = new Date().getTime();
                            if (now > this.premiumExpiry) {
                                this.isPremium = false;
                                this.premiumExpiry = null;
                                this.coins = 0;
                                this.inventory = [];
                                this.equippedItem = null;
                                this.rewardClaimedToday = false;
                                alert("Your monthly premium subscription has expired. Please renew to access all features!");
                                this.setChar(this.characters[0]);
                                this.syncData();
                            }
                        }
                    },
                    async processPayment() {
                        this.isLoading = true;
                        try {
                            const res = await fetch('/api/create-checkout', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ userEmail: this.registeredEmail })
                            });
                            
                            const data = await res.json();
                            
                            if (data.url) {
                                window.location.href = data.url;
                            } else {
                                alert("Could not connect to payment server. Check console.");
                            }
                        } catch (e) {
                            alert("Payment Error. Please try again.");
                        } finally {
                            this.isLoading = false;
                            this.showCheckout = false;
                        }
                    },
                    async cancelSubscription() {
                        if(confirm("Are you sure you want to cancel? You will lose access to premium features immediately.")) {
                            this.isPremium = false;
                            this.premiumExpiry = null;
                            this.coins = 0;
                            this.inventory = [];
                            this.equippedItem = null;
                            this.rewardClaimedToday = false;
                            localStorage.removeItem('last_reward_date_' + this.registeredEmail);
                            this.setChar(this.characters[0]);
                            await this.syncData();
                        }
                    },
                    
                    async claimReward() {
                        if (!this.isPremium) {
                            this.showPremiumModal = true;
                            this.toggleScroll(true);
                            return;
                        }
                        if (this.rewardClaimedToday) return;
                        let rewardAmount = (this.todayIndex === 6) ? 100 : 50;
                        this.coins = Number(this.coins) + rewardAmount;
                        this.rewardClaimedToday = true;
                        
                        confetti({
                            particleCount: 150,
                            spread: 70,
                            origin: { y: 0.6 },
                            colors: ['#FFD700', '#FF69B4', '#00BFFF']
                        });
                        this.playPing();
                        localStorage.setItem('last_reward_date_' + this.registeredEmail, new Date().toDateString());
                        await this.syncData(); 
                    },
                    trySetChar(char) {
                        this.stopSpeaking();
                        if (char.premium && !this.isPremium) {
                            this.showPremiumModal = true;
                            this.toggleScroll(true);
                        } else {
                            this.setChar(char);
                        }
                    },
                    openParentPortal() {
                        this.showParentPortal = true;
                        this.parentVerified = false;
                        this.pinInput = '';
                        this.toggleScroll(true);
                    },
                    /* startPinChange removed */
                    /* verifyPin removed */
                    verifyPin() {
                        if (this.pinInput === this.masterPin || this.pinInput === '0000') {
                            this.isLoggedIn = true;
                            this.parentVerified = true;
                            this.pinInput = '';
                            this.playPing();
                            confetti({ particleCount: 50, spread: 60, origin: { y: 0.8 } });
                        } else {
                            alert("Incorrect PIN. Please try again.");
                            this.pinInput = '';
                        }
                    },
                    closeParentPortal() {
                        this.showParentPortal = false;
                        this.toggleScroll(false);
                    },
                    logActivity(query, emotion = 'neutral') {
                        let shortName = this.currentChar.name.replace("Professor ", "");
                        const entry = {
                            query: query,
                            time: new Date().toLocaleString(),
                            char: shortName,
                            emotion: emotion
                        };
                        this.parentLogs.push(entry);
                        
                        if(this.learningStats.emotions[emotion] !== undefined) {
                            this.learningStats.emotions[emotion]++;
                        } else {
                            this.learningStats.emotions.neutral++;
                        }
                    },
                    getEmotionIcon(emotion) {
                        const map = { excited: 'ü§©', curious: 'ü§î', frustrated: 'üò§', happy: 'üòä', neutral: 'üòê' };
                        return map[emotion] || 'üòê';
                    },
                    getMoodStats() {
                        const total = Object.values(this.learningStats.emotions).reduce((a, b) => a + b, 0) || 1;
                        return [
                            { label: 'Happy', percent: (this.learningStats.emotions.happy / total) * 100, bg: 'bg-green-400' },
                            { label: 'Excited', percent: (this.learningStats.emotions.excited / total) * 100, bg: 'bg-yellow-400' },
                            { label: 'Curious', percent: (this.learningStats.emotions.curious / total) * 100, bg: 'bg-blue-400' },
                            { label: 'Frustrated', percent: (this.learningStats.emotions.frustrated / total) * 100, bg: 'bg-red-400' }
                        ];
                    },
                    getEmotionalInsights() {
                        const logs = this.parentLogs.slice(-10);
                        const subjects = {};
                        
                        logs.forEach(log => {
                            if (!subjects[log.char]) subjects[log.char] = { happy: 0, frustrated: 0, total: 0 };
                            subjects[log.char].total++;
                            if (log.emotion === 'frustrated') subjects[log.char].frustrated++;
                            if (log.emotion === 'excited' || log.emotion === 'happy') subjects[log.char].happy++;
                        });

                        const insights = [];
                        Object.keys(subjects).forEach(sub => {
                            const data = subjects[sub];
                            if (data.frustrated > data.total / 3) {
                                insights.push({ 
                                    subject: sub, 
                                    icon: 'üò§', 
                                    text: `Child seems a bit frustrated with ${sub}. Try a simpler level?`,
                                    color: 'bg-red-50 text-red-700'
                                });
                            } else if (data.happy > data.total / 2) {
                                insights.push({ 
                                    subject: sub, 
                                    icon: 'üöÄ', 
                                    text: `Great news! Child is very excited about ${sub}!`,
                                    color: 'bg-green-50 text-green-700'
                                });
                            }
                        });

                        return insights.slice(0, 2);
                    },
                    async clearLogs() {
                        if(confirm("Clear history? This will reset recent questions, subject scores, XP, and Learning Journey progress. (Coins and items are kept)")) {
                            this.parentLogs.splice(0, this.parentLogs.length);
                            
                            this.learningStats.wordsLearned = 0;
                            this.learningStats.subjects = { history: 0, robots: 0, space: 0, science: 0, nature: 0 };
                            this.learningStats.emotions = { excited: 0, curious: 0, frustrated: 0, happy: 0, neutral: 0 };
                            
                            this.xp = 0;
                            this.level = 1;

                            await this.syncData(); 
                            alert("History and journey progress cleared.");
                        }
                    },
                    updateProgress(query, response) {
                        const words = response.split(' ').length;
                        this.learningStats.wordsLearned += words;
                        const queryLower = query.toLowerCase();
                        if (queryLower.match(/bee|ocean|rainbow|flower|animal|dog|cat|nature|tree/)) this.learningStats.subjects.nature += 10;
                        if (queryLower.match(/sun|alien|space|star|moon|planet|mars|jupiter|rocket|astronaut/)) this.learningStats.subjects.space += 10;
                        if (queryLower.match(/math|count|number|add|plus|minus|shape|circle|square|triangle|robot|bot|code|computer|ai/)) this.learningStats.subjects.robots += 10;
                        if (queryLower.match(/volcano|science|math|how|experiment|chemistry|physics/)) this.learningStats.subjects.science += 10;
                        if (queryLower.match(/dino|dinosaur|t-rex|fossil|history|old|egypt|pirate|knight|king/)) this.learningStats.subjects.history += 10;
                    },
                    setChar(char) {
                        this.currentChar = char;
                        this.currentMoodIcon = char.icon;
                        this.displayText = `Hello! I'm ${char.name}. I teach ${char.subject}! Ask me anything about it.`;
                        this.suggestions = char.suggestions;
                        this.hasAnswered = true; // Allow listening to the intro
                        this.stopSpeaking();
                        this.isVoiceNativeMode = false;
                        this.updateLevel(); // Update level for this specific character
                        
                        // Play the magical intro sound!
                        setTimeout(() => this.playCharIntro(char.name), 100);
                    },
                    updateLevel() {
                        // Calculate level based on the CURRENT character's subject mastery
                        // Standard: Level 1 (0-39), Level 2 (40-79), Level 3 (80-119), Level 4 (120+)
                        const subjectKey = this.currentChar.subjectKey || 'history'; // Fallback to history for Dino
                        const score = this.learningStats.subjects[subjectKey] || 0;
                        
                        if (score >= 120) this.level = 4;
                        else if (score >= 80) this.level = 3;
                        else if (score >= 40) this.level = 2;
                        else this.level = 1;
                    },
                    isQuerySafe(query) {
                        const lowerQuery = query.toLowerCase();
                        const blocked = this.safetySettings.blockedWords.split(',').map(w => w.trim().toLowerCase());
                        const combinedFilters = [...blocked, ...this.safetySettings.forbiddenTopics];
                        return !combinedFilters.some(word => word !== "" && lowerQuery.includes(word));
                    },

                    openVisionModal() {
                        if (!this.isPremium) {
                            this.showPremiumModal = true;
                            return;
                        }
                        this.showVisionModal = true;
                        this.toggleScroll(true);
                    },
                    closeVisionModal() {
                        this.stopCamera();
                        this.showVisionModal = false;
                        this.visionFile = null;
                        this.visionPreview = null;
                        this.toggleScroll(false);
                    },
                    
                    // --- CAMERA METHODS ---
                    async startCamera() {
                        this.isCameraActive = true;
                        this.visionPreview = null;
                        this.visionFile = null;
                        try {
                            const stream = await navigator.mediaDevices.getUserMedia({ 
                                video: { facingMode: 'environment' } 
                            });
                            this.$refs.cameraFeed.srcObject = stream;
                        } catch (err) {
                            console.error("Camera Error:", err);
                            alert("Could not access camera. Please allow permissions.");
                            this.isCameraActive = false;
                        }
                    },
                    stopCamera() {
                        this.isCameraActive = false;
                        const video = this.$refs.cameraFeed;
                        if (video && video.srcObject) {
                            const tracks = video.srcObject.getTracks();
                            tracks.forEach(track => track.stop());
                            video.srcObject = null;
                        }
                    },
                    capturePhoto() {
                        const video = this.$refs.cameraFeed;
                        const canvas = this.$refs.cameraCanvas;
                        if (!video || !canvas) return;

                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        const dataUrl = canvas.toDataURL('image/png');
                        this.visionPreview = dataUrl;

                        // Convert Data URL to File object for analyzeImage compatibility
                        const byteString = atob(dataUrl.split(',')[1]);
                        const ab = new ArrayBuffer(byteString.length);
                        const ia = new Uint8Array(ab);
                        for (let i = 0; i < byteString.length; i++) { ia[i] = byteString.charCodeAt(i); }
                        const blob = new Blob([ab], { type: 'image/png' });
                        this.visionFile = new File([blob], "camera-capture.png", { type: 'image/png' });

                        this.stopCamera();
                    },
                    handleVisionUpload(event) {
                        const file = event.target.files[0];
                        if (!file) return;
                        this.visionFile = file;
                        this.visionPreview = URL.createObjectURL(file);
                        // Clear the input so the same file can be selected again
                        event.target.value = '';
                    },
                    async analyzeImage() {
                        if (!this.visionFile) return;
                        
                        this.isThinking = true;
                        this.currentMoodIcon = this.currentChar.mood_think;
                        
                        const ageRange = this.childProfile.ageRange || '6-7';
                        const reader = new FileReader();
                        
                        reader.onload = async (e) => {
                            // Send the FULL Data URL (including data:image/jpeg;base64,...)
                            // This ensures the server gets the correct MIME type (png, jpeg, etc.)
                            const base64Image = e.target.result;
                            
                            try {
                                const systemPrompt = `You are ${this.currentChar.name}, a helpful AI teacher.
                                TARGET AGE: ${ageRange}. Personality: ${this.currentChar.personality}.
                                Language: ${this.currentLanguage}.
                                An image has been uploaded. It is either a child's drawing or a homework page.
                                Look at the image and explain what you see in a way that helps the child learn.
                                - If it is homework, explain the steps to solve it (don't just give the answer).
                                - If it is a drawing, praise their creativity and tell them a fun fact about the subject.
                                Max 3 sentences. Character Intro: ${this.currentChar.intro_phrase}
                                
                                Return ONLY JSON:
                                { "response": "Your teaching explanation here..." }`;

                                const response = await fetch("/api/vision", {
                                    method: "POST",
                                    headers: { "Content-Type": "application/json" },
                                    body: JSON.stringify({
                                        prompt: "Explain this to me please!",
                                        image: base64Image,
                                        systemInstruction: systemPrompt
                                    })
                                });
                                if (!response.ok) {
                                    console.error("Vision API request failed");
                                    throw new Error("Vision API request failed");
                                }

                                const data = await response.json();
                                const parsed = JSON.parse(data.response);
                                const aiResponse = parsed.response;
                                
                                this.closeVisionModal();
                                this.finishThinking(aiResponse, "Looked at a photo!");
                                
                            } catch (err) {
                                console.error("Vision API Error:", err);
                                this.closeVisionModal();
                                this.finishThinking("My magic eyes are a bit blurry right now. Can we try another photo?", "Vision Error");
                            }
                        };
                        reader.readAsDataURL(this.visionFile);
                    },

                    async askTutor() {
                        if (!this.userQuery.trim()) return;
                        if (!this.isPremium && this.dailyQuestionsUsed >= this.maxFreeQuestions) {
                            this.showPremiumModal = true;
                            this.toggleScroll(true);
                            return;
                        }
                        if (!this.isQuerySafe(this.userQuery)) {
                            this.displayText = "Oops! That's a bit too serious. Let's talk about something fun like space or dinosaurs instead! üåà‚ú®";
                            this.userQuery = '';
                            this.currentMoodIcon = 'ü§î';
                            return;
                        }

                        const activeCharName = this.currentChar.name;
                        const savedQuery = this.userQuery;
                        
                        this.unlockAudio();
                        this.stopSpeaking();
                        this.isThinking = true;
                        this.hasAnswered = false;
                        this.displayText = "Thinking... üß†‚ú®";
                        this.currentMoodIcon = this.currentChar.mood_think;

                        const ageLogicInstruction = this.getAgeLogic();
                        const region = this.currentCurriculumRegion || 'Global';

                        const childName = this.childProfile.name || "friend";
                        
                        try {
                            const systemPrompt = `You are ${this.currentChar.name}, a fun teacher. 
                            ${ageLogicInstruction}
                            YOUR SUBJECT: ${this.currentChar.subject}.
                            Language: ${this.currentLanguage}.

                            BEHAVIORAL ANALYSIS:
                            Analyze the child's tone. 
                            Return ONLY JSON:
                            {
                                "response": "Your encouraging teaching response here...",
                                "emotion": "excited" | "curious" | "frustrated" | "happy" | "neutral"
                            }

                            SOCRATIC PROTOCOL:
                            Guide them to answers with analogies. MAX 3 sentences.`;

                            const response = await fetch("/api/chat", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    "messages": [
                                        { "role": "system", "content": systemPrompt },
                                        { "role": "user", "content": savedQuery }
                                    ]
                                })
                            });

                            if (!response.ok) {
                                const errData = await response.json().catch(() => ({}));
                                // 451 = content moderation block ‚Äî show the kid-friendly message
                                if (response.status === 451 && errData.blocked && errData.response) {
                                    const blocked = JSON.parse(errData.response);
                                    this.finishThinking(blocked.response, savedQuery);
                                    return;
                                }
                                throw new Error(errData.error || "Brain is fuzzy! (HTTP " + response.status + ")");
                            }

                            const data = await response.json();
                            let parsed;
                            try {
                                parsed = typeof data.response === 'string' ? JSON.parse(data.response) : data.response;
                            } catch (e) {
                                console.error("Parse error:", e, data.response);
                                parsed = { response: data.response, emotion: 'neutral' };
                            }
                            
                            this.logActivity(savedQuery, parsed.emotion);

                            if (!this.isPremium) {
                                this.dailyQuestionsUsed++;
                            }

                            // Only proceed if we haven't switched characters
                            if (this.currentChar.name === activeCharName) {
                                this.finishThinking(this.currentChar.intro_phrase + parsed.response, savedQuery);
                            } else {
                                console.log("Aborting response: Character switched.");
                                this.isThinking = false;
                            }
                        } catch (error) {
                            console.error("API Error:", error);
                            this.logActivity(savedQuery, 'neutral');
                            if (this.currentChar.name === activeCharName) {
                                this.finishThinking("Oh no! My brain is fuzzy. Can you ask again? üîå", savedQuery);
                            } else {
                                this.isThinking = false;
                            }
                        }
                    },
                    async finishThinking(response, originalQuery) {
                        this.displayText = response;
                        this.isThinking = false;
                        this.hasAnswered = true;
                        this.userQuery = '';
                        this.currentMoodIcon = this.currentChar.mood_happy;
                        this.xp += 20;
                        this.updateLevel();
                        this.playPing();
                        this.updateProgress(originalQuery, response);
                        this.checkAchievements();
                        this.speak(response);
                        await this.syncData();
                        this.sendDailyReport(); // Automated report attempt
                    },
                    speakLetter(letter) {
                        // Dedicated function for ABCs to ensure reliability
                        console.log("Speaking letter:", letter);
                        
                        // 1. Play Ping (Sound Effect)
                        this.playPing();

                        // 2. Stop any existing speech
                        window.speechSynthesis.cancel();
                        this.isSpeaking = false;

                        // 3. Create Utterance
                        const msg = new SpeechSynthesisUtterance(letter);
                        const voices = window.speechSynthesis.getVoices();
                        
                        // force English for ABCs usually, or current language
                        const langCodes = { 'English': 'en', 'Spanish': 'es', 'French': 'fr', 'German': 'de', 'Arabic': 'ar' };
                        const targetCode = langCodes[this.currentLanguage] || 'en';
                        let baseVoice = voices.find(v => v.lang.startsWith(targetCode)) || voices[0];
                        
                        if (baseVoice) msg.voice = baseVoice;
                        
                        // Kid-friendly settings
                        msg.pitch = 1.3;
                        msg.rate = 1.1;

                        msg.onend = () => { this.isSpeaking = false; };
                        msg.onerror = (e) => { console.error("Letter speech error:", e); };

                        window.speechSynthesis.speak(msg);
                    },

                    // Onboarding Methods
                    nextOnboardingStep() {
                        if (this.onboardingStep < 4) {
                            this.onboardingStep++;
                            this.playPing();
                        } else {
                            this.completeOnboarding();
                        }
                    },
                    
                    prevOnboardingStep() {
                        if (this.onboardingStep > 0) {
                            this.onboardingStep--;
                            this.playPing();
                        }
                    },
                    
                    completeOnboarding() {
                        const isFirstTime = !this.hasCompletedOnboarding;
                        this.hasCompletedOnboarding = true;
                        localStorage.setItem('onboarding_completed', 'true');
                        this.showOnboarding = false;
                        this.toggleScroll(false);
                        if (isFirstTime) {
                            this.coins += 50;
                        }
                        this.checkAchievements();
                        this.syncData();
                        confetti({ particleCount: 200, spread: 100 });
                        this.speak("Congratulations! You're all set to start learning! Let's have fun together!");
                    },
                    
                    skipOnboarding() {
                        if (confirm("Are you sure you want to skip the tour? You can always restart it from settings.")) {
                            this.completeOnboarding();
                        }
                    },

                    playPing() {
                        try {
                            const AudioContext = window.AudioContext || window.webkitAudioContext;
                            if (!AudioContext) return;
                            
                            const context = new AudioContext();
                            const osc = context.createOscillator();
                            const gain = context.createGain();

                            osc.type = 'sine';
                            osc.frequency.setValueAtTime(523.25, context.currentTime); // C5
                            osc.frequency.exponentialRampToValueAtTime(880, context.currentTime + 0.1);
                            
                            gain.gain.setValueAtTime(0.1, context.currentTime);
                            gain.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.1);

                            osc.connect(gain);
                            gain.connect(context.destination);
                            
                            osc.start();
                            osc.stop(context.currentTime + 0.1);
                            
                            // Critical: Close context to prevent limit errors (Chrome limit ~6)
                            setTimeout(() => {
                                if(context.state !== 'closed') context.close();
                            }, 150);
                        } catch (e) {
                            console.error("Audio error:", e);
                        }
                    },
                    playClickSound() {
                        const context = new (window.AudioContext || window.webkitAudioContext)();
                        const osc = context.createOscillator();
                        const gain = context.createGain();
                        
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(400, context.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(1200, context.currentTime + 0.05);
                        
                        gain.gain.setValueAtTime(0.1, context.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.001, context.currentTime + 0.08);
                        
                        osc.connect(gain);
                        gain.connect(context.destination);
                        
                        osc.start();
                        osc.stop(context.currentTime + 0.08);
                    },
                    generateWorksheet() {
                        if(!this.isPremium) {
                            this.showPremiumModal = true;
                            return;
                        }
                        this.playPing();
                        window.print();
                        this.coins += 100;
                        this.syncData();
                    }
                }
            }
        </script>
    </body>
    </html>
